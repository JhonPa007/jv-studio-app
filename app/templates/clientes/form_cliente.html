{% extends "base.html" %}

{% block title %}Registrar Nuevo Cliente - JV Studio{% endblock %}

{% block head_extra %}
<style>
    /* Puedes añadir estilos específicos para esta página aquí si es necesario */
    .form-section {
        background-color: #3a3a3a;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .form-section h2 {
        color: var(--color-acento-dorado);
        margin-bottom: 20px;
        border-bottom: 1px solid var(--color-secundario-gris);
        padding-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="form-section-venta" style="max-width: 800px; margin: auto;">
        <h2><i class="fas {{ 'fa-user-plus' if es_nueva else 'fa-user-edit' }} me-2"></i>{{ titulo_form }}</h2>
        {% include 'partials/_flash_messages.html' %}
        {% set data_source = form_data if form_data else (cliente if cliente else {}) %}

        <form method="POST" action="{{ action_url }}">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="tipo_documento" class="form-label">Tipo de Documento</label>
                    <select class="form-select" id="tipo_documento" name="tipo_documento">
                        <option value="DNI" {% if data_source.get('tipo_documento') == 'DNI' or not data_source.get('tipo_documento') %}selected{% endif %}>DNI</option>
                        <option value="RUC" {% if data_source.get('tipo_documento') == 'RUC' %}selected{% endif %}>RUC</option>
                        <option value="Otro" {% if data_source.get('tipo_documento') == 'Otro' %}selected{% endif %}>Otro (Sin Documento)</option>
                    </select>
                </div>
                <div class="col-md-8 mb-3">
                    <label for="numero_documento" class="form-label">Número de Documento</label>
                    <input type="text" class="form-control" id="numero_documento" name="numero_documento" value="{{ data_source.get('numero_documento', '') }}">
                </div>
            </div>

            <div class="mb-3">
                <label for="razon_social_nombres" id="label_razon_social_nombres" class="form-label">Nombres <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="razon_social_nombres" name="razon_social_nombres" value="{{ data_source.get('razon_social_nombres', '') }}" required>
            </div>

            <div class="mb-3" id="campo_apellidos">
                <label for="apellidos" class="form-label">Apellidos <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="apellidos" name="apellidos" value="{{ data_source.get('apellidos', '') }}">
            </div>
            
            <div class="mb-3">
                <label for="direccion" class="form-label">Dirección (Opcional)</label>
                <input type="text" class="form-control" id="direccion" name="direccion" value="{{ data_source.get('direccion', '') }}">
            </div>

            <div class="row" id="campos_persona_natural">
                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">Correo Electrónico (Opcional)</label>
                    <input type="email" class="form-control" id="email" name="email" value="{{ data_source.get('email', '') }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="telefono" class="form-label">Teléfono / WhatsApp (Opcional)</label>
                    <input type="tel" class="form-control" id="telefono" name="telefono" value="{{ data_source.get('telefono', '') }}">
                </div>
            
                <div class="col-md-6 mb-3">
                    <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento (Opcional)</label>
                    {% set fn_value = data_source.get('fecha_nacimiento', '') %}
                    {% if fn_value and fn_value is not string and fn_value.strftime is defined %}{% set fn_value_str = fn_value.strftime('%Y-%m-%d') %}{% else %}{% set fn_value_str = fn_value %}{% endif %}
                    <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" value="{{ fn_value_str }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="puntos_fidelidad" class="form-label">JV Puntos (Saldo Actual)</label>
                    <input type="number" class="form-control" id="puntos_fidelidad" name="puntos_fidelidad" value="{{ data_source.get('puntos_fidelidad', 0) }}" min="0">
                </div>
            </div>
            
            <div class="d-flex justify-content-end mt-4">
                <a href="{{ url_for('main.listar_clientes') }}" class="btn btn-secondary me-2"><i class="fas fa-times me-1"></i>Cancelar</a>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>{{ 'Guardar Cliente' if es_nueva else 'Actualizar Cliente' }}</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoDocumentoSelect = document.getElementById('tipo_documento');
    const campoApellidos = document.getElementById('campo_apellidos');
    const inputApellidos = document.getElementById('apellidos');
    const labelNombres = document.getElementById('label_razon_social_nombres');
    const camposPersonaNatural = document.getElementById('campos_persona_natural');

    function toggleCamposCliente() {
        if (tipoDocumentoSelect.value === 'RUC') {
            // Ocultar campos no relevantes para empresas
            campoApellidos.style.display = 'none';
            inputApellidos.required = false;
            camposPersonaNatural.style.display = 'none'; // Ocultar todo el bloque
            
            // Cambiar etiqueta a Razón Social
            labelNombres.textContent = 'Razón Social *';
        } else {
            // Mostrar campos para personas
            campoApellidos.style.display = 'block';
            inputApellidos.required = true;
            camposPersonaNatural.style.display = 'flex'; // Usar 'flex' porque es una fila (row)
            
            // Restaurar etiqueta a Nombres
            labelNombres.textContent = 'Nombres *';
        }
    }

    // Ejecutar al cargar la página para establecer el estado inicial correcto
    toggleCamposCliente();

    // Añadir listener para cuando cambie la selección
    tipoDocumentoSelect.addEventListener('change', toggleCamposCliente);
});
</script>
{% endblock %}