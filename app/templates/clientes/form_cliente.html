{% extends "base.html" %}

{% block title %}
{{ "Editar Cliente" if cliente else "Agregar Nuevo Cliente" }}
{% endblock %}

{% block content %}
{% set data = cliente if cliente else {} %}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card bg-dark text-light shadow-lg">
                <div class="card-header border-secondary">
                    <h4 class="mb-0 text-warning">
                        <i class="fas fa-user-plus me-2"></i>
                        {{ "Editar Datos del Cliente" if cliente else "Registrar Nuevo Cliente" }}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="">
                        {{ form.hidden_tag() if form }}

                        <div class="row">
                            <div class="col-md-6">
                                <fieldset class="border border-secondary p-3 rounded mb-4 h-100">
                                    <legend class="fs-6 fw-bold text-info px-2 w-auto">Identificación</legend>

                                    <div class="mb-3">
                                        <label for="tipo_documento" class="form-label text-light small">Tipo de
                                            Documento</label>
                                        <select class="form-select bg-dark text-light border-secondary"
                                            id="tipo_documento" name="tipo_documento" required
                                            onchange="toggleCampos()">
                                            <option value="DNI" {% if data.tipo_documento=='DNI' %}selected{% endif %}>
                                                DNI</option>
                                            <option value="RUC" {% if data.tipo_documento=='RUC' %}selected{% endif %}>
                                                RUC</option>
                                            <option value="CE" {% if data.tipo_documento=='CE' %}selected{% endif %}>
                                                Carnet Ext.</option>
                                            <option value="Pasaporte" {% if data.tipo_documento=='Pasaporte'
                                                %}selected{% endif %}>Pasaporte</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="numero_documento" class="form-label text-light small">Número de
                                            Documento</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control bg-dark text-light border-secondary"
                                                id="numero_documento" name="numero_documento"
                                                value="{{ data.numero_documento or '' }}" placeholder="Ingrese número">
                                            <button class="btn btn-warning fw-bold" type="button"
                                                id="btn-buscar-documento">
                                                <i class="fas fa-search"></i> Buscar
                                            </button>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="razon_social_nombres" class="form-label text-light small"
                                            id="lbl-nombres">Nombres</label>
                                        <input type="text" class="form-control bg-dark text-light border-secondary"
                                            id="razon_social_nombres" name="razon_social_nombres"
                                            value="{{ data.razon_social_nombres or '' }}" required>
                                    </div>

                                    <div id="bloque-apellidos">
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <label for="apellido_paterno"
                                                    class="form-label text-light small">Apellido Paterno</label>
                                                <input type="text"
                                                    class="form-control bg-dark text-light border-secondary"
                                                    id="apellido_paterno" name="apellido_paterno"
                                                    value="{{ data.apellido_paterno or '' }}">
                                            </div>
                                            <div class="col-6">
                                                <label for="apellido_materno"
                                                    class="form-label text-light small">Apellido Materno</label>
                                                <input type="text"
                                                    class="form-control bg-dark text-light border-secondary"
                                                    id="apellido_materno" name="apellido_materno"
                                                    value="{{ data.apellido_materno or '' }}">
                                            </div>
                                        </div>
                                    </div>



                                    <div class="mb-3">
                                        <label for="fecha_nacimiento" class="form-label text-light small">Fecha de
                                            Nacimiento</label>
                                        <input type="date" class="form-control bg-dark text-light border-secondary"
                                            id="fecha_nacimiento" name="fecha_nacimiento"
                                            value="{{ data.fecha_nacimiento or '' }}">
                                    </div>

                                </fieldset>
                            </div>

                            <div class="col-md-6">
                                <fieldset class="border border-secondary p-3 rounded mb-4 h-100">
                                    <legend class="fs-6 fw-bold text-info px-2 w-auto">Contacto</legend>

                                    <div class="mb-3">
                                        <label for="direccion" class="form-label text-light small">Dirección</label>
                                        <input type="text" class="form-control bg-dark text-light border-secondary"
                                            id="direccion" name="direccion" value="{{ data.direccion or '' }}">
                                    </div>

                                    <div class="mb-3">
                                        <label for="email" class="form-label text-light small">Correo
                                            Electrónico</label>
                                        <input type="email" class="form-control bg-dark text-light border-secondary"
                                            id="email" name="email" value="{{ data.email or '' }}">
                                    </div>

                                    <div class="mb-3">
                                        <label for="telefono" class="form-label text-light small">Teléfono /
                                            Celular</label>
                                        <input type="tel" class="form-control bg-dark text-light border-secondary"
                                            id="telefono" name="telefono" value="{{ data.telefono or '' }}">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label text-light small">Ocupación / Notas</label>
                                        <textarea class="form-control bg-dark text-light border-secondary"
                                            id="ocupacion" name="ocupacion"
                                            rows="2">{{ data.ocupacion or '' }}</textarea>
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('main.listar_clientes') }}" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary fw-bold px-4">
                                <i class="fas fa-save me-1"></i> Guardar Cliente
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Función para mostrar u ocultar apellidos según el tipo
    function toggleCampos() {
        const tipo = document.getElementById('tipo_documento').value;
        const bloqueApellidos = document.getElementById('bloque-apellidos');
        const lblNombres = document.getElementById('lbl-nombres');

        if (tipo === 'RUC') {
            bloqueApellidos.style.display = 'none';
            lblNombres.innerText = 'Razón Social';
            // Limpiar apellidos visuales
            document.getElementById('apellido_paterno').value = '';
            document.getElementById('apellido_materno').value = '';
        } else {
            bloqueApellidos.style.display = 'block';
            lblNombres.innerText = 'Nombres';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar estado visual
        toggleCampos();


        const btnBuscar = document.getElementById('btn-buscar-documento');
        const searchIcon = btnBuscar.querySelector('i');

        btnBuscar.addEventListener('click', async () => {
            const tipo = document.getElementById('tipo_documento').value;
            const numero = document.getElementById('numero_documento').value.trim();

            if (!numero) { alert('Ingrese número'); return; }

            btnBuscar.disabled = true;
            searchIcon.className = 'fas fa-spinner fa-spin';

            try {
                const res = await fetch(`/api/consultar-documento/${tipo}/${numero}`);
                const data = await res.json();

                if (data.success) {
                    // RUC
                    if (data.tipo === 'RUC') {
                        document.getElementById('razon_social_nombres').value = data.razon_social;
                        document.getElementById('direccion').value = data.direccion || '';
                        document.getElementById('apellido_paterno').value = '';
                        document.getElementById('apellido_materno').value = '';
                    }
                    // DNI
                    else {
                        document.getElementById('razon_social_nombres').value = data.nombres;
                        document.getElementById('apellido_paterno').value = data.apellido_paterno;
                        document.getElementById('apellido_materno').value = data.apellido_materno;

                        if (data.direccion) document.getElementById('direccion').value = data.direccion;
                        if (data.fecha_nacimiento) document.getElementById('fecha_nacimiento').value = data.fecha_nacimiento;
                    }
                } else {
                    alert(data.message || 'No encontrado');
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexión');
            } finally {
                btnBuscar.disabled = false;
                searchIcon.className = 'fas fa-search';
            }
        });
    });
</script>
{% endblock %}