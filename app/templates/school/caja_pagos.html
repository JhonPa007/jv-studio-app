{% extends "base.html" %}

{% block title %}Caja Escolar - JV School{% endblock %}

{% block content %}
<div class="row h-100 g-3">
    <!-- PANEL IZQUIERDO: BÚSQUEDA Y DATOS -->
    <div class="col-md-4">
        <div class="card bg-dark text-light h-100 border-secondary shadow">
            <div class="card-header border-secondary">
                <h5 class="mb-0 text-accent"><i class="fas fa-search me-2"></i>Buscar Alumno</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" id="inputBusqueda" class="form-control bg-secondary text-light border-0"
                        placeholder="Código o DNI...">
                    <button class="btn btn-warning" onclick="buscarAlumno()"><i class="fas fa-search"></i></button>
                </div>

                <div id="infoAlumno" class="d-none animate__animated animate__fadeIn">
                    <div class="text-center mb-3">
                        <div class="avatar bg-accent text-dark rounded-circle d-inline-flex align-items-center justify-content-center fw-bold fs-3"
                            style="width: 60px; height: 60px;">
                            <span id="lblIniciales">VP</span>
                        </div>
                        <h5 class="mt-2 mb-0" id="lblNombre">Nombre Alumno</h5>
                        <small class="text-muted" id="lblCodigo">AL-2026-001</small>
                    </div>

                    <ul class="list-group list-group-flush bg-transparent">
                        <li
                            class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between px-0">
                            <span class="text-muted">DNI:</span> <span id="lblDni">-</span>
                        </li>
                        <li
                            class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between px-0">
                            <span class="text-muted">Curso:</span> <span id="lblCurso" class="text-end">-</span>
                        </li>
                        <li
                            class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between px-0">
                            <span class="text-muted">Grupo:</span> <span id="lblGrupo">-</span>
                        </li>
                        <li
                            class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between px-0">
                            <span class="text-muted">Saldo Pendiente:</span>
                            <span id="lblDeudaTotal" class="text-danger fw-bold fs-5">S/ 0.00</span>
                        </li>
                    </ul>
                </div>

                <div id="msgVacio" class="text-center text-muted py-5">
                    <i class="fas fa-user-slash fa-3x mb-3 opacity-25"></i>
                    <p>Ingrese un código o DNI para ver el estado de cuenta.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL CENTRAL: CRONOGRAMA -->
    <div class="col-md-5">
        <div class="card bg-dark text-light h-100 border-secondary shadow">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-white"><i class="fas fa-list-alt me-2"></i>Cronograma de Pagos</h5>
                <span class="badge bg-secondary" id="badgeEstado">Sin datos</span>
            </div>
            <div class="card-body p-0 overflow-auto" style="max-height: 500px;">
                <table class="table table-dark table-hover mb-0 small align-middle">
                    <thead class="sticky-top bg-dark">
                        <tr>
                            <th>Concepto</th>
                            <th>Vencimiento</th>
                            <th class="text-end">Monto</th>
                            <th class="text-end">Saldo</th>
                            <th class="text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCuotas">
                        <!-- JS Load -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PANEL DERECHO: ACCIÓN DE PAGO -->
    <div class="col-md-3">
        <div class="card bg-dark text-light h-100 border-secondary shadow">
            <div class="card-header border-secondary bg-warning text-dark">
                <h5 class="mb-0 fw-bold"><i class="fas fa-cash-register me-2"></i>Caja</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <form id="formPago" onsubmit="event.preventDefault(); confirmarPago();">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Monto a Pagar (S/)</label>
                        <input type="number" step="0.01" min="0.1"
                            class="form-control form-control-lg bg-light text-dark fw-bold" id="inputMonto"
                            placeholder="0.00" required disabled>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small">Método de Pago</label>
                        <select class="form-select bg-secondary text-light border-0" id="selMetodo" disabled>
                            <option value="Efectivo">Efectivo (Soles)</option>
                            <option value="Yape">Yape</option>
                            <option value="Plin">Plin</option>
                            <option value="Tarjeta">Tarjeta Crédito/Débito</option>
                            <option value="Transferencia">Transferencia Bancaria</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small">Observaciones</label>
                        <textarea class="form-control bg-secondary text-light border-0" id="txtObs" rows="2"
                            disabled></textarea>
                    </div>

                    <div class="d-grid mt-auto">
                        <button type="submit" class="btn btn-lg btn-success fw-bold" id="btnProcesar" disabled>
                            <i class="fas fa-check-circle me-2"></i>COBRAR
                        </button>
                    </div>
                </form>

                <div class="mt-4 pt-3 border-top border-secondary">
                    <h6 class="text-muted small mb-2"><i class="fas fa-history me-1"></i>Últimos Pagos</h6>
                    <div class="list-group list-group-flush" id="listaUltimosPagos">
                        <!-- JS ITEMS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let ALUMNO_ACTUAL_ID = null;

    // TODO: Implementar un endpoint real para buscar por DNI/Código.
    // Actualmente 'get_statement' usa ID. Necesito un helper para buscar ID desde DNI.
    // Voy a improvisar: Asumiré que el usuario ingresa ID numérico por ahora para testear,
    // o modificaré el backend para tener un endpoint de búsqueda rápida.
    // MEJOR: Modificaré el JS para que intente buscar.

    document.getElementById('inputBusqueda').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') buscarAlumno();
    });

    async function buscarAlumno() {
        const query = document.getElementById('inputBusqueda').value.trim();
        if (!query) return;

        try {
            // 1. Buscar alumno para obtener su ID numérico
            const searchRes = await fetch(`/school/api/students/search?q=${encodeURIComponent(query)}`);
            if (!searchRes.ok) {
                Swal.fire('No encontrado', 'No existe un alumno con ese Código, DNI o Nombre.', 'warning');
                resetUI();
                return;
            }

            const searchData = await searchRes.json();
            const idToFetch = searchData.id;

            // 2. Cargar Estado de Cuenta usando el ID numérico
            await cargarEstadoCuenta(idToFetch);

        } catch (e) {
            Swal.fire('Error', 'Error de conexión al buscar.', 'error');
            resetUI();
        }
    }

    async function cargarEstadoCuenta(alumnoId) {
        try {
            // UI Loading...

            const res = await fetch(`/school/api/students/${alumnoId}/statement`);
            if (!res.ok) throw new Error('Alumno no encontrado');

            const data = await res.json();
            renderAlumno(data);
        } catch (e) {
            Swal.fire('No encontrado', 'Verifique el ID o intente nuevamente', 'warning');
            resetUI();
        }
    }

    function renderAlumno(data) {
        const al = data.alumno;
        ALUMNO_ACTUAL_ID = al.id;

        // Info Básica
        document.getElementById('msgVacio').classList.add('d-none');
        document.getElementById('infoAlumno').classList.remove('d-none');
        document.getElementById('inputMonto').disabled = false;
        document.getElementById('selMetodo').disabled = false;
        document.getElementById('txtObs').disabled = false;
        document.getElementById('btnProcesar').disabled = false;

        document.getElementById('lblNombre').textContent = `${al.nombres} ${al.apellidos || ''}`;
        document.getElementById('lblCodigo').textContent = al.codigo_alumno;
        document.getElementById('lblDni').textContent = al.dni || '-';
        document.getElementById('lblCurso').textContent = al.curso_nombre || '-';
        document.getElementById('lblGrupo').textContent = al.codigo_grupo || '-';

        const saldo = parseFloat(data.resumen.saldo_pendiente);
        document.getElementById('lblDeudaTotal').textContent = `S/ ${saldo.toFixed(2)}`;

        // Iniciales
        const names = al.nombres.split(' ');
        const ini = names[0][0] + (names[1] ? names[1][0] : (al.apellidos ? al.apellidos[0] : ''));
        document.getElementById('lblIniciales').textContent = ini.toUpperCase();

        // Cronograma (Cuotas)
        const tbody = document.getElementById('tbodyCuotas');
        tbody.innerHTML = '';

        data.cuotas.forEach(c => {
            const tr = document.createElement('tr');
            const vencido = new Date(c.fecha_vencimiento) < new Date() && c.saldo > 0;
            const colorClass = c.estado === 'Completo' ? 'text-success' : (vencido ? 'text-danger' : 'text-warning');

            tr.innerHTML = `
                <td>${c.concepto}</td>
                <td class="${vencido ? 'text-danger fw-bold' : ''}">${c.fecha_vencimiento}</td>
                <td class="text-end">S/ ${parseFloat(c.monto_original).toFixed(2)}</td>
                <td class="text-end fw-bold">S/ ${parseFloat(c.saldo).toFixed(2)}</td>
                <td class="text-center"><span class="badge ${getBadgeClass(c.estado)}">${c.estado}</span></td>
            `;
            tbody.appendChild(tr);
        });

        // Historial Pagos
        const listaPagos = document.getElementById('listaUltimosPagos');
        listaPagos.innerHTML = '';
        data.pagos.slice(0, 5).forEach(p => {
            const item = document.createElement('button');
            item.className = 'list-group-item list-group-item-action bg-transparent text-light border-secondary small py-2';
            item.onclick = () => window.open(`/school/recibo/${p.id}`, '_blank', 'width=400,height=600');
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <span class="text-accent">${p.codigo_recibo || 'REC'}</span>
                    <span>S/ ${parseFloat(p.monto).toFixed(2)}</span>
                </div>
                <small class="text-muted">${p.fecha_pago.substring(0, 16)} - ${p.metodo_pago}</small>
            `;
            listaPagos.appendChild(item);
        });
    }

    function getBadgeClass(estado) {
        if (estado === 'Completo') return 'bg-success';
        if (estado === 'Parcial') return 'bg-warning text-dark';
        return 'bg-secondary';
    }

    function resetUI() {
        ALUMNO_ACTUAL_ID = null;
        document.getElementById('msgVacio').classList.remove('d-none');
        document.getElementById('infoAlumno').classList.add('d-none');
        document.getElementById('tbodyCuotas').innerHTML = '';
        document.getElementById('listaUltimosPagos').innerHTML = '';
        document.getElementById('inputMonto').disabled = true;
        document.getElementById('btnProcesar').disabled = true;
    }

    async function confirmarPago() {
        if (!ALUMNO_ACTUAL_ID) return;
        const monto = parseFloat(document.getElementById('inputMonto').value); // Corregido: value no val
        if (isNaN(monto) || monto <= 0) {
            Swal.fire('Atención', 'Ingrese un monto válido mayor a 0', 'warning');
            return;
        }

        const confirm = await Swal.fire({
            title: '¿Confirmar cobro?',
            text: `Se registrará un pago de S/ ${monto.toFixed(2)}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, Cobrar',
            confirmButtonColor: '#28a745'
        });

        if (confirm.isConfirmed) {
            try {
                const res = await fetch('/school/api/payments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        alumno_id: ALUMNO_ACTUAL_ID,
                        monto: monto,
                        metodo_pago: document.getElementById('selMetodo').value,
                        observaciones: document.getElementById('txtObs').value
                    })
                });

                const result = await res.json();

                if (res.ok) {
                    await Swal.fire('Pago Exitoso', `Recibo Generado: ${result.recibo}`, 'success');

                    // Abrir Recibo
                    window.open(`/school/recibo/${result.pago_id}`, '_blank', 'width=400,height=600');

                    // Recargar Datos
                    document.getElementById('inputMonto').value = '';
                    document.getElementById('txtObs').value = '';
                    cargarEstadoCuenta(ALUMNO_ACTUAL_ID);

                } else {
                    Swal.fire('Error', result.error, 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Fallo de red', 'error');
            }
        }
    }
</script>
{% endblock %}