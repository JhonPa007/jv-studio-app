{% extends "base.html" %}

{% block title %}Fidelización de Clientes - JV Studio{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: var(--color-acento-dorado);"><i class="fas fa-gift me-2"></i>Reglas de Fidelización</h2>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalNuevaRegla">
            <i class="fas fa-plus me-1"></i> Nueva Regla
        </button>
    </div>

    <div class="card bg-dark border-secondary">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                    <thead class="text-warning">
                        <tr>
                            <th>Nombre</th>
                            <th>Servicio Meta</th>
                            <th>Condición</th>
                            <th>Premio</th>
                            <th>Estado</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in reglas %}
                        <tr>
                            <td>{{ r.nombre }}</td>
                            <td>{{ r.servicio_nombre }}</td>
                            <td>{{ r.cantidad_requerida }} servicios en {{ r.periodo_meses }} meses</td>
                            <td class="text-success fw-bold">{{ r.descuento_porcentaje }}% Dcto.</td>
                            <td>
                                {% if r.activo %}
                                <span class="badge bg-success">Activo</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactivo</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <form action="{{ url_for('marketing.eliminar_regla_fidelidad', id=r.id) }}"
                                    method="POST" class="d-inline" onsubmit="return confirm('¿Borrar regla?')">
                                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">No hay reglas configuradas.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Regla -->
<div class="modal fade" id="modalNuevaRegla" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <form action="{{ url_for('marketing.guardar_regla_fidelidad') }}" method="POST">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-award me-2"></i>Nueva Regla de Lealtad
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="fw-bold">Nombre de la Campaña</label>
                        <input type="text" name="nombre" class="form-control" placeholder="Ej: 5 Cortes = 50% Dcto"
                            required>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">Servicios a Contabilizar</label>
                        <select name="servicios_ids[]" id="selectServicios" class="form-select" multiple="multiple"
                            style="width: 100%" required>
                            {% for s in servicios %}
                            <option value="{{ s.id }}">{{ s.nombre }} (S/ {{ s.precio }})</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Seleccione uno o varios servicios.</small>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="fw-bold">Cantidad Requerida</label>
                            <input type="number" name="cantidad_requerida" class="form-control" value="5" min="1"
                                required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="fw-bold">Periodo (Meses)</label>
                            <input type="number" name="periodo_meses" class="form-control" value="3" min="1" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold text-success">Descuento a Aplicar (%)</label>
                        <input type="number" name="descuento_porcentaje" class="form-control" value="50" min="1"
                            max="100" required>
                        <small class="text-muted">El precio será reducido en este porcentaje, pero tu comisión NO se
                            afectará.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-dark w-100">Guardar Regla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Init Select2 on Modal Open
        const modal = document.getElementById('modalNuevaRegla');
        modal.addEventListener('shown.bs.modal', function () {
            $('#selectServicios').select2({
                theme: 'bootstrap-5',
                width: '100%',
                dropdownParent: $('#modalNuevaRegla'),
                placeholder: 'Seleccione servicios...',
                allowClear: true
            });
        });
    });
</script>
{% endblock %}