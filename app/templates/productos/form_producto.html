{% extends "base.html" %}

{% block title %}{{ titulo_form | default('Gestionar Producto') }} - JV Studio{% endblock %}

{% block head_extra %}
<style>
    .form-section { background-color: #3a3a3a; padding: 25px; border-radius: 8px; }
    .form-section h2 { color: var(--color-acento-dorado); margin-bottom: 20px; border-bottom: 1px solid var(--color-secundario-gris); padding-bottom: 10px;}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="form-section">
        <h2>
            <i class="fas {{ 'fa-plus-circle' if es_nuevo else 'fa-edit' }} me-2"></i>
            {{ titulo_form | default('Gestionar Producto') }}
        </h2>
        
        {% include 'partials/_flash_messages.html' %}

        {# data_source será form_data si hay error de validación, o producto si estamos editando #}
        {% set data_source = form_data if form_data else (producto if producto else {}) %}

        <form method="POST" action="{{ action_url }}"> {# action_url se pasa desde Flask #}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nombre" class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="nombre" name="nombre" value="{{ data_source.get('nombre', '') }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="marca_id" class="form-label">Marca (Opcional)</label>
                    {# NUEVO: Dropdown para Marca #}
                    <select class="form-select" id="marca_id" name="marca_id">
                        <option value="">Seleccione una marca (opcional)...</option>
                        {# 'marcas_todas' será una lista de objetos marca pasada desde Flask #}
                        {% for marca_opt in marcas_todas %} 
                            <option value="{{ marca_opt.id }}" {% if data_source.get('marca_id')|string == marca_opt.id|string %}selected{% endif %}>
                                {{ marca_opt.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3"> {# Ajustado a col-md-4 #}
                    <label for="proveedor_id" class="form-label">Proveedor (Opcional)</label>
                    <select class="form-select" id="proveedor_id" name="proveedor_id">
                        <option value="">Seleccione un proveedor (opcional)...</option>
                        {# 'proveedores_todos' es la lista pasada desde Flask #}
                        {% for prov in proveedores_todos %} 
                            <option value="{{ prov.id }}" {% if data_source.get('proveedor_id')|string == prov.id|string %}selected{% endif %}>
                                {{ prov.nombre_empresa }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="descripcion" class="form-label">Descripción (Opcional)</label>
                    <textarea class="form-control" id="descripcion" name="descripcion" rows="2">{{ data_source.get('descripcion', '') }}</textarea>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="categoria_id" class="form-label">Categoría <span class="text-danger">*</span></label>
                    <select class="form-select" id="categoria_id" name="categoria_id" required>
                        <option value="">Seleccione una categoría...</option>
                        {% for cat in categorias_prod %} {# categorias_prod se pasa desde Flask #}
                            <option value="{{ cat.id }}" {% if data_source.get('categoria_id')|string == cat.id|string %}selected{% endif %}>
                                {{ cat.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="codigo_barras" class="form-label">Código de Barras / SKU (Opcional)</label>
                    <input type="text" class="form-control" id="codigo_barras" name="codigo_barras" value="{{ data_source.get('codigo_barras', '') }}">
                </div>
                 <div class="col-md-3 mb-3">
                    <label for="contenido_neto_valor" class="form-label">Contenido Neto (Ej: 250)</label>
                    <input type="number" step="any" min="0" class="form-control" id="contenido_neto_valor" name="contenido_neto_valor" value="{{ data_source.get('contenido_neto_valor', '') }}">
                </div>
                 <div class="col-md-3 mb-3">
                    <label for="unidad_medida" class="form-label">Unidad (Ej: ml, gr)</label>
                    <input type="text" class="form-control" id="unidad_medida" name="unidad_medida" value="{{ data_source.get('unidad_medida', '') }}" placeholder="ml, gr, unidad">
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="precio_compra" class="form-label">Precio de Compra (S/) (Opcional)</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="precio_compra" name="precio_compra" value="{{ data_source.get('precio_compra', '') }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="precio_venta" class="form-label">Precio de Venta (S/) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" min="0" class="form-control" id="precio_venta" name="precio_venta" value="{{ data_source.get('precio_venta', '') }}" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="comision_vendedor_monto" class="form-label">Comisión Vendedor (S/) (Opcional)</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="comision_vendedor_monto" name="comision_vendedor_monto" value="{{ data_source.get('comision_vendedor_monto', '') }}">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="stock_actual" class="form-label">Stock Actual <span class="text-danger">*</span></label>
                    <input type="number" min="0" class="form-control" id="stock_actual" name="stock_actual" value="{{ data_source.get('stock_actual', '0') }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="stock_minimo" class="form-label">Stock Mínimo (Opcional)</label>
                    <input type="number" min="0" class="form-control" id="stock_minimo" name="stock_minimo" value="{{ data_source.get('stock_minimo', '0') }}">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="imagen_url" class="form-label">URL de Imagen (Opcional)</label>
                <input type="text" class="form-control" id="imagen_url" name="imagen_url" value="{{ data_source.get('imagen_url', '') }}">
            </div>

            <div class="mb-3 form-check">
                {% set activo_val = False %} 
                {% if es_nuevo and not form_data %} 
                    {% set activo_val = True %}
                {% elif data_source.get('activo') is not none %}
                    {% if data_source.get('activo') == 'activo' or data_source.get('activo') == True or data_source.get('activo') == 1 %}
                        {% set activo_val = True %}
                    {% endif %}
                {% endif %}
                <input type="checkbox" class="form-check-input" id="activo" name="activo" value="activo" {% if activo_val %}checked{% endif %}>
                <label class="form-check-label" for="activo">Producto Activo para la Venta</label>
            </div>
            
            <div class="d-flex justify-content-end mt-4">
                <a href="{{ url_for('main.listar_productos') }}" class="btn btn-secondary me-2">
                    <i class="fas fa-times me-1"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>{{ 'Guardar Producto' if es_nuevo else 'Actualizar Producto' }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}