<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}JV Studio{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        /* Fallback for Jinja variables if no theme class is selected */
        :root {
            --color-accent: {
                    {
                    tema_sistema.primario | default('#ffc107')
                }
            }

            ;

            /* Dynamic Font from Database */
                {
                % if config_sucursal and config_sucursal.app_fuente %
            }

            --font-primary: '{{ config_sucursal.app_fuente }}',
            sans-serif !important;

                {
                % else %
            }

            --font-primary: 'Agency FB',
            sans-serif !important;

                {
                % endif %
            }
        }

        body {
            font-family: var(--font-primary);
        }

        body {
            font-family: var(--font-primary);
        }
    </style>
    <style>
        /* Force Black Text for Help Modal */
        #modalAyudaSistema .modal-body,
        #modalAyudaSistema .modal-body p,
        #modalAyudaSistema .modal-body li,
        #modalAyudaSistema .modal-body h1,
        #modalAyudaSistema .modal-body h2,
        #modalAyudaSistema .modal-body h3,
        #modalAyudaSistema .modal-body h4,
        #modalAyudaSistema .modal-body h5,
        #modalAyudaSistema .modal-body h6,
        #modalAyudaSistema .modal-body span,
        #modalAyudaSistema .modal-body div {
            color: #000000 !important;
        }
    </style>
    {% block head_extra %}{% endblock %}
</head>

<body class="d-flex theme-barber-default"> <!-- Default Theme -->

    <nav class="vertical-menu" id="sidebar">
        <div class="sidebar-header p-3 d-flex justify-content-between align-items-center">
            <h3 class="mb-0 ms-2 sidebar-brand-text"
                style="font-size: 1.5rem; font-weight: bold; color: var(--color-accent); font-family: var(--font-primary);">
                JV Studio</h3>
            <button class="btn-toggle-sidebar" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <hr style="border-color: var(--color-border); margin: 0 1rem;">

        <ul class="nav flex-column mt-3">

            {% if current_user.can('ver_dashboard') %}
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'main.index' %}active{% endif %}"
                    href="{{ url_for('main.index') }}" title="Dashboard">
                    <i class="fas fa-tachometer-alt fa-fw me-2"></i> <span class="link-text">Dashboard</span>
                </a>
            </li>
            {% endif %}

            {% if current_user.can('ver_caja') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle {% if request.endpoint in ['main.gestionar_caja', 'main.listar_historial_caja'] %}active{% endif %}"
                    href="#cajaSubmenu" data-bs-toggle="collapse" role="button" title="Caja">
                    <i class="fas fa-cash-register fa-fw me-2"></i> <span class="link-text">Caja</span>
                </a>
                <div class="collapse {% if request.endpoint in ['main.gestionar_caja', 'main.listar_historial_caja'] %}show{% endif %}"
                    id="cajaSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.gestionar_caja') }}"><i
                                    class="fas fa-calculator fa-fw me-2"></i> Control de Turno</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_historial_caja') }}"><i
                                    class="fas fa-history fa-fw me-2"></i> Historial de Cajas</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_clientes') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle {% if request.path.startswith('/clientes') %}active{% endif %}"
                    href="#clientesSubmenu" data-bs-toggle="collapse" role="button" title="Clientes">
                    <i class="fas fa-users fa-fw me-2"></i> <span class="link-text">Clientes</span>
                </a>
                <div class="collapse {% if request.path.startswith('/clientes') %}show{% endif %}" id="clientesSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.listar_clientes') }}">Lista Clientes</a>
                        </li>
                        <li><a class="nav-link small" href="{{ url_for('main.nuevo_cliente') }}">Nuevo Cliente</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.importar_clientes') }}">Importar Excel</a>
                        </li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_reservas') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle {% if request.path.startswith('/reservas') %}active{% endif %}"
                    href="#reservasSubmenu" data-bs-toggle="collapse" role="button" title="Reservas">
                    <i class="fas fa-calendar-alt fa-fw me-2"></i> <span class="link-text">Reservas</span>
                </a>
                <div class="collapse {% if request.path.startswith('/reservas') %}show{% endif %}" id="reservasSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.render_agenda_diaria') }}">Agenda
                                Diaria</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_reservas') }}">Listado General</a>
                        </li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_ventas') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle {% if request.path.startswith('/ventas') %}active{% endif %}"
                    href="#ventasSubmenu" data-bs-toggle="collapse" role="button" title="Ventas">
                    <i class="fas fa-shopping-cart fa-fw me-2"></i> <span class="link-text">Ventas</span>
                </a>
                <div class="collapse {% if request.path.startswith('/ventas') %}show{% endif %}" id="ventasSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.nueva_venta') }}">Nueva Venta</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_ventas') }}">Historial Ventas</a>
                        </li>
                        <li><a class="nav-link small" href="{{ url_for('main.nueva_comanda') }}">Nueva Comanda</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_comandas_pendientes') }}">Comandas
                                Pend.</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_servicios') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#serviciosSubmenu" data-bs-toggle="collapse" role="button"
                    title="Servicios">
                    <i class="fas fa-cut fa-fw me-2"></i> <span class="link-text">Servicios</span>
                </a>
                <div class="collapse" id="serviciosSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.listar_servicios') }}">Cat√°logo</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_estilos') }}">Estilos</a></li>
                        <li><a class="nav-link small"
                                href="{{ url_for('main.listar_categorias_servicios') }}">Categor√≠as</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_inventario') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#inventarioSubmenu" data-bs-toggle="collapse" role="button"
                    title="Inventario">
                    <i class="fas fa-boxes fa-fw me-2"></i> <span class="link-text">Inventario</span>
                </a>
                <div class="collapse" id="inventarioSubmenu">
                    <ul class="nav flex-column ms-3">

                        <li>
                            <a class="nav-link small fw-bold text-warning"
                                href="{{ url_for('inventario.lista_inventario') }}">
                                <i class="fas fa-clipboard-list me-1"></i> Kardex / Control Stock
                            </a>
                        </li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_productos') }}">Productos
                                (Cat√°logo)</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.nueva_compra') }}">Registrar Compra</a>
                        </li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_compras') }}">Historial Compras</a>
                        </li>

                        <li><a class="nav-link small" href="{{ url_for('main.listar_proveedores') }}">Proveedores</a>
                        </li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_marcas') }}">Marcas</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_equipo') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#equipoSubmenu" data-bs-toggle="collapse" role="button"
                    title="Equipo">
                    <i class="fas fa-user-tie fa-fw me-2"></i> <span class="link-text">Equipo</span>
                </a>
                <div class="collapse" id="equipoSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.listar_empleados') }}">Colaboradores</a>
                        </li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_roles') }}">Roles</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_campanas') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#marketingSubmenu" data-bs-toggle="collapse" role="button"
                    title="Marketing">
                    <i class="fas fa-bullhorn fa-fw me-2"></i> <span class="link-text">Marketing</span>
                </a>
                <div class="collapse" id="marketingSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('marketing.consultar_cliente') }}">Consultar
                                Cliente</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_campanas') }}">Promociones</a></li>
                        <li><a class="nav-link small"
                                href="{{ url_for('marketing.listar_reglas_fidelidad') }}">Fidelizaci√≥n</a></li>
                        <li><a class="nav-link small" href="{{ url_for('marketing.listar_crm_config') }}">CRM</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_finanzas') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#finanzasSubmenu" data-bs-toggle="collapse" role="button"
                    title="Finanzas">
                    <i class="fas fa-chart-line fa-fw me-2"></i> <span class="link-text">Finanzas</span>
                </a>
                <div class="collapse" id="finanzasSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.nuevo_gasto') }}">Registrar Gasto</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_gastos') }}">Historial Gastos</a>
                        </li>
                        <li><a class="nav-link small"
                                href="{{ url_for('main.listar_categorias_gastos') }}">Categor√≠as</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.rol_nombre == 'Administrador' %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#rrhhSubmenu" data-bs-toggle="collapse" role="button"
                    title="RR.HH.">
                    <i class="fas fa-users-cog fa-fw me-2"></i> <span class="link-text">RR.HH.</span>
                </a>
                <div class="collapse" id="rrhhSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('finanzas.ver_planilla') }}">Generar Planilla</a>
                        </li>
                        <li><a class="nav-link small" href="{{ url_for('finanzas.ver_fondo_admin') }}">Fondo de
                                Lealtad</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_empleados') }}">Lista de
                                Colaboradores</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_reportes') %}
            <li class="nav-item">
                <a class="nav-link dropdown-toggle" href="#reportesSubmenu" data-bs-toggle="collapse" role="button"
                    title="Reportes">
                    <i class="fas fa-chart-bar fa-fw me-2"></i> <span class="link-text">Reportes</span>
                </a>
                <div class="collapse" id="reportesSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.reporte_produccion_general') }}">Producci√≥n
                                Gral</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.reporte_produccion') }}">Producci√≥n
                                Indiv</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.reporte_liquidacion') }}">Liquidaciones</a>
                        </li>
                    </ul>
                </div>
            </li>
            {% endif %}

            {% if current_user.can('ver_configuracion') %}
            <li class="nav-item mt-3">
                <a class="nav-link dropdown-toggle" href="#configSubmenu" data-bs-toggle="collapse" role="button"
                    title="Configuraci√≥n">
                    <i class="fas fa-cogs fa-fw me-2"></i> <span class="link-text">Configuraci√≥n</span>
                </a>
                <div class="collapse" id="configSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link small" href="{{ url_for('main.configurar_sistema') }}">Apariencia</a>
                        </li>
                        <li><a class="nav-link small" href="{{ url_for('main.configurar_facturacion') }}">Facturaci√≥n
                                SUNAT</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_sucursales') }}">Sucursales</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_series') }}">Series</a></li>
                        <li><a class="nav-link small"
                                href="{{ url_for('main.listar_planes_membresia') }}">Membres√≠as</a></li>
                        <li><a class="nav-link small" href="{{ url_for('main.listar_bonos') }}">Bonos</a></li>
                    </ul>
                </div>
            </li>
            {% endif %}

        </ul>
    </nav>

    <div class="main-content-wrapper d-flex flex-column flex-grow-1">

        <header class="page-header">
            <nav class="navbar navbar-expand-lg navbar-dark top-navbar px-3">
                <div class="container-fluid p-0">
                    <button class="btn btn-outline-warning d-md-none me-2" type="button" id="mobileMenuToggle">
                        <i class="fas fa-bars"></i>
                    </button>

                    <div class="d-none d-md-block text-muted"></div>

                    <div class="collapse navbar-collapse">
                        <ul class="navbar-nav ms-auto align-items-center">

                            <!-- THEME SWITCHER -->
                            <li class="nav-item dropdown me-2">
                                <a class="nav-link dropdown-toggle" href="#" id="themeDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-expanded="false" title="Cambiar Tema">
                                    <i class="fas fa-palette fa-lg text-accent"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end shadow p-3"
                                    aria-labelledby="themeDropdown" style="min-width: 280px;">
                                    <li>
                                        <h6 class="dropdown-header text-accent">üíà Barber Themes (Dark)</h6>
                                    </li>
                                    <li>
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <div class="theme-swatch"
                                                style="background: #121212; border-color: #d4af37;"
                                                onclick="setTheme('theme-barber-default')" title="Default Gold"></div>
                                            <div class="theme-swatch"
                                                style="background: #0b1116; border-color: #00bcd4;"
                                                onclick="setTheme('theme-barber-titanium')" title="Titanium"></div>
                                            <div class="theme-swatch"
                                                style="background: #1a1512; border-color: #cd853f;"
                                                onclick="setTheme('theme-barber-leather')" title="Leather"></div>
                                            <div class="theme-swatch"
                                                style="background: #000000; border-color: #2962ff;"
                                                onclick="setTheme('theme-barber-midnight')" title="Midnight"></div>
                                            <div class="theme-swatch"
                                                style="background: #0e1610; border-color: #cca43b;"
                                                onclick="setTheme('theme-barber-forest')" title="Forest"></div>
                                        </div>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <h6 class="dropdown-header text-accent">üíá‚Äç‚ôÄÔ∏è Salon Themes (Light)</h6>
                                    </li>
                                    <li>
                                        <div class="d-flex flex-wrap gap-2">
                                            <div class="theme-swatch"
                                                style="background: #fff0f5; border-color: #e08dac;"
                                                onclick="setTheme('theme-salon-rose')" title="Rose"></div>
                                            <div class="theme-swatch"
                                                style="background: #f3e5f5; border-color: #ab47bc;"
                                                onclick="setTheme('theme-salon-lavender')" title="Lavender"></div>
                                            <div class="theme-swatch"
                                                style="background: #ffffff; border-color: #ff00ba;"
                                                onclick="setTheme('theme-salon-chic')" title="Chic"></div>
                                            <div class="theme-swatch"
                                                style="background: #f1f8e9; border-color: #7cb342;"
                                                onclick="setTheme('theme-salon-nature')" title="Nature"></div>
                                            <div class="theme-swatch"
                                                style="background: #e3f2fd; border-color: #00bcd4;"
                                                onclick="setTheme('theme-salon-ocean')" title="Ocean"></div>
                                        </div>
                                    </li>
                                </ul>
                            </li>

                            {% if mis_sucursales and mis_sucursales|length > 1 %}
                            <li class="nav-item dropdown me-3">
                                <a class="nav-link dropdown-toggle text-accent fw-bold" href="#" role="button"
                                    data-bs-toggle="dropdown">
                                    <i class="fas fa-store-alt me-1"></i>
                                    {{ session.get('sucursal_nombre', 'Sede') }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-dark border-warning">
                                    <li>
                                        <h6 class="dropdown-header">Cambiar Sede</h6>
                                    </li>
                                    {% for suc in mis_sucursales %}
                                    <li>
                                        <a class="dropdown-item d-flex justify-content-between"
                                            href="{{ url_for('main.cambiar_sucursal_activa', sucursal_id=suc.id) }}">
                                            {{ suc.nombre }}
                                            {% if session.get('sucursal_id')|int == suc.id %}<i
                                                class="fas fa-check text-success"></i>{% endif %}
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </li>
                            {% endif %}

                            {% if current_user.is_authenticated %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-white" href="#" id="userDropdown" role="button"
                                    data-bs-toggle="dropdown">
                                    <i class="fas fa-user-circle me-1 fa-lg"></i>
                                    <span class="d-none d-sm-inline">Hola, {{ current_user.nombres.split(' ')[0]
                                        }}</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end shadow"
                                    aria-labelledby="userDropdown">
                                    <li>
                                        <h6 class="dropdown-header">{{ current_user.get_full_name() }}</h6>
                                    </li>
                                    <li><span class="dropdown-item-text text-muted"><small>{{ current_user.rol_nombre or
                                                current_user.rol }}</small></span></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="{{ url_for('main.logout') }}">
                                            <i class="fas fa-sign-out-alt fa-fw me-2"></i>Cerrar Sesi√≥n
                                        </a>
                                    </li>
                                </ul>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </nav>
        </header>

        <main class="container-fluid my-4 px-4">
            {% include 'partials/_flash_messages.html' %}
            {% block content %}{% endblock %}
        </main>

        <footer class="footer mt-auto py-3 bg-dark text-center"
            style="border-top: 1px solid var(--color-border); background-color: var(--color-bg-sidebar) !important;">
            <div class="container">
                <h5 class="text-accent mb-1">{{ sucursal_actual.nombre if sucursal_actual else 'JV Studio' }}</h5>
                <p class="text-light mb-3 small">
                    <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                    {{ sucursal_actual.direccion if sucursal_actual else 'Direcci√≥n Principal' }}
                </p>

                <div class="social-icons mb-3">
                    {% if sucursal_actual %}
                    {% if sucursal_actual.facebook_url %}<a href="{{ sucursal_actual.facebook_url }}" target="_blank"
                        class="mx-2 text-light fs-5"><i class="fab fa-facebook-f"></i></a>{% endif %}
                    {% if sucursal_actual.instagram_url %}<a href="{{ sucursal_actual.instagram_url }}" target="_blank"
                        class="mx-2 text-light fs-5"><i class="fab fa-instagram"></i></a>{% endif %}
                    {% if sucursal_actual.tiktok_url %}<a href="{{ sucursal_actual.tiktok_url }}" target="_blank"
                        class="mx-2 text-light fs-5"><i class="fab fa-tiktok"></i></a>{% endif %}
                    {% if sucursal_actual.whatsapp_numero %}<a
                        href="https://wa.me/51{{ sucursal_actual.whatsapp_numero }}" target="_blank"
                        class="mx-2 text-success fs-4"><i class="fab fa-whatsapp"></i></a>{% endif %}
                    {% else %}
                    <a href="#" class="mx-2 text-light fs-5"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="mx-2 text-light fs-5"><i class="fab fa-instagram"></i></a>
                    {% endif %}
                </div>

                <small class="text-muted">¬© <span id="current-year"></span> {{ config_sistema.nombre_empresa if
                    config_sistema else 'JV Studio' }}. Todos los derechos reservados.</small>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- THEME MANAGER SCRIPT -->
    <script>
        // Check for saved theme preference
        const savedTheme = localStorage.getItem('jv-studio-theme');
        if (savedTheme) {
            document.body.className = `d-flex ${savedTheme}`;
        }

        // Global function to set theme
        window.setTheme = function (themeClass) {
            document.body.className = `d-flex ${themeClass}`;
            localStorage.setItem('jv-studio-theme', themeClass);
        }
    </script>

    <!-- MODAL AYUDA GLOBAL (F1) -->
    <div class="modal fade" id="modalAyudaSistema" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-question-circle text-warning"></i> Ayuda del Sistema</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body text-dark" id="contenidoAyuda">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar (Esc)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT GESTOR DE AYUDA (F1) -->
    <script>
        document.addEventListener('keydown', function (event) {
            // Detectar tecla F1 (C√≥digo 112)
            if (event.key === 'F1' || event.keyCode === 112) {
                event.preventDefault(); // Evitar ayuda del navegador
                abrirAyudaContextual();
            }
        });

        function abrirAyudaContextual() {
            var myModal = new bootstrap.Modal(document.getElementById('modalAyudaSistema'));
            myModal.show();

            const contenidoDiv = document.getElementById('contenidoAyuda');
            contenidoDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p>Cargando manual...</p></div>';

            // Enviar la ruta actual para obtener ayuda relevante
            const currentPath = window.location.pathname;

            fetch(`/ayuda/contenido?path=${encodeURIComponent(currentPath)}`)
                .then(response => response.text())
                .then(html => {
                    contenidoDiv.innerHTML = html;
                })
                .catch(err => {
                    contenidoDiv.innerHTML = `<div class="alert alert-danger">No se pudo cargar la ayuda. <br>${err}</div>`;
                });
        }
    </script>

    {% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // A√±o
            const yearSpan = document.getElementById('current-year');
            if (yearSpan) yearSpan.textContent = new Date().getFullYear();

            // SIDEBAR COLLAPSIBLE
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content-wrapper');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mobileToggle = document.getElementById('mobileMenuToggle'); // Defined before usage

            if (localStorage.getItem('sidebar-collapsed') === 'true') {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
            }

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                    localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('collapsed'));
                });
            }

            // Mobile
            if (mobileToggle) {
                mobileToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('show');
                });
            }
        });
    </script>
    {% endblock scripts %}
</body>

</html>