{% extends "base.html" %}

{% block title %}Listado de Reservas - JV Studio{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: var(--color-acento-dorado);"><i class="fas fa-list-alt me-2"></i>Listado General de Reservas</h2>
        <a href="{{ url_for('main.render_agenda_diaria') }}" class="btn btn-primary">
            <i class="fas fa-calendar-plus me-2"></i>Ir a la Agenda
        </a>
    </div>

    

    <div class="table-responsive">
        <table class="table table-hover table-custom table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha y Hora</th>
                    <th>Cliente</th>
                    <th>Colaborador</th>
                    <th>Servicio</th>
                    <th class="text-end">Precio (S/)</th>
                    <th>Estado</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for reserva in reservas %}
                <tr>
                    <td>{{ reserva.id }}</td>
                    <td>{{ reserva.fecha_hora }}</td>
                    <td>{{ reserva.cliente_nombre or 'N/A' }}</td>
                    <td>{{ reserva.empleado_nombre or 'N/A' }}</td>
                    <td>{{ reserva.servicio_nombre }}</td>
                    <td class="text-end">{{ "%.2f"|format(reserva.precio_cobrado) if reserva.precio_cobrado is not none else '-' }}</td>
                    <td>
                        <span class="badge p-2 {% if reserva.estado == 'Completada' %}bg-success{% elif reserva.estado.startswith('Cancelada') %}bg-danger{% else %}bg-info{% endif %}">
                            {{ reserva.estado }}
                        </span>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-xs btn-light btn-gestionar-reserva" data-reserva-id="{{ reserva.id }}">
                            Ver / Gestionar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if not reservas %}
        <div class="alert alert-info-custom mt-3">No hay reservas para mostrar.</div>
    {% endif %}
</div>

{# Incluimos el HTML del modal desde el archivo parcial #}
{% include 'reservas/_modal_gestionar_reserva.html' %}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Selectores y Variables ---
    const modalGestionarElement = document.getElementById('modalGestionarReserva');
    const modalGestionarInstancia = modalGestionarElement ? new bootstrap.Modal(modalGestionarElement) : null;
    let datosReservaActualParaModal = null;

    const todosLosClientes = JSON.parse('{{ clientes_todos | tojson | safe if clientes_todos else "[]" }}');
    const todosLosEmpleadosParaSelector = JSON.parse('{{ empleados_para_selector | tojson | safe if empleados_para_selector else "[]" }}');
    const todosLosServiciosActivos = JSON.parse('{{ servicios_todos_activos | tojson | safe if servicios_todos_activos else "[]" }}');

    // --- Función Principal del Modal ---
    function abrirModalGestionarReserva(reservaId) {
        const modalTitle = document.getElementById('modalGestionarReservaLabel');
        const vistaDiv = document.getElementById('detalleReservaVista');
        const formEditar = document.getElementById('formEditarReservaModal');
        const btnEditar = document.getElementById('btnModalEditarReserva');
        const btnCancelarReserva = document.getElementById('btnModalCancelarReserva');
        const btnCompletarReserva = document.getElementById('btnModalCompletarReserva');
        const btnCancelarEdicion = document.getElementById('btnModalCancelarEdicion');
        const btnGuardarCambios = document.getElementById('btnModalGuardarCambios');

        function cambiarModo(modoVista, data = null) {
            vistaDiv.style.display = modoVista ? 'block' : 'none';
            formEditar.style.display = modoVista ? 'none' : 'block';
            document.getElementById('modalEditarErrores').style.display = 'none';
            const esFinal = data ? ['Completada', 'Cancelada', 'No Asistio'].some(s => data.estado?.includes(s)) : true;
            btnEditar.style.display = modoVista && !esFinal ? 'inline-block' : 'none';
            btnCancelarReserva.style.display = modoVista && !esFinal ? 'inline-block' : 'none';
            btnCompletarReserva.style.display = modoVista && !esFinal ? 'inline-block' : 'none';
            btnCancelarEdicion.style.display = modoVista ? 'none' : 'inline-block';
            btnGuardarCambios.style.display = modoVista ? 'none' : 'inline-block';
            
            if (!modoVista && data) {
                modalTitle.innerHTML = `<i class="fas fa-edit me-2"></i>Editando Reserva #${data.id}`;
                document.getElementById('editReservaId').value = data.id;
                const poblarSelect = (selId, items, valActual, txtCallback) => {
                    const sel = document.getElementById(selId);
                    sel.innerHTML = `<option value="">Seleccione...</option>`;
                    items.forEach(item => { sel.add(new Option(txtCallback(item), item.id)); });
                    sel.value = valActual;
                };
                poblarSelect('editClienteId', todosLosClientes, data.cliente_id, item => `${item.razon_social_nombres} ${item.apellidos || ''}`);
                poblarSelect('editEmpleadoId', todosLosEmpleadosParaSelector, data.empleado_id, item => `${item.nombres} ${item.apellidos}`);
                poblarSelect('editServicioId', todosLosServiciosActivos, data.servicio_id, item => `${item.nombre} (${item.duracion_minutos} min)`);
                if (data.fecha_hora_inicio) document.getElementById('editFechaHoraInicio').value = data.fecha_hora_inicio.slice(0, 16);
                document.getElementById('editPrecioCobrado').value = data.precio_cobrado ? parseFloat(data.precio_cobrado).toFixed(2) : '';
                document.getElementById('editNotasCliente').value = data.notas_cliente || '';
                document.getElementById('editNotasInternas').value = data.notas_internas || '';
            }
        }
        
        cambiarModo(true);
        modalTitle.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Cargando...`;
        if(modalGestionarInstancia) modalGestionarInstancia.show();

        fetch(`/api/reservas/${reservaId}`)
            .then(r => r.ok ? r.json() : Promise.reject('No se pudieron cargar los datos.'))
            .then(data => {
                datosReservaActualParaModal = data; 
                modalTitle.innerHTML = `<i class="fas fa-calendar-check me-2"></i>Detalles de Reserva #${data.id}`;
                const inicioDT = new Date(data.fecha_hora_inicio);
                vistaDiv.innerHTML = `<dl class="row"><dt class="col-sm-4">Cliente:</dt><dd class="col-sm-8">${data.cliente_nombre_completo||'-'}</dd><dt class="col-sm-4">Colaborador:</dt><dd class="col-sm-8">${data.empleado_nombre_completo||'-'}</dd><dt class="col-sm-4">Servicio:</dt><dd class="col-sm-8">${data.servicio_nombre||'-'}</dd><dt class="col-sm-4">Inicio:</dt><dd class="col-sm-8">${inicioDT.toLocaleString('es-PE')}</dd></dl>`;
                cambiarModo(true, data);
            })
            .catch(error => { vistaDiv.innerHTML = `<p class="text-danger">${error}</p>`; });
        
        btnEditar.onclick = () => { if(datosReservaActualParaModal) cambiarModo(false, datosReservaActualParaModal); };
        btnCancelarEdicion.onclick = () => { if(datosReservaActualParaModal) cambiarModo(true, datosReservaActualParaModal); };
        btnCancelarReserva.onclick = () => { if (confirm(`¿Seguro que quieres CANCELAR la reserva #${reservaId}?`)) { fetch(`/reservas/cancelar/${reservaId}`, {method: 'POST'}).then(r => r.json()).then(res => { if(res.success){ modalGestionarInstancia.hide(); location.reload(); } alert(res.message); }) }};
        btnCompletarReserva.onclick = () => { if (confirm(`¿Seguro que quieres marcar como COMPLETADA la reserva #${reservaId}?`)) { fetch(`/api/reservas/${reservaId}/completar`, {method: 'POST'}).then(r => r.json()).then(res => { if(res.success){ modalGestionarInstancia.hide(); location.reload(); } alert(res.message); }) }};
    }

    // --- Listeners Principales ---
    document.querySelector('tbody').addEventListener('click', function(event) {
        const boton = event.target.closest('.btn-gestionar-reserva');
        if (boton) {
            abrirModalGestionarReserva(boton.dataset.reservaId);
        }
    });

    document.getElementById('formEditarReservaModal')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnModalGuardarCambios');
        const errDiv = document.getElementById('modalEditarErrores');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        
        const reservaId = datosReservaActualParaModal.id;
        const payload = Object.fromEntries(new FormData(this));
        
        fetch(`/reservas/editar/${reservaId}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
            .then(res => res.json().then(d => ({ok: res.ok, data: d})))
            .then(res => {
                if (res.ok && res.data.success) { 
                    modalGestionarInstancia.hide();
                    location.reload(); // Recargar la página para ver los cambios
                } else { 
                    errDiv.innerHTML = (res.data.errors || [res.data.message]).join('<br>');
                    errDiv.style.display = 'block';
                }
            })
            .catch(err => { errDiv.innerHTML = `Error: ${err.message}`; errDiv.style.display = 'block'; })
            .finally(() => { btn.disabled = false; btn.textContent = 'Guardar Cambios'; });
    });
});
</script>
{% endblock %}