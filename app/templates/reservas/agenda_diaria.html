{% extends "base.html" %}

{% block title %}Agenda Diaria de Citas - JV Studio{% endblock %}

{% block head_extra %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>

<style>
    /* --- 1. Contenedor Principal --- */
    #calendar { 
        border: 1px solid #d1d5db; 
        border-radius: 8px; 
        padding: 10px; 
        background-color: #ffffff; /* Marco blanco */
        min-height: 650px; 
    }
    
    /* Barra de Herramientas */
    #controlesAgenda { 
        background-color: #212529; 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        display: flex; 
        gap: 15px; 
        align-items: center; 
        flex-wrap: wrap; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* --- 2. ESTILO TIPO "FRESHA" (FullCalendar) --- */

    /* A. FONDO RAYADO BASE */
    .fc-timegrid-col {
        background-color: #f3f4f6 !important;
        background-image: repeating-linear-gradient(
            45deg,
            #e5e7eb,
            #e5e7eb 2px,
            #f3f4f6 2px,
            #f3f4f6 10px
        ) !important;
    }
    
    /* B. CELDAS PRINCIPALES (SLOTS) */
    /* CR칈TICO: position relative hace que la barra hover se limite al ancho de la columna */
    .fc-timegrid-slot {
        position: relative !important; 
        z-index: 1;
        border-bottom: 1px solid #efefef !important; /* L칤neas muy suaves */
    }

    /* C. FONDO BLANCO PARA TURNOS DISPONIBLES 
       (Esto normalmente lo maneja FullCalendar con eventos de fondo, 
       pero aseguramos que no tapen la barra hover con z-index) */
    .fc-bg-event {
        opacity: 1.0 !important; 
        z-index: 2 !important; /* Nivel intermedio */
    }
    
    /* D. HEADER Y TEXTOS */
    .fc-col-header-cell {
        background-color: #ffffff !important;
        border-bottom: 2px solid #e5e7eb !important;
    }
    .fc-col-header-cell-cushion { 
        color: #111827 !important; 
        font-weight: 700 !important;
        text-transform: uppercase;
        font-size: 0.9rem;
        padding: 15px 0 !important;
    }
    .fc-timegrid-slot-label-cushion { 
        color: #6b7280 !important; 
        font-size: 0.85em;
        font-weight: 600;
    }
    .fc-theme-standard td, .fc-theme-standard th {
        border-color: #ffffff !important; 
    }
    
    /* E. TARJETAS DE CITAS (EVENTOS) */
    .fc-event { 
        border: none !important; 
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        margin: 1px 2px !important; 
        z-index: 50 !important; /* Siempre encima de todo */
    }
    .fc-event-main { 
        color: #ffffff !important; 
        font-weight: 600;
        padding: 2px 4px;
        font-size: 0.85rem;
    }
    
    /* INDICADOR DE HORA ACTUAL (L칤nea Roja) */
    .fc-timegrid-now-indicator-line {
        border-color: #ef4444; 
        border-width: 2px;
        z-index: 51;
    }
    .fc-timegrid-now-indicator-arrow {
        border-color: #ef4444;
        z-index: 51;
    }
    .fc-day-today {
        background-color: transparent !important;
    }

    /* --- CORRECCIONES VISUALES --- */
    .fc .fc-timegrid-axis-cushion,
    .fc .fc-timegrid-axis-frame,
    .fc .fc-timegrid-axis {
        background-color: #ffffff !important;
    }
    .fc-theme-standard .fc-scrollgrid {
        border-color: #e5e7eb;
    }

    /* =========================================
       NUEVO: EFECTO HOVER TIPO FRESHA 
       ========================================= */
    #indicadorHoraHover {
        position: absolute;
        left: 0;
        right: 0;
        height: 100%; /* Llena la celda verticalmente */
        background-color: rgba(108, 99, 255, 0.2); /* Morado suave y transparente */
        color: #5a52d6; /* Texto morado fuerte */
        font-size: 0.85rem;
        font-weight: 700;
        padding-left: 10px;
        display: none; /* Se activa con JS */
        align-items: center;
        pointer-events: none; /* CR칈TICO: Permite hacer clic "a trav칠s" de la barra */
        z-index: 20; /* Encima del fondo blanco (2), debajo de los eventos (50) */
        border-radius: 3px;
        border-left: 4px solid #5a52d6; /* Borde de acento izquierdo */
        box-shadow: 0 2px 5px rgba(90, 82, 214, 0.1);
        transition: top 0.1s ease; /* Suavizado opcional */
    }

</style>
{% endblock head_extra %}

{% block content %}
<div class="container-fluid mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: var(--color-acento-dorado);"><i class="fas fa-calendar-day me-2"></i>Agenda Diaria</h2>
        <span class="badge bg-warning text-dark fs-6 shadow-sm">
            <i class="fas fa-map-marker-alt me-2"></i>Sucursal: {{ session.get('sucursal_nombre', 'Actual') }}
        </span>
    </div>

    <div id="controlesAgenda" class="d-flex flex-wrap align-items-center gap-3 p-3 rounded mb-4" style="background-color: #3a3a3a;">
        
        <input type="hidden" id="selectorSucursalAgenda" value="{{ session.get('sucursal_id') }}">

        <div class="ms-md-3">
            <label for="selectorFechaAgenda" class="form-label text-light small fw-bold">Fecha:</label>
            <div class="d-flex align-items-center">
                <button id="btnDiaAnterior" class="btn btn-outline-light btn-sm"><i class="fas fa-chevron-left"></i></button>
                <input type="date" id="selectorFechaAgenda" class="form-control form-control-sm mx-1 fw-bold text-center" style="width: 140px;">
                <button id="btnDiaSiguiente" class="btn btn-outline-light btn-sm"><i class="fas fa-chevron-right"></i></button>
                <button id="btnHoy" class="btn btn-warning btn-sm ms-2 fw-bold text-dark"><i class="fas fa-calendar-day me-1"></i> Hoy</button>
            </div>
        </div>
        
        <div class="ms-md-3 mt-2 mt-md-0">
            <label for="selectorEmpleadosAgenda" class="form-label text-light small fw-bold">Filtrar Colaboradores:</label>
            <select multiple class="form-select form-select-sm" id="selectorEmpleadosAgenda" style="width: 250px; min-height: 38px; display: inline-block; vertical-align: middle;">
                {% if not empleados_para_selector %}
                    <option value="" disabled>No hay colaboradores disponibles</option>
                {% else %}
                    {% for emp in empleados_para_selector %}
                        <option value="{{ emp.id }}" selected>{{ emp.nombres }} {{ emp.apellidos }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        
        <div class="ms-md-auto mt-2 mt-md-0">
            <button id="btnActualizarAgenda" class="btn btn-primary btn-sm fw-bold shadow-sm">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
    </div>
    
    <div id='calendar' class="mt-4 shadow-lg"></div>

    {% include 'reservas/_modal_nueva_reserva.html' %}
    {% include 'reservas/_modal_gestionar_reserva.html' %}
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Selectores
    const selectorSucursal = document.getElementById('selectorSucursalAgenda');
    const selectorFecha = document.getElementById('selectorFechaAgenda');
    const btnActualizar = document.getElementById('btnActualizarAgenda');
    const agendaContainer = document.getElementById('calendar');
    
    // Instancias Modales
    const modalNuevaReservaElement = document.getElementById('modalNuevaReserva');
    const modalNuevaReservaInstancia = modalNuevaReservaElement ? new bootstrap.Modal(modalNuevaReservaElement) : null;
    const formModalNuevaReserva = document.getElementById('formNuevaReservaModal');

    const modalGestionarElement = document.getElementById('modalGestionarReserva');
    const modalGestionarInstancia = modalGestionarElement ? new bootstrap.Modal(modalGestionarElement) : null;

    // Datos Globales
    const todosLosClientes = JSON.parse('{{ clientes_todos | tojson | safe }}');
    const todosLosServiciosActivos = JSON.parse('{{ servicios_todos_activos | tojson | safe }}');
    const todosLosEmpleadosParaSelector = JSON.parse('{{ empleados_para_selector | tojson | safe }}');

    let datosApiAgenda = null; 
    let datosReservaActualParaModal = null; 

    // Actualizar precio autom치ticamente al cambiar el servicio (Modo Edici칩n)
    const selectServicioEdit = document.getElementById('editServicioId');
    const inputPrecioEdit = document.getElementById('editPrecioCobrado');
    if (selectServicioEdit && inputPrecioEdit) {
        selectServicioEdit.addEventListener('change', function() {
            const idSeleccionado = this.value;
            const servicio = todosLosServiciosActivos.find(s => s.id == idSeleccionado);
            if (servicio) {
                inputPrecioEdit.value = parseFloat(servicio.precio).toFixed(2);
            }
        });
    }

    // 2. Funci칩n Fecha Local
    function setFechaLocal() {
        if (selectorFecha) { 
            const now = new Date();
            const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            selectorFecha.value = localDate.toISOString().slice(0,10); 
        }
    }
    if (!selectorFecha.value) setFechaLocal();

    // 3. Inicializar FullCalendar
    const calendar = new FullCalendar.Calendar(agendaContainer, {
        schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
        initialView: 'resourceTimeGridDay',
        locale: 'es',
        headerToolbar: false,
        height: 'auto',
        allDaySlot: false,
        slotDuration: '00:15:00',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        slotLabelInterval: '01:00',
        nowIndicator: true,
        editable: true,
        droppable: true,
        selectable: false, // Usamos dateClick customizado, no la selecci칩n nativa visual
        slotLabelFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short', omitZeroMinute: false },
        eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },
        
        // Fuentes de Datos
        resources: function(fetchInfo, successCallback, failureCallback) {
            const sucursalId = selectorSucursal.value;
            if (!sucursalId) { successCallback([]); return; }
            fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                .then(res => res.json()).then(data => successCallback(data.recursos)).catch(err => failureCallback(err));
        },
        events: function(fetchInfo, successCallback, failureCallback) {
            const sucursalId = selectorSucursal.value;
            if (!sucursalId) { successCallback([]); return; }
            fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                .then(res => res.json()).then(data => {
                    datosApiAgenda = data;
                    successCallback(data.eventos);
                }).catch(err => failureCallback(err));
        },
        
        // A. Clic en espacio vac칤o
        dateClick: function(info) {
            if (!datosApiAgenda || !datosApiAgenda.eventos) return;

            const slotDT = new Date(info.dateStr).getTime();
            const colaboradorId = info.resource.id;

            // Validar Horario Habil (Color blanco o clase turno-disponible)
            const esHorarioHabil = datosApiAgenda.eventos.some(evento => 
                evento.resourceId == colaboradorId &&
                evento.display === 'background' &&
                (evento.backgroundColor === '#ffffff' || (evento.classNames && evento.classNames.includes('turno-disponible'))) &&
                new Date(evento.start).getTime() <= slotDT &&
                new Date(evento.end).getTime() > slotDT
            );

            // Validar Ausencia (Rojo)
            const enAusencia = datosApiAgenda.eventos.some(evento => 
                evento.resourceId == colaboradorId &&
                evento.display === 'background' &&
                evento.backgroundColor.includes('220, 53, 69') &&
                new Date(evento.start).getTime() <= slotDT &&
                new Date(evento.end).getTime() > slotDT
            );
            
            if (esHorarioHabil && !enAusencia) {
                const hora = info.dateStr.slice(11, 16);
                abrirModalNuevaReserva(info.resource.id, info.resource.title, info.dateStr.slice(0, 10), hora);
            } else {
                console.log("Clic en zona no disponible");
            }
        },
        
        // B. Clic en Evento
        eventClick: function(info) {
            if (info.event.id) abrirModalGestionarReserva(info.event.id);
        },

        // C. Arrastrar y Soltar
        eventDrop: function(info) {
            const reservaId = info.event.id;
            const nuevoInicio = info.event.start;
            const nuevoColaboradorId = info.event.getResources()[0].id;

            if (nuevoInicio < new Date()) {
                alert("No se puede mover una reserva al pasado.");
                info.revert(); return;
            }
            if (!confirm("쯉eguro que deseas mover esta reserva?")) {
                info.revert(); return;
            }
            
            fetch('/reservas/reagendar', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reserva_id: reservaId, nuevo_inicio: nuevoInicio.toISOString(), nuevo_colaborador_id: nuevoColaboradorId })
            })
            .then(res => res.json().then(d => ({ok: res.ok, data: d})))
            .then(result => {
                if (!result.ok) { alert(result.data.message); info.revert(); }
                else { actualizarAgenda(); }
            })
            .catch(err => { alert("Error de red."); info.revert(); });
        },
    });

    calendar.render();
    
    // --- 4. FUNCIONES AUXILIARES ---
    function actualizarAgenda() {
        calendar.refetchResources();
        calendar.refetchEvents();
        calendar.gotoDate(selectorFecha.value);
    }

    // --- 5. LISTENERS BOTONES DE FECHA ---
    document.getElementById('btnDiaAnterior').addEventListener('click', () => { 
        const d = new Date(selectorFecha.value + 'T00:00:00'); d.setDate(d.getDate() - 1); 
        selectorFecha.value = d.toISOString().slice(0,10); actualizarAgenda(); 
    });
    document.getElementById('btnDiaSiguiente').addEventListener('click', () => { 
        const d = new Date(selectorFecha.value + 'T00:00:00'); d.setDate(d.getDate() + 1); 
        selectorFecha.value = d.toISOString().slice(0,10); actualizarAgenda(); 
    });
    document.getElementById('btnHoy').addEventListener('click', () => { 
        setFechaLocal(); actualizarAgenda(); 
    });
    selectorFecha.addEventListener('change', actualizarAgenda);
    btnActualizar?.addEventListener('click', actualizarAgenda);

    // --- 6. GESTI칍N DE MODALES (Nueva / Editar) ---
    // (L칩gica id칠ntica a tu c칩digo original, resumida aqu칤 para brevedad)
    window.abrirModalNuevaReserva = function(empleadoId, empleadoNombre, fecha, hora) {
        formModalNuevaReserva.reset(); 
        document.getElementById('modalSucursalId').value = selectorSucursal.value; 
        document.getElementById('modalEmpleadoNombre').textContent = empleadoNombre;
        const fechaObj = new Date(fecha + 'T00:00:00');
        document.getElementById('modalFecha').textContent = fechaObj.toLocaleDateString('es-PE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('modalHoraInicio').textContent = hora;
        document.getElementById('modalEmpleadoId').value = empleadoId;
        document.getElementById('modalFechaHoraInicioFull').value = `${fecha}T${hora}`;
        document.getElementById('modalErrores').style.display = 'none';
        if (modalNuevaReservaInstancia) modalNuevaReservaInstancia.show();
    };

    formModalNuevaReserva?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const errDiv = document.getElementById('modalErrores');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        errDiv.style.display = 'none';
        
        fetch("{{ url_for('main.nueva_reserva') }}", { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(this))) })
        .then(res => res.json().then(d => ({ok: res.ok, data: d})))
        .then(res => {
            if (res.ok && res.data.success) { modalNuevaReservaInstancia.hide(); actualizarAgenda(); }
            else { errDiv.innerHTML = (res.data.errors || [res.data.message]).join('<br>'); errDiv.style.display = 'block'; }
        })
        .catch(err => { errDiv.innerHTML = `Error: ${err.message}`; errDiv.style.display = 'block'; })
        .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Reserva'; });
    });

    function abrirModalGestionarReserva(reservaId) {
        const modalTitle = document.getElementById('modalGestionarReservaLabel');
        const vistaDiv = document.getElementById('detalleReservaVista');
        const formEditar = document.getElementById('formEditarReservaModal');
        const btnEditar = document.getElementById('btnModalEditarReserva');
        const btnCancelar = document.getElementById('btnModalCancelarReserva');
        const btnCompletar = document.getElementById('btnModalCompletarReserva');
        const btnVenta = document.getElementById('btnModalRegistrarVenta');
        const btnCancelarEdicion = document.getElementById('btnModalCancelarEdicion');
        const btnGuardar = document.getElementById('btnModalGuardarCambios');

        function cambiarModo(modoVista, data = null) {
            if(vistaDiv) vistaDiv.style.display = modoVista ? 'block' : 'none';
            if(formEditar) formEditar.style.display = modoVista ? 'none' : 'block';
            
            let esFinal = false;
            let estadoActual = '';
            if (data) {
                estadoActual = data.estado || '';
                const estadosFinales = ['Completada', 'Cancelada', 'Cancelada por Cliente', 'Cancelada por Staff', 'No Asistio'];
                esFinal = estadosFinales.some(s => estadoActual.includes(s));
            } else { esFinal = true; }

            const mostrarAcciones = modoVista && !esFinal;
            if (btnEditar) btnEditar.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnCancelar) btnCancelar.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnCompletar) btnCompletar.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnVenta) btnVenta.style.display = (data && estadoActual === 'Completada') ? 'inline-block' : 'none';
            if (btnCancelarEdicion) btnCancelarEdicion.style.display = modoVista ? 'none' : 'inline-block';
            if (btnGuardar) btnGuardar.style.display = modoVista ? 'none' : 'inline-block';

            if (!modoVista && data) {
                 // L칩gica de poblado de formulario de edici칩n (igual a tu c칩digo original)
                 modalTitle.innerHTML = `<i class="fas fa-edit me-2"></i>Editando Reserva #${data.id}`;
                 document.getElementById('editReservaId').value = data.id;
                 const poblar = (id, items, val) => {
                     const s = document.getElementById(id); if(!s) return;
                     s.innerHTML = '<option value="">Sel...</option>';
                     items.forEach(i => s.add(new Option(i.nombres || i.nombre || i.razon_social_nombres, i.id)));
                     s.value = val;
                 };
                 poblar('editClienteId', todosLosClientes, data.cliente_id);
                 poblar('editEmpleadoId', todosLosEmpleadosParaSelector, data.empleado_id);
                 poblar('editServicioId', todosLosServiciosActivos, data.servicio_id);
                 if(document.getElementById('editFechaHoraInicio')) document.getElementById('editFechaHoraInicio').value = data.fecha_hora_inicio.slice(0, 16);
                 if(document.getElementById('editPrecioCobrado')) document.getElementById('editPrecioCobrado').value = data.precio_cobrado;
            }
        }
        
        cambiarModo(true);
        if(modalGestionarInstancia) modalGestionarInstancia.show();

        fetch(`/api/reservas/${reservaId}`)
            .then(r => r.json())
            .then(data => {
                datosReservaActualParaModal = data;
                if(modalTitle) modalTitle.innerHTML = `<i class="fas fa-calendar-check me-2"></i>Reserva #${data.id}`;
                if(vistaDiv) {
                    vistaDiv.innerHTML = `
                        <dl class="row">
                            <dt class="col-4">Estado</dt><dd class="col-8">${data.estado}</dd>
                            <dt class="col-4">Cliente</dt><dd class="col-8">${data.cliente_nombre_completo}</dd>
                            <dt class="col-4">Servicio</dt><dd class="col-8">${data.servicio_nombre}</dd>
                            <dt class="col-4">Hora</dt><dd class="col-8">${new Date(data.fecha_hora_inicio).toLocaleString()}</dd>
                        </dl>`;
                }
                if(btnVenta) btnVenta.href = `{{ url_for('main.nueva_venta') }}?reserva_id=${reservaId}`;
                cambiarModo(true, data);
            });

        if (btnEditar) btnEditar.onclick = () => cambiarModo(false, datosReservaActualParaModal);
        if (btnCancelarEdicion) btnCancelarEdicion.onclick = () => cambiarModo(true, datosReservaActualParaModal);
        
        // Listeners de Cancelar/Completar/Guardar (Iguales a tu c칩digo original)
        if (btnCancelar) btnCancelar.onclick = () => { 
             if(confirm('쮺ancelar?')) fetch(`/reservas/cancelar/${reservaId}`, {method:'POST'}).then(()=>{ modalGestionarInstancia.hide(); actualizarAgenda(); }); 
        };
        if (btnCompletar) btnCompletar.onclick = () => {
             if(confirm('쮺ompletar?')) fetch(`/api/reservas/${reservaId}/completar`, {method:'POST'}).then(()=>{ modalGestionarInstancia.hide(); actualizarAgenda(); });
        };
    }
    
    document.getElementById('formEditarReservaModal')?.addEventListener('submit', function(e) {
        e.preventDefault();
        fetch(`/reservas/editar/${datosReservaActualParaModal.id}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(this))) })
        .then(res => res.json()).then(d => { if(d.success){ modalGestionarInstancia.hide(); actualizarAgenda(); } else { alert(d.message); } });
    });

    // =========================================================
    // 游릭 MAGIA: EFECTO HOVER TIPO FRESHA
    // =========================================================
    
    // 1. Crear el elemento visual (la barrita) din치micamente
    // No lo ponemos en HTML est치tico para no ensuciar el DOM innecesariamente
    const indicadorDiv = document.createElement('div');
    indicadorDiv.id = 'indicadorHoraHover';
    
    // 2. Escuchar el movimiento del mouse sobre TODO el calendario
    // Usamos 'mousemove' para seguimiento fluido
    agendaContainer.addEventListener('mousemove', function(e) {
        
        // Detectamos el elemento real bajo el mouse
        // "pointer-events: none" en el indicador asegura que detectemos la celda debajo de 칠l
        const target = document.elementFromPoint(e.clientX, e.clientY);
        
        // Buscamos si el mouse est치 sobre una celda de tiempo (fc-timegrid-slot)
        // .fc-timegrid-slot-lane filtra para que no se active en los n칰meros de la hora a la izquierda
        const slot = target ? target.closest('.fc-timegrid-slot-lane') : null;

        if (slot) {
            // A. Si estamos en una celda nueva, movemos la barra all칤
            if (indicadorDiv.parentElement !== slot) {
                slot.appendChild(indicadorDiv); // Esto autom치ticamente lo quita del anterior
                indicadorDiv.style.display = 'flex';
            }

            // B. Calcular la hora exacta
            // Usamos la API de FullCalendar para traducir coordenadas a fecha
            const dateClick = calendar.getDateFromPoint(e.clientX, e.clientY);
            
            if (dateClick) {
                const horaStr = dateClick.toLocaleTimeString('es-PE', {
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true 
                });
                
                // Agregamos un '+' para incitar a la acci칩n de crear
                indicadorDiv.innerHTML = `<i class="fas fa-plus me-2"></i> ${horaStr}`;
            }
        } else {
            // Si el mouse sale de las celdas (va al header, o fuera del calendario)
            indicadorDiv.style.display = 'none';
        }
    });

    // 3. Limpieza al salir del componente
    agendaContainer.addEventListener('mouseleave', function() {
        indicadorDiv.style.display = 'none';
    });

});
</script>
{% endblock scripts %}