{% extends "base.html" %}

{% block title %}Agenda Diaria de Citas - JV Studio{% endblock %}

{% block head_extra %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    /* Correcci칩n Select2 en Modales (z-index) */
    .select2-container--open {
        z-index: 9999999 !important;
    }

    .select2-container--bootstrap-5 .select2-dropdown .select2-results__options .select2-results__option {
        color: #000;
        font-size: 0.9rem;
        background-color: #ffffff;
    }

    .select2-container--bootstrap-5 .select2-selection {
        background-color: #ffffff !important;
        color: #000 !important;
    }

    .select2-container--bootstrap-5 .select2-selection__rendered {
        color: #000 !important;
    }
</style>

<style>
    /* --- 1. Contenedor Principal --- */
    #calendar {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        /* padding: 10px;  <-- QUITAMOS el padding interno para que el scroll llegue al borde */
        padding: 0;
        background-color: #ffffff;

        /* CAMBIO CLAVE: Altura din치mica */
        /* 100vh es el alto total de la pantalla. Le restamos aprox 250px 
        (que es lo que ocupan tu barra negra superior + los controles de filtros) */
        /*height: calc(100vh - 250px); */

        /* Esto es vital: */
        /*overflow: hidden; */
        min-height: 500px;
        /* Solo por seguridad si falla el JS */
        overflow: hidden;
        /* Mantiene bordes redondeados */
    }

    /* Opcional: Asegurar que el scroll interno se vea elegante */
    .fc-scroller::-webkit-scrollbar {
        width: 8px;
    }

    .fc-scroller::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
    }

    /* Barra de Herramientas */
    #controlesAgenda {
        background-color: #212529;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* --- ESTILOS PARA AVATAR EN CABECERA (TIPO FRESHA) --- */

    .staff-header-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px 0;
        width: 100%;
        /* Asegura que ocupe la celda */
    }

    .staff-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        /* C칤rculo perfecto */
        object-fit: cover;
        /* Evita que la foto se estire */
        margin-bottom: 8px;
        border: 2px solid #ffffff;
        /* Anillo blanco alrededor */
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        /* Sombra suave */
        background-color: #f3f4f6;
    }

    /* Estilo para cuando NO hay foto (Iniciales) */
    .staff-initials {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6c63ff 0%, #5a52d6 100%);
        /* Tu color morado */
        color: white;
        font-size: 1.2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        border: 2px solid #ffffff;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        text-transform: uppercase;
    }

    .staff-name {
        font-size: 0.9rem;
        font-weight: 700;
        color: #1f2937;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* --- 2. ESTILO TIPO "FRESHA" (FullCalendar) --- */

    /* A. FONDO RAYADO BASE (Ahora usa la variable de Bloqueo) */
    .fc-timegrid-col {
        background-color: var(--agenda-bg-bloqueo) !important;
        /* Patr칩n rayado OSCURO (Sombra suave) para que se vea sobre colores claros */
        background-image: repeating-linear-gradient(45deg,
                rgba(0, 0, 0, 0.03),
                rgba(0, 0, 0, 0.03) 2px,
                transparent 2px,
                transparent 10px) !important;
    }

    /* B. CELDAS PRINCIPALES (SLOTS) */
    /* CR칈TICO: position relative hace que la barra hover se limite al ancho de la columna */
    .fc-timegrid-slot {
        position: relative !important;
        z-index: 1;
        /* L칤neas muy suaves */
    }

    /* 2.1 CSS VARIABLES GLOBALES (Default) */
    :root {
        --agenda-slot-duration: '00:15:00';
        --agenda-bg-bloqueo: #ffecec;
        /* Rojo muy suave por defecto */
        --agenda-bg-habilitado: #ffffff;
        --agenda-bg-reserva: #6c63ff;
        --agenda-bg-completado: #198754;

        /* Color de texto calculado simple (blanco para oscuros, negro para claros) */
        --agenda-txt-reserva: #ffffff;
    }

    /* APLICACI칍N DE VARIABLES A CLASES EXISTENTES */

    /* 1. BLOQUEOS (Background Events - Ausencias) */
    /* Deben ser ID칄NTICOS al fondo base (.fc-timegrid-col) para que parezcan "huecos" */
    .fc-bg-event.bg-danger-subtle {
        background-color: var(--agenda-bg-bloqueo) !important;
        background-image: repeating-linear-gradient(45deg,
                rgba(0, 0, 0, 0.03),
                rgba(0, 0, 0, 0.03) 2px,
                transparent 2px,
                transparent 10px) !important;
        opacity: 1 !important;
    }

    /* 2. TURNOS HABILITADOS (Background Events) - "Available" */
    .fc-bg-event.turno-disponible {
        background-color: var(--agenda-bg-habilitado) !important;
        opacity: 1 !important;
    }

    /* 3. CITAS / RESERVAS (Foreground Events) */
    /* Usamos selectores m치s espec칤ficos para NO afectar a los background events */
    .fc-timegrid-event,
    .fc-daygrid-event,
    .fc-v-event {
        background-color: var(--agenda-bg-reserva) !important;
        border-color: var(--agenda-bg-reserva) !important;
        color: var(--agenda-txt-reserva) !important;
    }

    /* 3.1 Citas Completadas */
    .fc-timegrid-event.reserva-completada,
    .fc-v-event.reserva-completada {
        background-color: var(--agenda-bg-completado) !important;
        border-color: var(--agenda-bg-completado) !important;
    }

    /* HORA (Axis) - FONDO BLANCO SOLICITADO */
    .fc .fc-timegrid-slot-label {
        background-color: #ffffff !important;
        color: #333;
        font-weight: 600;
        border-right: 1px solid #e5e7eb;
    }

    /* C. FONDO BLANCO PARA TURNOS DISPONIBLES 
       (Esto normalmente lo maneja FullCalendar con eventos de fondo, 
       pero aseguramos que no tapen la barra hover con z-index) */
    .fc-bg-event {
        opacity: 1.0 !important;
        z-index: 2 !important;
        /* Nivel intermedio */
    }

    /* D. HEADER Y TEXTOS */
    .fc-col-header-cell {
        background-color: #ffffff !important;
        border-bottom: 2px solid #e5e7eb !important;
        vertical-align: middle;
    }

    .fc-col-header-cell-cushion {
        color: #111827 !important;
        font-weight: 700 !important;
        text-transform: uppercase;
        font-size: 0.9rem;
        padding: 15px 0 !important;
    }

    .fc-timegrid-slot-label-cushion {
        color: #6b7280 !important;
        font-size: 0.85em;
        font-weight: 600;
    }

    .fc-theme-standard td,
    .fc-theme-standard th {
        border-color: #ffffff !important;
    }

    /* E. TARJETAS DE CITAS (EVENTOS) */
    .fc-event {
        border: none !important;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin: 1px 2px !important;
        z-index: 50 !important;
        /* Siempre encima de todo */
    }

    .fc-event-main {
        color: #ffffff !important;
        font-weight: 600;
        padding: 2px 4px;
        font-size: 0.85rem;
    }

    /* INDICADOR DE HORA ACTUAL (L칤nea Roja) */
    .fc-timegrid-now-indicator-line {
        border-color: #ef4444;
        border-width: 2px;
        z-index: 51;
    }

    .fc-timegrid-now-indicator-arrow {
        border-color: #ef4444;
        z-index: 51;
    }

    .fc-day-today {
        background-color: transparent !important;
    }

    /* --- CORRECCIONES VISUALES --- */
    .fc .fc-timegrid-axis-cushion,
    .fc .fc-timegrid-axis-frame,
    .fc .fc-timegrid-axis {
        background-color: #ffffff !important;
    }

    .fc-theme-standard .fc-scrollgrid {
        border-color: #e5e7eb;
    }

    /* =========================================
       NUEVO: EFECTO HOVER TIPO FRESHA 
       ========================================= */
    /* 1. La barra flotante */
    #indicadorHoraHover {
        position: absolute;
        left: 0;
        right: 0;
        min-height: 20px;
        background-color: rgba(108, 99, 255, 0.25);
        border-left: 4px solid #5a52d6;
        color: #5a52d6;
        font-size: 0.8rem;
        /* Un poco m치s peque침o para que quepa bien */
        font-weight: 800;

        /* ALINEACI칍N SUPERIOR IZQUIERDA */
        display: none;
        /* Se activa con JS */
        flex-direction: row;
        align-items: flex-start;
        /* Alinea al TOP */
        justify-content: flex-start;
        /* Alinea a la IZQUIERDA */
        padding-top: 2px;
        /* Espacio desde arriba */
        padding-left: 6px;
        /* Espacio desde la izquierda */

        pointer-events: none;
        z-index: 1000;
        border-radius: 2px;
    }

    /* 2. IMPORTANTE: Quitamos el position relative de los slots horizontales
    para evitar conflictos de apilamiento */
    .fc-timegrid-slot {
        position: static !important;
        z-index: auto !important;
    }

    /* 3. Aseguramos que las COLUMNAS sean el referente relativo */
    .fc-timegrid-col {
        position: relative !important;
    }
</style>
{% endblock head_extra %}

{% block content %}
<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: var(--color-acento-dorado);"><i class="fas fa-calendar-day me-2"></i>Agenda Diaria</h2>
        <span class="badge bg-warning text-dark fs-6 shadow-sm">
            <i class="fas fa-map-marker-alt me-2"></i>Sucursal: {{ session.get('sucursal_nombre', 'Actual') }}
        </span>
    </div>

    <div id="controlesAgenda" class="d-flex flex-wrap align-items-center gap-3 p-3 rounded mb-4"
        style="background-color: #3a3a3a;">

        <input type="hidden" id="selectorSucursalAgenda" value="{{ session.get('sucursal_id') }}">

        <div class="ms-md-3">
            <label for="selectorFechaAgenda" class="form-label text-light small fw-bold">Fecha:</label>
            <div class="d-flex align-items-center">
                <button id="btnDiaAnterior" class="btn btn-outline-light btn-sm"><i
                        class="fas fa-chevron-left"></i></button>
                <input type="date" id="selectorFechaAgenda"
                    class="form-control form-control-sm mx-1 fw-bold text-center" style="width: 140px;">
                <button id="btnDiaSiguiente" class="btn btn-outline-light btn-sm"><i
                        class="fas fa-chevron-right"></i></button>
                <button id="btnHoy" class="btn btn-warning btn-sm ms-2 fw-bold text-dark"><i
                        class="fas fa-calendar-day me-1"></i> Hoy</button>
            </div>
        </div>

        <div class="ms-md-3 mt-2 mt-md-0 position-relative ms-auto">
            <label class="form-label text-light small fw-bold mb-1">Filtrar Colaboradores:</label>
            <div class="dropdown">
                <button
                    class="btn btn-light btn-sm dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center"
                    type="button" id="dropdownFiltroColaboradores" data-bs-toggle="dropdown" aria-expanded="false"
                    style="min-width: 280px; font-size: 0.9rem;">
                    <span><i class="fas fa-users me-2"></i>Seleccionar Equipo</span>
                </button>
                <div class="dropdown-menu p-2 shadow-lg" aria-labelledby="dropdownFiltroColaboradores"
                    style="width: 320px; max-height: 400px; overflow-y: auto;">

                    <!-- Grupos R치pidos -->
                    <div class="mb-2 pb-2 border-bottom">
                        <div class="form-check p-2 hover-bg-light rounded cursor-pointer"
                            onclick="toggleGrupo('citas')">
                            <input class="form-check-input" type="radio" name="grupoFiltro" id="radioConCitas" checked>
                            <label class="form-check-label w-100 cursor-pointer fw-bold text-primary"
                                for="radioConCitas">
                                <i class="fas fa-calendar-check me-2"></i>Miembros del equipo con citas
                            </label>
                        </div>
                        <div class="form-check p-2 hover-bg-light rounded cursor-pointer"
                            onclick="toggleGrupo('todos')">
                            <input class="form-check-input" type="radio" name="grupoFiltro" id="radioTodos">
                            <label class="form-check-label w-100 cursor-pointer fw-bold text-dark" for="radioTodos">
                                <i class="fas fa-users me-2"></i>Todo el equipo
                            </label>
                        </div>
                    </div>

                    <!-- Lista Individual -->
                    <div class="px-2 mb-2 d-flex justify-content-between align-items-center">
                        <small class="text-muted fw-bold text-uppercase" style="font-size: 0.75rem;">Individual</small>
                        <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none"
                            style="font-size: 0.8rem;" onclick="limpiarSeleccion()">Limpiar</button>
                    </div>

                    <div id="listaColaboradoresFiltro">
                        {% if not empleados_para_selector %}
                        <div class="text-center text-muted small py-2">No hay colaboradores disponibles</div>
                        {% else %}
                        {% for emp in empleados_para_selector %}
                        <div class="form-check p-1 ms-1">
                            <!-- data-citas-hoy ser치 1 o 0 (true/false) desde backend -->
                            <input class="form-check-input chk-colaborador" type="checkbox" value="{{ emp.id }}"
                                id="chk_colab_{{ emp.id }}" data-citas-hoy="{{ emp.citas_hoy }}" {% if emp.tiene_turno
                                %}checked{% endif %}>
                            <!-- Por defecto checkeamos si tiene turno -->
                            <label class="form-check-label d-flex align-items-center w-100"
                                for="chk_colab_{{ emp.id }}">
                                {% if emp.foto %}
                                <img src="{{ emp.foto }}" class="rounded-circle me-2" width="24" height="24">
                                {% else %}
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
                                    style="width: 24px; height: 24px; font-size: 0.7rem;">
                                    {{ emp.nombres[0] }}{{ emp.apellidos[0] }}
                                </div>
                                {% endif %}
                                <span>{{ emp.nombres }} {{ emp.apellidos }}</span>
                                {% if emp.citas_hoy > 0 %}
                                <span class="badge bg-success ms-auto rounded-pill" style="font-size: 0.7em;">With
                                    Appts</span>
                                {% endif %}
                            </label>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot칩n Configuraci칩n (A la derecha) -->
        <div>
            <label class="form-label text-light small fw-bold mb-1" style="visibility: hidden;">Conf</label>
            <button class="btn btn-dark border border-secondary" type="button" data-bs-toggle="modal"
                data-bs-target="#modalConfiguracionAgenda" title="Configuraci칩n de Vista">
                <i class="fas fa-cog"></i>
            </button>
        </div>


    </div>

    <div id='calendar' class="mt-4 shadow-lg"></div>

    {% include 'reservas/_modal_nueva_reserva.html' %}
    {% include 'reservas/_modal_gestionar_reserva.html' %}
    {% include 'reservas/_modal_bloqueo_agenda.html' %}
    {% include 'reservas/_modal_bloqueo_agenda.html' %}
    {% include 'reservas/_modal_habilitar_extra.html' %}
    {% include 'reservas/_modal_configuracion_agenda.html' %}
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 游릭 INICIALIZAR SELECT2 PARA CLIENTES (B칰squeda Avanzada)
        $('#modalClienteId').select2({
            theme: 'bootstrap-5',
            dropdownParent: $('#modalNuevaReserva'),
            placeholder: 'Buscar Cliente (Nombre, DNI, Tel)...',
            width: '100%',
            allowClear: true,
            language: {
                noResults: function () {
                    return "No encontrado. <a href='/clientes/nuevo' target='_blank'>Crear Nuevo</a>";
                }
            },
            escapeMarkup: function (markup) { return markup; }
        });
        // 1. Selectores
        const selectorSucursal = document.getElementById('selectorSucursalAgenda');
        const selectorFecha = document.getElementById('selectorFechaAgenda');
        const btnActualizar = document.getElementById('btnActualizarAgenda');
        const agendaContainer = document.getElementById('calendar');

        // Instancias Modales
        const modalNuevaReservaElement = document.getElementById('modalNuevaReserva');
        const modalNuevaReservaInstancia = modalNuevaReservaElement ? new bootstrap.Modal(modalNuevaReservaElement) : null;
        const formModalNuevaReserva = document.getElementById('formNuevaReservaModal');

        const modalGestionarElement = document.getElementById('modalGestionarReserva');
        const modalGestionarInstancia = modalGestionarElement ? new bootstrap.Modal(modalGestionarElement) : null;

        const modalBloqueoElement = document.getElementById('modalBloqueoAgenda');
        const modalBloqueoInstancia = modalBloqueoElement ? new bootstrap.Modal(modalBloqueoElement) : null;
        const formBloqueo = document.getElementById('formBloqueoAgenda');

        const modalHabilitarElement = document.getElementById('modalHabilitarExtra');
        const modalHabilitarInstancia = modalHabilitarElement ? new bootstrap.Modal(modalHabilitarElement) : null;
        const formHabilitar = document.getElementById('formHabilitarExtra');

        // Datos Globales
        const todosLosClientes = JSON.parse('{{ clientes_todos | tojson | safe }}');
        const todosLosServiciosActivos = JSON.parse('{{ servicios_todos_activos | tojson | safe }}');
        const todosLosEmpleadosParaSelector = JSON.parse('{{ empleados_para_selector | tojson | safe }}');

        let datosApiAgenda = null;
        let datosReservaActualParaModal = null;

        // Actualizar precio autom치ticamente al cambiar el servicio (Modo Edici칩n)
        const selectServicioEdit = document.getElementById('editServicioId');
        const inputPrecioEdit = document.getElementById('editPrecioCobrado');
        if (selectServicioEdit && inputPrecioEdit) {
            selectServicioEdit.addEventListener('change', function () {
                const idSeleccionado = this.value;
                const servicio = todosLosServiciosActivos.find(s => s.id == idSeleccionado);
                if (servicio) {
                    inputPrecioEdit.value = parseFloat(servicio.precio).toFixed(2);
                }
            });
        }

        // 2. Funci칩n Fecha Local
        function setFechaLocal() {
            if (selectorFecha) {
                const now = new Date();
                const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
                selectorFecha.value = localDate.toISOString().slice(0, 10);
            }
        }
        if (!selectorFecha.value) setFechaLocal();

        // 3. Inicializar FullCalendar
        let resetFilterOnNextLoad = false; // Bandera para saber si debemos resetear los checks al cambiar de fecha
        let calendar = null; // Variable global para instancia

        // 游릭 CONFIGURACI칍N & STORAGE (DB)
        // DEFINICI칍N INICIAL DE CONFIGURACI칍N
        // Se sobrescribe con serverConfig abajo

        // Configuraci칩n Inicial desde el Servidor (S칤ncrono/Inmediato)
        // Esto evita que el calendario cargue con defaults mientras espera el fetch
        const serverConfig = {
            agenda_intervalo: "{{ config_sucursal.agenda_intervalo if config_sucursal and config_sucursal.agenda_intervalo else '00:15:00' }}",
            agenda_color_bloqueo: "{{ config_sucursal.agenda_color_bloqueo if config_sucursal else '#ffecec' }}",
            agenda_color_habilitado: "{{ config_sucursal.agenda_color_habilitado if config_sucursal else '#ffffff' }}",
            agenda_color_reserva: "{{ config_sucursal.agenda_color_reserva if config_sucursal else '#6c63ff' }}",
            agenda_color_completado: "{{ config_sucursal.agenda_color_completado if config_sucursal else '#198754' }}",
            app_fuente: "{{ config_sucursal.app_fuente if config_sucursal else 'Inter' }}"
        };

        // Inicializamos con esto
        let currentConfig = serverConfig;

        // Aplicar estilos inmediatamente
        function applyStyles(config) {
            const root = document.documentElement;
            if (config.agenda_color_bloqueo) root.style.setProperty('--agenda-bg-bloqueo', config.agenda_color_bloqueo);
            if (config.agenda_color_reserva) root.style.setProperty('--agenda-bg-reserva', config.agenda_color_reserva);
            if (config.agenda_color_completado) root.style.setProperty('--agenda-bg-completado', config.agenda_color_completado);
            if (config.agenda_color_habilitado) root.style.setProperty('--agenda-bg-habilitado', config.agenda_color_habilitado);
            if (config.app_fuente) root.style.setProperty('--font-primary', `'${config.app_fuente}', sans-serif`);
        }

        // Llamadas iniciales
        applyStyles(currentConfig);

        function populateModalConfig(config) {
            if (document.getElementById('cfgIntervalo')) document.getElementById('cfgIntervalo').value = config.agenda_intervalo;
            if (document.getElementById('cfgColorBloqueo')) document.getElementById('cfgColorBloqueo').value = config.agenda_color_bloqueo;
            if (document.getElementById('cfgColorHabilitado')) document.getElementById('cfgColorHabilitado').value = config.agenda_color_habilitado;
            if (document.getElementById('cfgColorReserva')) document.getElementById('cfgColorReserva').value = config.agenda_color_reserva;
            if (document.getElementById('cfgColorCompletado')) document.getElementById('cfgColorCompletado').value = config.agenda_color_completado;
            if (document.getElementById('configAppFuente')) document.getElementById('configAppFuente').value = config.app_fuente || 'Inter';
        }

        // Inicializar modal con datos actuales
        populateModalConfig(currentConfig);

        // Iniciar calendario (La funci칩n initCalendar est치 definida mas abajo)
        // Usamos un peque침o timeout 0 para asegurar que el resto del DOM (si hay algo pendiente) est칠 listo
        setTimeout(initCalendar, 0);

        // Ya no necesitamos esperar al fetch para iniciar, pero lo llamamos para "refrescar" si algo cambi칩
        // o simplemente usamos el serverConfig.

        // Listener Formulario Configuraci칩n
        document.getElementById('formConfigAgenda')?.addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            const payload = {
                agenda_intervalo: document.getElementById('cfgIntervalo').value,
                agenda_color_bloqueo: document.getElementById('cfgColorBloqueo').value,
                agenda_color_habilitado: document.getElementById('cfgColorHabilitado').value,
                agenda_color_reserva: document.getElementById('cfgColorReserva').value,
                agenda_color_completado: document.getElementById('cfgColorCompletado').value,
                app_fuente: document.getElementById('configAppFuente').value
            };

            fetch('/api/configuracion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Configuraci칩n guardada.');
                        location.reload(); // Recargar para aplicar cambios profundos (FullCalendar slotDuration a veces requiere rebuild total)
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(err => alert('Error de red'))
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
        });

        // Restaurar Default
        document.getElementById('btnResetConfig')?.addEventListener('click', function () {
            if (confirm('Restaurar valores por defecto?')) {
                document.getElementById('cfgIntervalo').value = '00:15:00';
                document.getElementById('cfgColorBloqueo').value = '#ffecec';
                document.getElementById('cfgColorHabilitado').value = '#ffffff';
                document.getElementById('cfgColorReserva').value = '#6c63ff';
                document.getElementById('cfgColorCompletado').value = '#198754';
                document.getElementById('configAppFuente').value = 'Inter';
            }
        });

        function initCalendar() {
            // DEBUG: Ver qu칠 valor est치 llegando realmente
            console.log("Config actual:", currentConfig);
            // alert("DEBUG: Intervalo cargado...");

            // Destruir si existe para recrear con nueva duraci칩n
            if (calendar) calendar.destroy();

            calendar = new FullCalendar.Calendar(agendaContainer, {
                schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
                initialView: 'resourceTimeGridDay',
                locale: 'es',
                headerToolbar: false,
                height: 'calc(100vh - 190px)',
                allDaySlot: false,
                allDaySlot: false,
                // PRUEBA DE FUEGO: FORZAR 5 MINUTOS
                slotDuration: '00:05:00', // currentConfig.agenda_intervalo ? currentConfig.agenda_intervalo : '00:15:00',

                // Forzar etiquetas de hora cada hora para limpieza visual si el slot es muy peque침o
                slotLabelInterval: '01:00',

                // 游릭 CONFIGURACI칍N DE IM츼GENES DE COLABORADORES
                resourceLabelContent: function (arg) {
                    const recurso = arg.resource;
                    const props = recurso.extendedProps || {};
                    const imagenUrl = props.imagen_url || props.foto || null;
                    const nombre = recurso.title;

                    // 1. Crear el contenedor
                    const container = document.createElement('div');
                    container.className = 'staff-header-container';

                    // 2. L칩gica de Imagen vs Iniciales
                    if (imagenUrl) {
                        const img = document.createElement('img');
                        img.src = imagenUrl;
                        img.className = 'staff-avatar';

                        // Si la imagen falla al cargar, mostramos las iniciales
                        img.onerror = function () {
                            this.style.display = 'none';
                            container.insertBefore(crearIniciales(nombre), container.firstChild);
                        };
                        container.appendChild(img);
                    }

                    // 2.A MEN칔 GESTIONAR HORARIO (Dropdown)
                    const menuDiv = document.createElement('div');
                    menuDiv.className = 'dropdown position-absolute end-0 top-0 mt-1 me-1';
                    menuDiv.innerHTML = `
                    <button class="btn btn-sm btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu shadow-sm" style="font-size: 0.85rem; z-index: 9999;">
                         <li><h6 class="dropdown-header">Gestionar Disponibilidad</h6></li>
                         <li><a class="dropdown-item text-danger" href="#" onclick="bloquearHorarioColab(${recurso.id}, '${nombre}')"><i class="fas fa-ban me-2"></i>Bloquear Horas</a></li>
                         <li><a class="dropdown-item text-success" href="#" onclick="habilitarHorarioColab(${recurso.id}, '${nombre}')"><i class="fas fa-check-circle me-2"></i>Habilitar Extra</a></li>
                    </ul>
                `;
                    container.appendChild(menuDiv);

                    // Aseguramos position relative al container
                    container.style.position = 'relative';

                    // 2. Si no hay imagen, mostrar iniciales
                    if (!imagenUrl) {
                        container.appendChild(crearIniciales(nombre));
                    }

                    // 3. Agregar el Nombre (ESTO FALTABA)
                    const nombreSpan = document.createElement('span');
                    nombreSpan.className = 'staff-name';
                    nombreSpan.innerText = nombre;
                    container.appendChild(nombreSpan);

                    // 4. Devolver el DOM al calendario
                    return { domNodes: [container] };
                },

                slotDuration: '00:15:00',
                slotMinTime: '08:00:00',
                slotMaxTime: '22:00:00',
                slotLabelInterval: '01:00',
                stickyHeaderDates: true,
                nowIndicator: true,
                editable: true,
                droppable: true,
                selectable: false, // Usamos dateClick customizado, no la selecci칩n nativa visual
                slotLabelFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short', omitZeroMinute: false, hour12: true },
                eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short', hour12: true },

                // Re-aplicar clases para eventos completados din치micos
                eventClassNames: function (arg) {
                    if (arg.event.extendedProps.estado === 'Completada') {
                        return ['reserva-completada'];
                    }
                    return [];
                },

                // Fuentes de Datos
                resources: function (fetchInfo, successCallback, failureCallback) {
                    const sucursalId = selectorSucursal.value;
                    if (!sucursalId) { successCallback([]); return; }

                    // 游릭 L칍GICA DE FILTRADO LADO CLIENTE
                    fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                        .then(res => res.json())
                        .then(data => {
                            let todosRecursos = data.recursos;

                            // 游릭 NUEVO: Si cambiamos de fecha, reseteamos los checks seg칰n "tiene_turno"
                            if (resetFilterOnNextLoad) {
                                document.querySelectorAll('.chk-colaborador').forEach(chk => {
                                    // Buscamos el recurso correspondiente en la data fresca
                                    const rec = todosRecursos.find(r => r.id == chk.value);
                                    if (rec) {
                                        chk.checked = rec.tiene_turno;
                                        // Actualizamos el dato de citas para el filtro "Con Citas"
                                        chk.dataset.citasHoy = rec.citas_hoy;
                                    }
                                });
                                // Limpiamos la bandera
                                resetFilterOnNextLoad = false;

                                // Reset radios visuales
                                if (document.getElementById('radioConCitas')) document.getElementById('radioConCitas').checked = false;
                                if (document.getElementById('radioTodos')) document.getElementById('radioTodos').checked = false;
                            }

                            // Obtenemos los IDs marcados en los checkboxes
                            const checksMarcados = Array.from(document.querySelectorAll('.chk-colaborador:checked')).map(c => parseInt(c.value));

                            // Filtramos: Solo devolvemos los recursos cuyo ID est칠 en los checks marcados
                            // Si es la carga inicial y no hay checks (aunque el HTML server-side ya los pone), mostramos todo por seguridad o nada.
                            // Como el HTML viene con checked, deber칤a funcionar.

                            const recursosFiltrados = todosRecursos.filter(r => checksMarcados.includes(r.id));

                            successCallback(recursosFiltrados);
                        })
                        .catch(err => failureCallback(err));
                },
                events: function (fetchInfo, successCallback, failureCallback) {
                    const sucursalId = selectorSucursal.value;
                    if (!sucursalId) { successCallback([]); return; }
                    fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                        .then(res => res.json()).then(data => {
                            datosApiAgenda = data;
                            successCallback(data.eventos);
                        }).catch(err => failureCallback(err));
                },

                // A. Clic en espacio vac칤o
                dateClick: function (info) {
                    if (!datosApiAgenda || !datosApiAgenda.eventos) return;

                    const slotDT = new Date(info.dateStr).getTime();
                    const colaboradorId = info.resource.id;

                    // 1. Validar Horario Habil
                    // Ahora confiamos en la CLASE 'turno-disponible' que asigna el backend y CSS
                    const esHorarioHabil = datosApiAgenda.eventos.some(evento =>
                        evento.resourceId == colaboradorId &&
                        evento.display === 'background' &&
                        evento.classNames && evento.classNames.includes('turno-disponible') &&
                        new Date(evento.start).getTime() <= slotDT &&
                        new Date(evento.end).getTime() > slotDT
                    );

                    // 2. Validar que NO sea Ausencia (Checked by NOT having turno-disponible usually, or explicit check)
                    // Las ausencias tienen 'bg-danger-subtle'
                    const enAusencia = datosApiAgenda.eventos.some(evento =>
                        evento.resourceId == colaboradorId &&
                        evento.display === 'background' &&
                        evento.classNames && evento.classNames.includes('bg-danger-subtle') &&
                        new Date(evento.start).getTime() <= slotDT &&
                        new Date(evento.end).getTime() > slotDT
                    );

                    if (esHorarioHabil && !enAusencia) {
                        const hora = info.dateStr.slice(11, 16);
                        abrirModalNuevaReserva(info.resource.id, info.resource.title, info.dateStr.slice(0, 10), hora);
                    } else {
                        console.log("Clic en zona no disponible (Sin turno o Ausente)");
                    }
                },

                // B. Clic en Evento
                eventClick: function (info) {
                    if (info.event.id) abrirModalGestionarReserva(info.event.id);
                },

                // C. Arrastrar y Soltar
                eventDrop: function (info) {
                    const reservaId = info.event.id;
                    const nuevoInicio = info.event.start;
                    const nuevoColaboradorId = info.event.getResources()[0].id;

                    if (nuevoInicio < new Date()) {
                        alert("No se puede mover una reserva al pasado.");
                        info.revert(); return;
                    }
                    if (!confirm("쯉eguro que deseas mover esta reserva?")) {
                        info.revert(); return;
                    }

                    fetch('/reservas/reagendar', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reserva_id: reservaId, nuevo_inicio: nuevoInicio.toISOString(), nuevo_colaborador_id: nuevoColaboradorId })
                    })
                        .then(res => res.json().then(d => ({ ok: res.ok, data: d })))
                        .then(result => {
                            if (!result.ok) { alert(result.data.message); info.revert(); }
                            else { actualizarAgenda(); }
                        })
                        .catch(err => { alert("Error de red."); info.revert(); });
                },
            });

            calendar.render();
        } // Fin initCalendar

        // Iniciar calendario por primera vez
        // Iniciar calendario por primera vez (Ahora via API)
        // loadConfigAndInit call removed - redundant/undefined

        // --- 4. FUNCIONES AUXILIARES ---
        function actualizarAgenda() {
            calendar.refetchResources();
            calendar.refetchEvents();
            if (selectorFecha.value) calendar.gotoDate(selectorFecha.value);
        }

        // --- 5. LISTENERS BOTONES DE FECHA ---
        document.getElementById('btnDiaAnterior').addEventListener('click', () => {
            const d = new Date(selectorFecha.value + 'T00:00:00'); d.setDate(d.getDate() - 1);
            selectorFecha.value = d.toISOString().slice(0, 10);
            resetFilterOnNextLoad = true; // 游릭 Resetear filtro
            actualizarAgenda();
        });
        document.getElementById('btnDiaSiguiente').addEventListener('click', () => {
            const d = new Date(selectorFecha.value + 'T00:00:00'); d.setDate(d.getDate() + 1);
            selectorFecha.value = d.toISOString().slice(0, 10);
            resetFilterOnNextLoad = true; // 游릭 Resetear filtro
            actualizarAgenda();
        });
        document.getElementById('btnHoy').addEventListener('click', () => {
            setFechaLocal();
            resetFilterOnNextLoad = true; // 游릭 Resetear filtro
            actualizarAgenda();
        });
        selectorFecha.addEventListener('change', () => {
            resetFilterOnNextLoad = true; // 游릭 Resetear filtro
            actualizarAgenda();
        });
        // btnActualizar REMOVED

        // --- 6. GESTI칍N DE MODALES (Nueva / Editar) ---
        // (L칩gica id칠ntica a tu c칩digo original, resumida aqu칤 para brevedad)
        window.abrirModalNuevaReserva = function (empleadoId, empleadoNombre, fecha, hora) {
            formModalNuevaReserva.reset();
            document.getElementById('modalSucursalId').value = selectorSucursal.value;
            document.getElementById('modalEmpleadoNombre').textContent = empleadoNombre;
            const fechaObj = new Date(fecha + 'T00:00:00');
            document.getElementById('modalFecha').textContent = fechaObj.toLocaleDateString('es-PE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('modalHoraInicio').textContent = hora;
            document.getElementById('modalEmpleadoId').value = empleadoId;
            document.getElementById('modalFechaHoraInicioFull').value = `${fecha}T${hora}`;
            document.getElementById('modalErrores').style.display = 'none';
            if (modalNuevaReservaInstancia) modalNuevaReservaInstancia.show();
        };

        formModalNuevaReserva?.addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            const errDiv = document.getElementById('modalErrores');

            // 1. Recopilar datos b치sicos del formulario
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            // 2. 游릭 AGREGAR VALOR DEL CHECKBOX (True/False)
            const chk = document.getElementById('chkEnviarWhatsApp');
            data.enviar_whatsapp = chk ? chk.checked : false;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            errDiv.style.display = 'none';

            // 3. Enviar al Backend
            fetch("{{ url_for('main.nueva_reserva') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => res.json().then(d => ({ ok: res.ok, data: d })))
                .then(res => {
                    if (res.ok && res.data.success) {
                        // A. Cerrar modal y refrescar calendario
                        modalNuevaReservaInstancia.hide();
                        actualizarAgenda();

                        // B. 游릭 L칍GICA DE WHATSAPP CLICK-TO-CHAT
                        if (res.data.whatsapp_url) {
                            // Si el backend devolvi칩 una URL, la abrimos en nueva pesta침a
                            window.open(res.data.whatsapp_url, '_blank');
                        } else if (data.enviar_whatsapp) {
                            // Si el usuario marc칩 el check pero no hubo URL (ej: cliente sin tel칠fono)
                            alert("Reserva guardada correctamente, pero no se pudo generar el enlace de WhatsApp (verifique que el cliente tenga tel칠fono registrado).");
                        }
                    }
                    else {
                        // C. Mostrar errores del servidor
                        errDiv.innerHTML = (res.data.errors || [res.data.message]).join('<br>');
                        errDiv.style.display = 'block';
                    }
                })
                .catch(err => {
                    errDiv.innerHTML = `Error de conexi칩n: ${err.message}`;
                    errDiv.style.display = 'block';
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Reserva';
                });
        });

        // 游릭 NUEVAS FUNCIONES PARA FILTRO Y DISPONIBILIDAD

        // A. L칩gica de Filtro Avanzado
        window.toggleGrupo = function (grupo) {
            const checks = document.querySelectorAll('.chk-colaborador');
            checks.forEach(chk => {
                if (grupo === 'todos') {
                    chk.checked = true;
                } else if (grupo === 'citas') {
                    // Usamos el atributo data-citas-hoy que inyectamos desde jinja
                    chk.checked = (chk.dataset.citasHoy == "1" || chk.dataset.citasHoy == "true" || parseInt(chk.dataset.citasHoy) > 0);
                }
            });
            actualizarAgenda(); // Refresca FullCalendar
        };

        window.limpiarSeleccion = function () {
            document.querySelectorAll('.chk-colaborador').forEach(c => c.checked = false);
            // Deseleccionar radios visualmente para evitar confusi칩n
            document.getElementById('radioConCitas').checked = false;
            document.getElementById('radioTodos').checked = false;
            actualizarAgenda();
        };

        // Evento cambio individual
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('chk-colaborador')) {
                // Si alguien toca un check manual, desmarcamos los radios de grupo para indicar "Personalizado"
                document.getElementById('radioConCitas').checked = false;
                document.getElementById('radioTodos').checked = false;
                actualizarAgenda();
            }
        });

        // B. L칩gica de Disponibilidad (Bloquear / Habilitar)
        window.bloquearHorarioColab = function (empleadoId, nombre) {
            // 1. Resetear form
            formBloqueo.reset();

            // 2. Pre-llenar datos
            document.getElementById('bloqueoEmpleadoId').value = empleadoId;
            document.getElementById('bloqueoEmpleadoNombre').value = nombre;
            document.getElementById('bloqueoFecha').value = selectorFecha.value;

            // Hora por defecto (hora actual redondeada o fija)
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = "00";
            document.getElementById('bloqueoHoraInicio').value = `${h}:${m}`;

            // Trigger cambio tipo para resetear estados (Personalizado por defecto)
            toggleTipoBloqueo('Personalizado');
            // Esto tambi칠n calcular치 la hora fin si llamamos a actualizar, 
            // o podemos dejar vac칤o para que el usuario llene.
            // Mejor: Setear 1 hora mas tarde.
            const h2 = String((now.getHours() + 1) % 24).padStart(2, '0');
            document.getElementById('bloqueoHoraFin').value = `${h2}:${m}`;
            actualizarDuracionTexto();

            // 3. Mostrar Modal
            modalBloqueoInstancia.show();
        };

        // B.1 SUBMIT DEL MODAL BLOQUEO
        formBloqueo?.addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            const errDiv = document.getElementById('bloqueoError');

            const formData = new FormData(this);
            // El campo 'motivo' en el form se llama 'motivo' (ver input hidden o text), 
            // pero mi backend espera 'descripcion' en el campo description?
            // OJO: En mi fix anterior (Step 132), us칠:
            // Insert into ... (..., descripcion, ...) VALUES (..., motivo, ...)
            // Pero en el request.form.get('motivo') lo usaba para el INSERT.
            // 
            // Revisemos routes.py api_agenda_bloquear:
            // motivo = data.get('motivo', 'Bloqueo Manual')
            // INSERT ... (..., descripcion, ...) VALUES (..., motivo, ...)
            //
            // Entonces el backend espera JSON { ... "motivo": "Algo" ... }
            // Y lo guarda en la columna 'descripcion'.
            //
            // En mi HTML modal puse: name="motivo" para el t칤tulo.
            // Y name="descripcion" para el textarea.
            //
            // Si el backend solo usa 'motivo', ignorar치 'descripcion' del textarea si no lo recojo.
            //
            // Vamos a ajustar el JS para combinar T칤tulo + Descripci칩n si es necesario, 
            // o mandar ambos si ajusto el backend. 
            // Como NO quiero tocar backend otra vez si no es necesario,
            // Mandar칠 en 'motivo' el string: "T칤tulo - Descripci칩n" o solo T칤tulo.

            const title = formData.get('motivo') || "";
            const desc = formData.get('descripcion') || "";
            const tipo = formData.get('tipo_bloqueo'); // Personalizado o Comida

            let motivoFinal = title;
            if (tipo === 'Comida' && !motivoFinal) motivoFinal = "Almuerzo/Comida";
            if (desc) motivoFinal += ` (${desc})`;

            const dataFinal = {
                empleado_id: formData.get('empleado_id'),
                fecha: formData.get('fecha'),
                hora_inicio: formData.get('hora_inicio'),
                hora_fin: formData.get('hora_fin'),
                motivo: motivoFinal
            };

            btn.disabled = true;
            btn.textContent = "Guardando...";
            errDiv.style.display = 'none';

            fetch('/api/agenda/bloquear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataFinal)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        modalBloqueoInstancia.hide();
                        actualizarAgenda();
                    } else {
                        errDiv.innerText = data.message || "Error al bloquear.";
                        errDiv.style.display = 'block';
                    }
                })
                .catch(err => {
                    errDiv.innerText = "Error de red: " + err;
                    errDiv.style.display = 'block';
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = "Guardar";
                });
        });

        // 游릭 FIN NUEVAS FUNCIONES

        window.habilitarHorarioColab = function (empleadoId, nombre) {
            // 1. Resetear
            formHabilitar.reset();
            document.getElementById('habilitarError').style.display = 'none';

            // 2. Pre-llenar
            document.getElementById('habilitarEmpleadoId').value = empleadoId;
            document.getElementById('habilitarNombreEmpleado').innerText = nombre;

            const fechaVal = selectorFecha.value;
            // Formato bonito de fecha para visualizaci칩n
            const d = new Date(fechaVal + 'T00:00:00');
            const opciones = { weekday: 'short', day: 'numeric', month: 'short' };
            if (document.getElementById('habilitarFechaTxt')) {
                document.getElementById('habilitarFechaTxt').innerText = d.toLocaleDateString('es-ES', opciones);
            }
            document.getElementById('habilitarFecha').value = fechaVal;

            // Horas default
            document.getElementById('habilitarHoraInicio').value = "09:00";
            document.getElementById('habilitarHoraFin').value = "13:00";

            // Trigger c치lculo inicial si la funci칩n externa existe
            if (typeof actualizarDuracionExtra === 'function') actualizarDuracionExtra();

            // 3. Mostrar
            modalHabilitarInstancia.show();
        };

        // SUBMIT HABILITAR
        // SUBMIT HABILITAR
        formHabilitar?.addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            const errDiv = document.getElementById('habilitarError');
            // ... (resto del c칩digo submit) ...

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            btn.disabled = true;
            btn.textContent = "Guardando...";
            errDiv.style.display = 'none';

            fetch('/api/agenda/habilitar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        modalHabilitarInstancia.hide();
                        actualizarAgenda();
                    } else {
                        errDiv.innerText = data.message || "Error al habilitar.";
                        errDiv.style.display = 'block';
                    }
                })
                .catch(err => {
                    errDiv.innerText = "Error de red";
                    errDiv.style.display = 'block';
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = "Guardar Turno";
                });
        });

        // 游릭 FUNCI칍N RESTAURADA: Abrir Modal Nueva Reserva
        function abrirModalNuevaReserva(recursoId, recursoNombre, fecha, hora) {
            // 1. Llenar campos ocultos
            if (document.getElementById('nuevaReservaEmpleadoId')) document.getElementById('nuevaReservaEmpleadoId').value = recursoId;
            if (document.getElementById('nuevaReservaFecha')) document.getElementById('nuevaReservaFecha').value = fecha;
            if (document.getElementById('nuevaReservaHora')) document.getElementById('nuevaReservaHora').value = hora;

            // 2. T칤tulo visual
            const modalTitle = document.getElementById('modalNuevaReservaLabel');
            if (modalTitle) {
                // Formato bonito de fecha
                let fechaBonita = fecha;
                try {
                    fechaBonita = new Date(fecha + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                } catch (e) { }

                modalTitle.innerHTML = `<i class="fas fa-plus-circle me-2"></i>Nueva Reserva - <b>${recursoNombre}</b> <br><small class="text-muted" style="font-size:0.9rem">${fechaBonita} - ${hora}</small>`;
            }

            // 3. Resetear formulario
            const form = document.getElementById('formNuevaReserva');
            if (form) form.reset();

            // 4. Resetear Select2 si existen
            if ($('#nuevaReservaClienteId').length) $('#nuevaReservaClienteId').val('').trigger('change');
            if ($('#nuevaReservaServicioId').length) $('#nuevaReservaServicioId').val('').trigger('change');

            // 5. Establecer fecha/hora visible si existe campo (opcional, depende de tu modal)

            // 6. Mostrar Modal
            if (modalNuevaReservaInstancia) modalNuevaReservaInstancia.show();
        }

        function abrirModalGestionarReserva(reservaId) {
            // --- 1. Selectores ---
            const modalTitle = document.getElementById('modalGestionarReservaLabel');
            const vistaDiv = document.getElementById('detalleReservaVista');
            const formEditar = document.getElementById('formEditarReservaModal');
            const modalFooter = document.querySelector('#modalGestionarReserva .modal-footer');

            // Botones Nativos
            const btnEditar = document.getElementById('btnModalEditarReserva');
            const btnCancelar = document.getElementById('btnModalCancelarReserva');
            const btnCompletar = document.getElementById('btnModalCompletarReserva');
            const btnVenta = document.getElementById('btnModalRegistrarVenta');
            const btnCancelarEdicion = document.getElementById('btnModalCancelarEdicion');
            const btnGuardar = document.getElementById('btnModalGuardarCambios');
            const btnDiagnostico = document.getElementById('btnModalDiagnostico'); // Nuevo Bot칩n

            // ... (limpieza de botones omitida) ...

            // --- 2. 游릭 LIMPIEZA TOTAL DE BOTONES WHATSAPP (Anti-Duplicados) ---
            // Buscamos cualquier bot칩n que tenga nuestra clase especial y lo borramos
            const botonesViejos = modalFooter.querySelectorAll('.btn-whatsapp-dynamic');
            botonesViejos.forEach(btn => btn.remove());

            // --- 3. 游릭 CREACI칍N DE NUEVOS BOTONES ---

            // A. Bot칩n Recordar (Cliente)
            const btnRecordarWs = document.createElement('button');
            btnRecordarWs.className = 'btn btn-success btn-sm shadow-sm me-1 btn-whatsapp-dynamic'; // Agregamos clase identificadora
            btnRecordarWs.innerHTML = '<i class="fab fa-whatsapp me-1"></i> Recordar';
            modalFooter.insertBefore(btnRecordarWs, modalFooter.firstChild);

            // B. Bot칩n Avisar Staff
            const btnAvisarStaff = document.createElement('button');
            btnAvisarStaff.className = 'btn btn-info btn-sm shadow-sm me-auto text-white btn-whatsapp-dynamic'; // Agregamos clase identificadora
            btnAvisarStaff.innerHTML = '<i class="fas fa-user-clock me-1"></i> Avisar Staff';
            btnRecordarWs.after(btnAvisarStaff);

            function cambiarModo(modoVista, data = null) {
                if (vistaDiv) vistaDiv.style.display = modoVista ? 'block' : 'none';
                if (formEditar) formEditar.style.display = modoVista ? 'none' : 'block';

                let esFinal = false;
                if (data) {
                    const est = data.estado || '';
                    esFinal = ['Completada', 'Cancelada', 'Cancelada por Cliente', 'Cancelada por Staff', 'No Asistio'].some(s => est.includes(s));
                } else { esFinal = true; }

                const mostrarAcciones = modoVista && !esFinal;

                if (btnEditar) btnEditar.style.display = mostrarAcciones ? 'inline-block' : 'none';
                if (btnCancelar) btnCancelar.style.display = mostrarAcciones ? 'inline-block' : 'none';
                if (btnCompletar) btnCompletar.style.display = mostrarAcciones ? 'inline-block' : 'none';
                if (btnVenta) btnVenta.style.display = (data && data.estado === 'Completada') ? 'inline-block' : 'none';
                if (btnCancelarEdicion) btnCancelarEdicion.style.display = modoVista ? 'none' : 'inline-block';
                if (btnGuardar) btnGuardar.style.display = modoVista ? 'none' : 'inline-block';
                if (btnDiagnostico) btnDiagnostico.style.display = modoVista ? 'inline-block' : 'none'; // Mostrar bot칩n debug

                // Mostrar Whatsapp solo en modo vista y activa
                const showWs = modoVista && !esFinal;
                btnRecordarWs.style.display = showWs ? 'inline-block' : 'none';
                btnAvisarStaff.style.display = showWs ? 'inline-block' : 'none';

                if (!modoVista && data) {
                    modalTitle.innerHTML = `<i class="fas fa-edit me-2"></i>Editando Reserva #${data.id}`;
                    document.getElementById('editReservaId').value = data.id;
                    // (L칩gica de poblado de selects omitida para brevedad, mantenla igual)
                    // ... Aseg칰rate de que tus selects se llenen aqu칤 ...
                    // Si necesitas el c칩digo de los selects d칤melo, pero asumo que ya lo tienes
                    const poblar = (id, items, val) => {
                        const s = document.getElementById(id); if (!s) return;
                        s.innerHTML = '<option value="">Sel...</option>';
                        items.forEach(i => s.add(new Option(i.texto_busqueda || i.nombres || i.nombre || i.razon_social_nombres, i.id)));
                        s.value = val;
                    };
                    poblar('editClienteId', todosLosClientes, data.cliente_id);

                    // 游릭 INIT SELECT2 EDITAR
                    if ($('#editClienteId').data('select2')) $('#editClienteId').select2('destroy');
                    $('#editClienteId').select2({ theme: 'bootstrap-5', dropdownParent: $('#modalGestionarReserva'), width: '100%', placeholder: 'Buscar Cliente...' });

                    poblar('editEmpleadoId', todosLosEmpleadosParaSelector, data.empleado_id);
                    poblar('editServicioId', todosLosServiciosActivos, data.servicio_id);
                    if (document.getElementById('editFechaHoraInicio')) document.getElementById('editFechaHoraInicio').value = data.fecha_hora_inicio.slice(0, 16);
                    if (document.getElementById('editPrecioCobrado')) document.getElementById('editPrecioCobrado').value = data.precio_cobrado;
                }
            }

            cambiarModo(true);
            if (modalGestionarInstancia) modalGestionarInstancia.show();

            // --- 4. Cargar Datos ---
            fetch(`/api/reservas/${reservaId}`)
                .then(r => r.json())
                .then(data => {
                    console.log("Datos Reserva:", data); // 游댌 DEBUG: Mira la consola del navegador
                    datosReservaActualParaModal = data;

                    if (modalTitle) modalTitle.innerHTML = `<i class="fas fa-calendar-check me-2"></i>Reserva #${data.id}`;

                    if (vistaDiv) {
                        // 游릭 CORRECCI칍N DEL NOMBRE DEL STAFF
                        // Intentamos leer 'staff', 'empleado_nombre' o 'empleado_nombre_completo' (para compatibilidad)
                        const staffName = data.staff || data.empleado_nombre || data.empleado_nombre_completo || '<span class="text-danger fw-bold">Sin asignar</span>';

                        vistaDiv.innerHTML = `
                        <dl class="row mb-0">
                            <dt class="col-4">Estado</dt><dd class="col-8">${data.estado}</dd>
                            <dt class="col-4">Cliente</dt><dd class="col-8">${data.cliente_nombre_completo || data.cliente}</dd>
                            <dt class="col-4">Servicio</dt><dd class="col-8">${data.servicio_nombre || data.servicio}</dd>
                            <dt class="col-4">Hora</dt><dd class="col-8 fw-bold">${new Date(data.fecha_hora_inicio).toLocaleString()}</dd>
                            <dt class="col-4">Staff</dt><dd class="col-8 text-primary">${staffName}</dd>
                        </dl>`;
                    }

                    if (btnVenta) btnVenta.href = `{{ url_for('main.nueva_venta') }}?reserva_id=${reservaId}`;

                    // --- EVENTOS DE BOTONES ---

                    btnRecordarWs.onclick = () => {
                        const orig = btnRecordarWs.innerHTML;
                        btnRecordarWs.disabled = true; btnRecordarWs.innerHTML = '...';
                        fetch(`/api/reservas/${reservaId}/whatsapp-link?tipo=recordatorio`)
                            .then(r => r.json())
                            .then(d => {
                                if (d.success) window.open(d.url, '_blank');
                                else alert("Aviso: " + d.message);
                            })
                            .finally(() => { btnRecordarWs.disabled = false; btnRecordarWs.innerHTML = orig; });
                    };

                    if (btnDiagnostico) {
                        btnDiagnostico.onclick = () => {
                            alert(JSON.stringify(data, null, 2));
                        };
                    }

                    btnAvisarStaff.onclick = () => {
                        // 游릭 Validaci칩n Visual: Compatibilidad con versiones anteriores del backend
                        const staffCheck = data.staff || data.empleado_nombre || data.empleado_nombre_completo;

                        if (!staffCheck || staffCheck === 'Sin asignar') {
                            alert("丘멆잺 No puedes avisar porque esta reserva NO TIENE STAFF asignado.\n\n游녤 Asigna un colaborador en 'Editar' primero.");
                            return;
                        }

                        const orig = btnAvisarStaff.innerHTML;
                        btnAvisarStaff.disabled = true; btnAvisarStaff.innerHTML = '...';
                        fetch(`/api/reservas/${reservaId}/whatsapp-link?tipo=aviso_staff`)
                            .then(r => r.json())
                            .then(d => {
                                if (d.success) window.open(d.url, '_blank');
                                else alert("Aviso: " + d.message);
                            })
                            .finally(() => { btnAvisarStaff.disabled = false; btnAvisarStaff.innerHTML = orig; });
                    };

                    cambiarModo(true, data);
                });

            // Listeners b치sicos
            if (btnEditar) btnEditar.onclick = () => cambiarModo(false, datosReservaActualParaModal);
            if (btnCancelarEdicion) btnCancelarEdicion.onclick = () => cambiarModo(true, datosReservaActualParaModal);
            if (btnCancelar) btnCancelar.onclick = () => {
                if (confirm('쮺ancelar?')) fetch(`/reservas/cancelar/${reservaId}`, { method: 'POST' }).then(() => { modalGestionarInstancia.hide(); actualizarAgenda(); });
            };
            if (btnCompletar) btnCompletar.onclick = () => {
                if (confirm('쮺ompletar?')) fetch(`/api/reservas/${reservaId}/completar`, { method: 'POST' }).then(() => { modalGestionarInstancia.hide(); actualizarAgenda(); });
            };
        }

        document.getElementById('formEditarReservaModal')?.addEventListener('submit', function (e) {
            e.preventDefault();
            fetch(`/reservas/editar/${datosReservaActualParaModal.id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(Object.fromEntries(new FormData(this))) })
                .then(res => res.json()).then(d => { if (d.success) { modalGestionarInstancia.hide(); actualizarAgenda(); } else { alert(d.message); } });
        });

        // =========================================================
        // 游릭 MAGIA: EFECTO HOVER (C츼LCULO MATEM츼TICO DE HORA)
        // =========================================================

        const indicadorDiv = document.createElement('div');
        indicadorDiv.id = 'indicadorHoraHover';
        indicadorDiv.style.position = 'absolute';
        indicadorDiv.style.left = '0';
        indicadorDiv.style.pointerEvents = 'none'; // CRITICO: Permite hacer clic "a trav칠s" de la barra
        indicadorDiv.style.zIndex = '5'; // Encima de celdas, debajo de eventos (eventos suelen ser z=6 o m치s)
        indicadorDiv.style.borderTop = '2px dashed var(--agenda-bg-reserva, #6c63ff)';
        indicadorDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
        indicadorDiv.style.display = 'none'; // Oculto x default
        indicadorDiv.style.alignItems = 'center'; // Centrar vertical
        indicadorDiv.style.paddingLeft = '5px';
        indicadorDiv.style.fontSize = '0.85rem';
        indicadorDiv.style.fontWeight = 'bold';
        indicadorDiv.style.color = 'var(--agenda-bg-reserva, #6c63ff)';

        const HORA_INICIO = 8; // Aseg칰rate de que esto coincida con slotMinTime (8:00 AM)

        agendaContainer.addEventListener('mousemove', function (e) {
            // Recalcular minutos din치micamente SIEMPRE (por si cambia config en runtime aunque no deber칤a)
            const parts = (currentConfig.agenda_intervalo || '00:15:00').split(':');
            const minutos_slot_dynamic = (parseInt(parts[0]) * 60) + parseInt(parts[1]);

            // 1. Validar target
            // Buscamos el slot o la columna base
            const slot = e.target.closest('.fc-timegrid-slot');
            const col = e.target.closest('.fc-timegrid-col');

            if (!col) {
                indicadorDiv.style.display = 'none';
                return;
            }

            // 2. Obtener altura del slot (din치mico, FullCalendar lo calcula)
            // Necesitamos un slot de referencia. Si no hay slot bajo el mouse (ej. evento encima), buscamos uno en la columna
            let referenceSlot = slot || col.querySelector('.fc-timegrid-slot');

            if (!referenceSlot) return;

            // Altura real renderizada
            const slotHeight = referenceSlot.getBoundingClientRect().height;
            if (slotHeight < 5) return; // Evitar divisiones por cero o valores absurdos

            // 3. C치lculos de Posici칩n
            const rectCol = col.getBoundingClientRect();
            const relativeY = e.clientY - rectCol.top;

            // "Imantar" al slot m치s cercano
            const slotIndex = Math.floor(relativeY / slotHeight);
            const snappedY = slotIndex * slotHeight;

            // 4. Mover la Barra
            // Evitamos parpadeo: solo append si cambi칩 de columna
            if (indicadorDiv.parentElement !== col) {
                // Limpiar anterior si existe en otra columna (aunque el CSS lo oculta, mejor moverlo)
                col.appendChild(indicadorDiv);
                indicadorDiv.style.width = '100%';
            }
            // CR칈TICO: Asegurar siempre display flex (corrige bug de re-entrada tras mouseleave)
            indicadorDiv.style.display = 'flex';

            // Forzar altura siempre por si el zoom cambi칩
            indicadorDiv.style.height = `${slotHeight}px`;
            indicadorDiv.style.top = `${snappedY}px`;

            // 5. CALCULAR LA HORA MATEM츼TICAMENTE (Infalible)
            const minutosDesdeInicio = slotIndex * minutos_slot_dynamic;

            const fechaBase = new Date();
            fechaBase.setHours(HORA_INICIO, 0, 0, 0); // 08:00:00
            fechaBase.setMinutes(fechaBase.getMinutes() + minutosDesdeInicio);

            // Formatear: 10:15 a. m.
            const horaStr = fechaBase.toLocaleTimeString('es-PE', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            indicadorDiv.innerHTML = `<i class="fas fa-clock me-1" style="font-size: 0.7rem; margin-top: 3px;"></i> ${horaStr}`;
        });

        agendaContainer.addEventListener('mouseleave', function () {
            indicadorDiv.style.display = 'none';
        });
        // Funci칩n para crear el c칤rculo con iniciales
        function crearIniciales(nombre) {
            const div = document.createElement('div');
            div.style.width = '50px';
            div.style.height = '50px';
            div.style.borderRadius = '50%';
            div.style.backgroundColor = '#6c63ff'; // Tu color morado
            div.style.color = '#ffffff';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'center';
            div.style.fontWeight = 'bold';
            div.style.fontSize = '1.2rem';
            div.style.border = '2px solid #fff';
            div.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
            div.style.marginBottom = '5px';
            div.innerText = nombre ? nombre.charAt(0).toUpperCase() : '?';
            return div;
        }
    });
</script>

{% endblock scripts %}