{% extends "base.html" %}

{% block title %}Agenda Diaria de Citas - JV Studio{% endblock %}

{% block head_extra %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>

<style>
    /* Contenedor del Calendario */
    #calendar { 
        border: 1px solid var(--color-secundario-gris); 
        border-radius: 8px; 
        padding: 10px; 
        background-color: #302f2dda; 
        
        /* Altura M칤nima para evitar colapso visual */
        min-height: 650px; 
    }
    
    /* Barra de Herramientas Superior */
    #controlesAgenda { 
        background-color: #0e0d0d; 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        display: flex; 
        gap: 15px; 
        align-items: center; 
        flex-wrap: wrap; 
    }
    
    /* --- Estilos Personalizados FullCalendar (Modo Oscuro) --- */
    
    .fc-timegrid-slot { background-color: rgba(0, 0, 0, 0.15); }
    .fc-timegrid-slot-business { background-color: rgba(40, 167, 69, 0.2) !important; }

    /* Estilo de Eventos (Citas) */
    .fc-event { 
        font-size: 0.85em !important; 
        padding: 2px !important; 
        border: none !important; 
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .fc-event-main { color: #212529 !important; font-weight: bold; }

    /* Encabezados de Columna */
    .fc-col-header-cell-cushion { 
        color: var(--color-acento-dorado) !important; 
        text-decoration: none !important; 
        font-size: 1.1em;
        padding: 10px 0 !important;
    }

    .fc-timegrid-slot-label-cushion { color: var(--color-secundario-gris); font-size: 0.9em; }
    .fc .fc-timegrid-slot-minor { border-top-style: dotted !important; border-top-color: rgba(255, 255, 255, 0.1); }
</style>
{% endblock head_extra %}

{% block content %}
<div class="container-fluid mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: var(--color-acento-dorado);"><i class="fas fa-calendar-day me-2"></i>Agenda Diaria</h2>
        <span class="badge bg-warning text-dark fs-6 shadow-sm">
            <i class="fas fa-map-marker-alt me-2"></i>Sucursal: {{ session.get('sucursal_nombre', 'Actual') }}
        </span>
    </div>

    <div id="controlesAgenda" class="d-flex flex-wrap align-items-center gap-3 p-3 rounded mb-4" style="background-color: #3a3a3a;">
        
        <input type="hidden" id="selectorSucursalAgenda" value="{{ session.get('sucursal_id') }}">

        <div class="ms-md-3">
            <label for="selectorFechaAgenda" class="form-label text-light small fw-bold">Fecha:</label>
            <div class="d-flex align-items-center">
                <button id="btnDiaAnterior" class="btn btn-outline-light btn-sm"><i class="fas fa-chevron-left"></i></button>
                <input type="date" id="selectorFechaAgenda" class="form-control form-control-sm mx-1 fw-bold text-center" style="width: 140px;">
                <button id="btnDiaSiguiente" class="btn btn-outline-light btn-sm"><i class="fas fa-chevron-right"></i></button>
                <button id="btnHoy" class="btn btn-warning btn-sm ms-2 fw-bold text-dark"><i class="fas fa-calendar-day me-1"></i> Hoy</button>
            </div>
        </div>
        
        <div class="ms-md-3 mt-2 mt-md-0">
            <label for="selectorEmpleadosAgenda" class="form-label text-light small fw-bold">Filtrar Colaboradores:</label>
            <select multiple class="form-select form-select-sm" id="selectorEmpleadosAgenda" style="width: 250px; min-height: 38px; display: inline-block; vertical-align: middle;">
                {% if not empleados_para_selector %}
                    <option value="" disabled>No hay colaboradores disponibles</option>
                {% else %}
                    {% for emp in empleados_para_selector %}
                        <option value="{{ emp.id }}" selected>{{ emp.nombres }} {{ emp.apellidos }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        
        <div class="ms-md-auto mt-2 mt-md-0">
            <button id="btnActualizarAgenda" class="btn btn-primary btn-sm fw-bold shadow-sm">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
    </div>
    
    <div id='calendar' class="mt-4 shadow-lg"></div>

    {% include 'reservas/_modal_nueva_reserva.html' %}
    {% include 'reservas/_modal_gestionar_reserva.html' %}
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Selectores
    const selectorSucursal = document.getElementById('selectorSucursalAgenda');
    const selectorFecha = document.getElementById('selectorFechaAgenda');
    const btnActualizar = document.getElementById('btnActualizarAgenda');
    const agendaContainer = document.getElementById('calendar');
    
    // Instancias Modales
    const modalNuevaReservaElement = document.getElementById('modalNuevaReserva');
    const modalNuevaReservaInstancia = modalNuevaReservaElement ? new bootstrap.Modal(modalNuevaReservaElement) : null;
    const formModalNuevaReserva = document.getElementById('formNuevaReservaModal');

    const modalGestionarElement = document.getElementById('modalGestionarReserva');
    const modalGestionarInstancia = modalGestionarElement ? new bootstrap.Modal(modalGestionarElement) : null;

    // Datos Globales (Jinja to JS)
    const todosLosClientes = JSON.parse('{{ clientes_todos | tojson | safe }}');
    const todosLosServiciosActivos = JSON.parse('{{ servicios_todos_activos | tojson | safe }}');
    const todosLosEmpleadosParaSelector = JSON.parse('{{ empleados_para_selector | tojson | safe }}');

    let datosApiAgenda = null; 
    let datosReservaActualParaModal = null; 


    
    // 游릭 NUEVO: Actualizar precio autom치ticamente al cambiar el servicio (Modo Edici칩n)
    const selectServicioEdit = document.getElementById('editServicioId');
    const inputPrecioEdit = document.getElementById('editPrecioCobrado');

    if (selectServicioEdit && inputPrecioEdit) {
        selectServicioEdit.addEventListener('change', function() {
            const idSeleccionado = this.value;
            
            // Buscar el servicio en la lista global para obtener su precio
            const servicio = todosLosServiciosActivos.find(s => s.id == idSeleccionado);
            
            if (servicio) {
                // Actualizar el input de precio con el valor del servicio
                inputPrecioEdit.value = parseFloat(servicio.precio).toFixed(2);
            }
        });
    }

    // 2. Funci칩n Fecha Local (Corrige UTC)
    function setFechaLocal() {
        if (selectorFecha) { 
            const now = new Date();
            const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            selectorFecha.value = localDate.toISOString().slice(0,10); 
        }
    }
    if (!selectorFecha.value) setFechaLocal();

    // 3. Inicializar FullCalendar
    const calendar = new FullCalendar.Calendar(agendaContainer, {
        schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
        initialView: 'resourceTimeGridDay',
        locale: 'es',
        headerToolbar: false,
        height: 'auto',
        allDaySlot: false,
        slotDuration: '00:15:00',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        slotLabelInterval: '01:00',
        nowIndicator: true,
        editable: true,
        droppable: true,
        slotLabelFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short', omitZeroMinute: false },
        eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },
        
        // Fuentes de Datos
        resources: function(fetchInfo, successCallback, failureCallback) {
            const sucursalId = selectorSucursal.value;
            if (!sucursalId) { successCallback([]); return; }
            fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                .then(res => res.json()).then(data => successCallback(data.recursos)).catch(err => failureCallback(err));
        },
        events: function(fetchInfo, successCallback, failureCallback) {
            const sucursalId = selectorSucursal.value;
            if (!sucursalId) { successCallback([]); return; }
            fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                .then(res => res.json()).then(data => {
                    datosApiAgenda = data;
                    successCallback(data.eventos);
                }).catch(err => failureCallback(err));
        },
        // --- INTERACCIONES ---

        // A. Clic en espacio vac칤o (Nueva Reserva)
        dateClick: function(info) {
            if (!datosApiAgenda || !datosApiAgenda.eventos) return;
            const slotDT = new Date(info.dateStr).getTime();
            const colaboradorId = info.resource.id;

            const esHorarioHabil = datosApiAgenda.eventos.some(evento => 
                evento.resourceId == colaboradorId && evento.display === 'background' &&
                evento.backgroundColor.includes('40, 167, 69') &&
                new Date(evento.start).getTime() <= slotDT && new Date(evento.end).getTime() > slotDT
            );
            const enAusencia = datosApiAgenda.eventos.some(evento => 
                evento.resourceId == colaboradorId && evento.display === 'background' &&
                evento.backgroundColor.includes('220, 53, 69') &&
                new Date(evento.start).getTime() <= slotDT && new Date(evento.end).getTime() > slotDT
            );
            
            if (esHorarioHabil && !enAusencia) {
                const hora = info.dateStr.slice(11, 16);
                abrirModalNuevaReserva(info.resource.id, info.resource.title, info.dateStr.slice(0, 10), hora);
            }
        },

        // B. Clic en Evento (Gestionar)
        eventClick: function(info) {
            if (info.event.id) abrirModalGestionarReserva(info.event.id);
        },

        // C. Arrastrar y Soltar (Reagendar)
        eventDrop: function(info) {
            const reservaId = info.event.id;
            const nuevoInicio = info.event.start;
            const nuevoColaboradorId = info.event.getResources()[0].id;

            if (nuevoInicio < new Date()) {
                alert("No se puede mover una reserva al pasado.");
                info.revert(); return;
            }
            if (!confirm("쯉eguro que deseas mover esta reserva?")) {
                info.revert(); return;
            }
            
            fetch('/reservas/reagendar', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reserva_id: reservaId, nuevo_inicio: nuevoInicio.toISOString(), nuevo_colaborador_id: nuevoColaboradorId })
            })
            .then(res => res.json().then(d => ({ok: res.ok, data: d})))
            .then(result => {
                if (!result.ok) { alert(result.data.message); info.revert(); }
                else { actualizarAgenda(); }
            })
            .catch(err => { alert("Error de red."); info.revert(); });
        },
    });

    calendar.render();
    
    // --- 4. FUNCIONES AUXILIARES ---
    function actualizarAgenda() {
        calendar.refetchResources();
        calendar.refetchEvents();
        calendar.gotoDate(selectorFecha.value);
    }

    // --- 5. LISTENERS BOTONES ---
    document.getElementById('btnDiaAnterior').addEventListener('click', () => { 
        const d = new Date(selectorFecha.value + 'T00:00:00'); d.setDate(d.getDate() - 1); 
        selectorFecha.value = d.toISOString().slice(0,10); actualizarAgenda(); 
    });
    document.getElementById('btnDiaSiguiente').addEventListener('click', () => { 
        const d = new Date(selectorFecha.value + 'T00:00:00'); d.setDate(d.getDate() + 1); 
        selectorFecha.value = d.toISOString().slice(0,10); actualizarAgenda(); 
    });
    document.getElementById('btnHoy').addEventListener('click', () => { 
        setFechaLocal(); actualizarAgenda(); 
    });
    selectorFecha.addEventListener('change', actualizarAgenda);
    btnActualizar?.addEventListener('click', actualizarAgenda);

    // --- 6. MODAL NUEVA RESERVA ---
    window.abrirModalNuevaReserva = function(empleadoId, empleadoNombre, fecha, hora) {
        formModalNuevaReserva.reset(); 
        document.getElementById('modalSucursalId').value = selectorSucursal.value; 
        document.getElementById('modalEmpleadoNombre').textContent = empleadoNombre;
        
        const fechaObj = new Date(fecha + 'T00:00:00');
        document.getElementById('modalFecha').textContent = fechaObj.toLocaleDateString('es-PE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('modalHoraInicio').textContent = hora;
        document.getElementById('modalEmpleadoId').value = empleadoId;
        document.getElementById('modalFechaHoraInicioFull').value = `${fecha}T${hora}`;
        document.getElementById('modalErrores').style.display = 'none';
        
        if (modalNuevaReservaInstancia) modalNuevaReservaInstancia.show();
    };

    formModalNuevaReserva?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const errDiv = document.getElementById('modalErrores');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        errDiv.style.display = 'none';
        
        fetch("{{ url_for('main.nueva_reserva') }}", { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(this))) })
        .then(res => res.json().then(d => ({ok: res.ok, data: d})))
        .then(res => {
            if (res.ok && res.data.success) { modalNuevaReservaInstancia.hide(); actualizarAgenda(); }
            else { errDiv.innerHTML = (res.data.errors || [res.data.message]).join('<br>'); errDiv.style.display = 'block'; }
        })
        .catch(err => { errDiv.innerHTML = `Error: ${err.message}`; errDiv.style.display = 'block'; })
        .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Reserva'; });
    });

    // --- 7. MODAL GESTIONAR RESERVA (L칍GICA CORREGIDA) ---
    function abrirModalGestionarReserva(reservaId) {
        const modalTitle = document.getElementById('modalGestionarReservaLabel');
        const vistaDiv = document.getElementById('detalleReservaVista');
        const formEditar = document.getElementById('formEditarReservaModal');
        const erroresEditarDiv = document.getElementById('modalEditarErrores');
        
        const btnEditar = document.getElementById('btnModalEditarReserva');
        const btnCancelarReserva = document.getElementById('btnModalCancelarReserva');
        const btnCompletarReserva = document.getElementById('btnModalCompletarReserva');
        const btnRegistrarVenta = document.getElementById('btnModalRegistrarVenta');
        const btnCancelarEdicion = document.getElementById('btnModalCancelarEdicion');
        const btnGuardarCambios = document.getElementById('btnModalGuardarCambios');

        function cambiarModo(modoVista, data = null) {
            if(vistaDiv) vistaDiv.style.display = modoVista ? 'block' : 'none';
            if(formEditar) formEditar.style.display = modoVista ? 'none' : 'block';
            if(erroresEditarDiv) erroresEditarDiv.style.display = 'none';
            
            let esFinal = false;
            let estadoActual = '';
            if (data) {
                estadoActual = data.estado || '';
                const estadosFinales = ['Completada', 'Cancelada', 'Cancelada por Cliente', 'Cancelada por Staff', 'No Asistio'];
                esFinal = estadosFinales.some(s => estadoActual.includes(s));
            } else { esFinal = true; }

            const mostrarAcciones = modoVista && !esFinal;
            if (btnEditar) btnEditar.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnCancelarReserva) btnCancelarReserva.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnCompletarReserva) btnCompletarReserva.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnRegistrarVenta) btnRegistrarVenta.style.display = (data && estadoActual === 'Completada') ? 'inline-block' : 'none';

            if (btnCancelarEdicion) btnCancelarEdicion.style.display = modoVista ? 'none' : 'inline-block';
            if (btnGuardarCambios) btnGuardarCambios.style.display = modoVista ? 'none' : 'inline-block';

            if (!modoVista && data) {
                modalTitle.innerHTML = `<i class="fas fa-edit me-2"></i>Editando Reserva #${data.id}`;
                document.getElementById('editReservaId').value = data.id;
                
                const poblarSelect = (selId, items, valActual, txtCallback) => {
                    const sel = document.getElementById(selId);
                    if(!sel) return;
                    sel.innerHTML = `<option value="">Seleccione...</option>`;
                    items.forEach(item => { sel.add(new Option(txtCallback(item), item.id)); });
                    sel.value = valActual;
                };
                
                poblarSelect('editClienteId', todosLosClientes, data.cliente_id, item => `${item.razon_social_nombres} ${item.apellidos || ''}`);
                poblarSelect('editEmpleadoId', todosLosEmpleadosParaSelector, data.empleado_id, item => `${item.nombres} ${item.apellidos}`);
                poblarSelect('editServicioId', todosLosServiciosActivos, data.servicio_id, item => `${item.nombre} (${item.duracion_minutos} min)`);
                
                const fechaInput = document.getElementById('editFechaHoraInicio');
                if (fechaInput && data.fecha_hora_inicio) fechaInput.value = data.fecha_hora_inicio.slice(0, 16);
                const precioInput = document.getElementById('editPrecioCobrado');
                if (precioInput) precioInput.value = data.precio_cobrado ? parseFloat(data.precio_cobrado).toFixed(2) : '';
                document.getElementById('editNotasCliente').value = data.notas_cliente || '';
                document.getElementById('editNotasInternas').value = data.notas_internas || '';
            }
        }
        
        cambiarModo(true);
        if(modalTitle) modalTitle.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Cargando...`;
        if(modalGestionarInstancia) modalGestionarInstancia.show();

        fetch(`/api/reservas/${reservaId}`)
            .then(r => r.ok ? r.json() : Promise.reject('Error'))
            .then(data => {
                datosReservaActualParaModal = data; 
                if(modalTitle) modalTitle.innerHTML = `<i class="fas fa-calendar-check me-2"></i>Detalles de Reserva #${data.id}`;
                const inicioDT = new Date(data.fecha_hora_inicio);
                if(vistaDiv) {
                    vistaDiv.innerHTML = `
                        <dl class="row">
                            <dt class="col-sm-4">Estado:</dt><dd class="col-sm-8"><span class="badge bg-secondary">${data.estado}</span></dd>
                            <dt class="col-sm-4">Cliente:</dt><dd class="col-sm-8">${data.cliente_nombre_completo||'-'}</dd>
                            <dt class="col-sm-4">Colaborador:</dt><dd class="col-sm-8">${data.empleado_nombre_completo||'-'}</dd>
                            <dt class="col-sm-4">Servicio:</dt><dd class="col-sm-8">${data.servicio_nombre||'-'}</dd>
                            <dt class="col-sm-4">Inicio:</dt><dd class="col-sm-8">${inicioDT.toLocaleString('es-PE')}</dd>
                            <dt class="col-sm-4">Notas:</dt><dd class="col-sm-8 text-muted small">${data.notas_cliente || 'Sin notas'}</dd>
                        </dl>`;
                }
                if (btnRegistrarVenta) btnRegistrarVenta.href = `{{ url_for('main.nueva_venta') }}?reserva_id=${reservaId}`;
                cambiarModo(true, data);
            })
            .catch(error => { 
                if(vistaDiv) vistaDiv.innerHTML = `<div class="alert alert-danger">Error al cargar datos.</div>`; 
            });
        
        if (btnEditar) btnEditar.onclick = () => { if(datosReservaActualParaModal) cambiarModo(false, datosReservaActualParaModal); };
        if (btnCancelarEdicion) btnCancelarEdicion.onclick = () => { if(datosReservaActualParaModal) cambiarModo(true, datosReservaActualParaModal); };
        
        if (btnCancelarReserva) btnCancelarReserva.onclick = () => { 
            if (confirm(`쯉eguro que quieres CANCELAR la reserva #${reservaId}?`)) { 
                fetch(`/reservas/cancelar/${reservaId}`, {method: 'POST'}).then(r=>r.json()).then(res=>{ alert(res.message); if(res.success){ modalGestionarInstancia.hide(); actualizarAgenda(); } });
            }
        };
        if (btnCompletarReserva) btnCompletarReserva.onclick = () => {
            if (confirm(`쯉eguro que quieres marcar como COMPLETADA?`)) {
                fetch(`/api/reservas/${reservaId}/completar`, {method: 'POST'}).then(r => r.json()).then(res => {
                    alert(res.message);
                    if (res.success && res.redirect_url) window.location.href = res.redirect_url;
                    else { modalGestionarInstancia.hide(); actualizarAgenda(); }
                });
            }
        }; 
    }

    document.getElementById('formEditarReservaModal')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnModalGuardarCambios');
        const errDiv = document.getElementById('modalEditarErrores');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        errDiv.style.display = 'none';
        
        fetch(`/reservas/editar/${datosReservaActualParaModal.id}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(this))) })
        .then(res => res.json().then(d => ({ok: res.ok, data: d})))
        .then(res => {
            if (res.ok && res.data.success) { modalGestionarInstancia.hide(); actualizarAgenda(); alert(res.data.message); }
            else { errDiv.innerHTML = (res.data.errors || [res.data.message]).join('<br>'); errDiv.style.display = 'block'; }
        })
        .catch(err => { errDiv.innerHTML = `Error: ${err.message}`; errDiv.style.display = 'block'; })
        .finally(() => { btn.disabled = false; btn.textContent = 'Guardar Cambios'; });
    });
});
</script>
{% endblock scripts %}