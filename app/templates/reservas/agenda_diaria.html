{% extends "base.html" %}

{% block title %}Agenda Diaria de Citas - JV Studio{% endblock %}

{% block head_extra %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>

<style>
    /* Contenedor del Calendario */
    #calendar { 
        border: 1px solid var(--color-secundario-gris); 
        border-radius: 8px; 
        padding: 10px; 
        background-color: #302f2dda; 
        
        /* 游릭 2. ALTURA M칈NIMA (Agregado para evitar que se vea como una l칤nea gris) */
        min-height: 650px; 
    }
    
    /* Barra de Herramientas Superior */
    #controlesAgenda { 
        background-color: #0e0d0d; 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        display: flex; 
        gap: 15px; 
        align-items: center; 
        flex-wrap: wrap; 
    }
    
    /* --- Estilos Personalizados para FullCalendar (Modo Oscuro) --- */
    
    /* Fondo general de las celdas (Gris oscuro transparente) */
    .fc-timegrid-slot { 
        background-color: rgba(0, 0, 0, 0.15); 
    }

    /* Fondo para Horario Laboral (Verde suave) - Indica disponibilidad */
    .fc-timegrid-slot-business { 
        background-color: rgba(40, 167, 69, 0.2) !important; 
    }

    /* Estilo de los Eventos (Citas) */
    .fc-event { 
        font-size: 0.85em !important; 
        padding: 2px !important; 
        border: none !important; 
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .fc-event-main { 
        color: #212529 !important; 
        font-weight: bold; 
    }

    /* Encabezados de Columna (Nombres de Barberos) */
    .fc-col-header-cell-cushion { 
        color: var(--color-acento-dorado) !important; 
        text-decoration: none !important; 
        font-size: 1.1em;
        padding-top: 10px !important;
        padding-bottom: 10px !important;
    }

    /* Etiquetas de Hora (Eje Y) */
    .fc-timegrid-slot-label-cushion { 
        color: var(--color-secundario-gris); 
        font-size: 0.9em;
    }

    /* L칤neas divisorias de media hora */
    .fc .fc-timegrid-slot-minor { 
        border-top-style: dotted !important; 
        border-top-color: rgba(255, 255, 255, 0.1);
    }
</style>
{% endblock head_extra %}


{% block content %}
<div class="container-fluid mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: var(--color-acento-dorado);"><i class="fas fa-calendar-day me-2"></i>Agenda Diaria</h2>
        
        <span class="badge bg-warning text-dark fs-6 shadow-sm">
            <i class="fas fa-map-marker-alt me-2"></i>Sucursal: {{ session.get('sucursal_nombre', 'Actual') }}
        </span>
    </div>

    <div id="controlesAgenda" class="d-flex flex-wrap align-items-center gap-3 p-3 rounded mb-4" style="background-color: #3a3a3a;">
        
        <input type="hidden" id="selectorSucursalAgenda" value="{{ session.get('sucursal_id') }}">

        <div class="ms-md-3">
            <label for="selectorFechaAgenda" class="form-label text-light small fw-bold">Fecha:</label>
            <div class="d-flex align-items-center">
                <button id="btnDiaAnterior" class="btn btn-outline-light btn-sm" title="D칤a Anterior">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <input type="date" id="selectorFechaAgenda" class="form-control form-control-sm mx-1 fw-bold text-center" style="width: 140px;">
                <button id="btnDiaSiguiente" class="btn btn-outline-light btn-sm" title="D칤a Siguiente">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button id="btnHoy" class="btn btn-warning btn-sm ms-2 fw-bold text-dark" title="Ir a Hoy">
                    <i class="fas fa-calendar-day me-1"></i> Hoy
                </button>
            </div>
        </div>
        
        <div class="ms-md-3 mt-2 mt-md-0">
            <label for="selectorEmpleadosAgenda" class="form-label text-light small fw-bold">Filtrar Colaboradores:</label>
            <select multiple class="form-select form-select-sm" id="selectorEmpleadosAgenda" aria-label="Seleccionar colaboradores" style="width: 250px; min-height: 38px; display: inline-block; vertical-align: middle;">
                {% if not empleados_para_selector %}
                    <option value="" disabled>No hay colaboradores disponibles en esta sede</option>
                {% else %}
                    {% for emp in empleados_para_selector %}
                        <option value="{{ emp.id }}" selected>{{ emp.nombres }} {{ emp.apellidos }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        
        <div class="ms-md-auto mt-2 mt-md-0">
            <button id="btnActualizarAgenda" class="btn btn-primary btn-sm fw-bold shadow-sm">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
    </div>
    
    <div id='calendar' class="mt-4 shadow-lg"></div>

    {% include 'reservas/_modal_nueva_reserva.html' %}
    {% include 'reservas/_modal_gestionar_reserva.html' %}
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. SELECTORES DEL DOM ---
    const selectorSucursal = document.getElementById('selectorSucursalAgenda'); // Input Hidden
    const selectorFecha = document.getElementById('selectorFechaAgenda');
    const selectorEmpleados = document.getElementById('selectorEmpleadosAgenda');
    const btnActualizar = document.getElementById('btnActualizarAgenda');
    const agendaContainer = document.getElementById('calendar');
    
    // Instancias de Modales
    const modalNuevaReservaElement = document.getElementById('modalNuevaReserva');
    const modalNuevaReservaInstancia = modalNuevaReservaElement ? new bootstrap.Modal(modalNuevaReservaElement) : null;
    const formModalNuevaReserva = document.getElementById('formNuevaReservaModal');

    // Variables Globales
    let datosApiAgenda = null; // Almacena eventos y recursos actuales

    // --- 2. CONFIGURACI칍N DE FECHA "HOY" (Zona Horaria Local) ---
    // Esto corrige el error donde "Hoy" marcaba el d칤a anterior por ser UTC
    function setFechaLocal() {
        if (selectorFecha) { 
            const now = new Date();
            // Ajustar a zona horaria local restando el offset en minutos
            const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            selectorFecha.value = localDate.toISOString().slice(0,10); 
        }
    }
    // Ejecutar al inicio si el campo est치 vac칤o
    if (!selectorFecha.value) setFechaLocal();


    // --- 3. INICIALIZACI칍N DE FULLCALENDAR ---
    const calendar = new FullCalendar.Calendar(agendaContainer, {
        schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source', // Licencia Open Source
        initialView: 'resourceTimeGridDay', // Vista de Columnas por Recurso (Barbero)
        locale: 'es',
        headerToolbar: false, // Usamos nuestra propia barra de herramientas
        height: 'auto',
        allDaySlot: false, // Ocultar fila de "Todo el d칤a"
        slotDuration: '00:15:00', // Bloques de 15 minutos
        slotMinTime: '08:00:00', // Inicio visual
        slotMaxTime: '22:00:00', // Fin visual
        slotLabelInterval: '01:00', // Etiquetas cada hora
        nowIndicator: true, // L칤nea roja de hora actual
        editable: true, // Permite arrastrar y soltar
        droppable: true,
        
        // Formatos de Hora
        slotLabelFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short', omitZeroMinute: false },
        eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },
        
        // --- FUENTES DE DATOS ---
        
        // A. Cargar Recursos (Colaboradores)
        resources: function(fetchInfo, successCallback, failureCallback) {
            const sucursalId = selectorSucursal.value;
            if (!sucursalId) { successCallback([]); return; }
            
            // Construimos la URL con la fecha y sucursal
            fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                .then(res => res.json())
                .then(data => successCallback(data.recursos))
                .catch(err => failureCallback(err));
        },

        // B. Cargar Eventos (Citas, Turnos, Ausencias)
        events: function(fetchInfo, successCallback, failureCallback) {
            const sucursalId = selectorSucursal.value;
            if (!sucursalId) { successCallback([]); return; }

            fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                .then(res => res.json())
                .then(data => {
                    datosApiAgenda = data; // Guardamos copia para validaciones de click
                    successCallback(data.eventos);
                })
                .catch(err => failureCallback(err));
        },

        // --- INTERACCIONES ---

        // A. Click en un espacio vac칤o (Crear Reserva)
        dateClick: function(info) {
            if (!datosApiAgenda || !datosApiAgenda.eventos) return;

            const slotDT = new Date(info.dateStr).getTime();
            const colaboradorId = info.resource.id;

            // 1. Validar si es Horario Laboral (Fondo Verde)
            const esHorarioHabil = datosApiAgenda.eventos.some(evento => 
                evento.resourceId == colaboradorId &&
                evento.display === 'background' &&
                evento.backgroundColor.includes('40, 167, 69') && // Verde
                new Date(evento.start).getTime() <= slotDT &&
                new Date(evento.end).getTime() > slotDT
            );

            // 2. Validar si es Ausencia/Refrigerio (Fondo Rojo)
            const enAusencia = datosApiAgenda.eventos.some(evento => 
                evento.resourceId == colaboradorId &&
                evento.display === 'background' &&
                evento.backgroundColor.includes('220, 53, 69') && // Rojo
                new Date(evento.start).getTime() <= slotDT &&
                new Date(evento.end).getTime() > slotDT
            );
            
            // Solo abrir modal si es horario h치bil Y NO hay ausencia
            if (esHorarioHabil && !enAusencia) {
                const hora = info.dateStr.slice(11, 16); // Extraer HH:MM
                abrirModalNuevaReserva(info.resource.id, info.resource.title, info.dateStr.slice(0, 10), hora);
            } else {
                // Opcional: Feedback visual de por qu칠 no se puede
                // alert("No se puede reservar fuera del horario laboral o durante un descanso.");
            }
        },

        // B. Click en una Reserva existente (Gestionar)
        eventClick: function(info) {
            // Solo si tiene ID es una reserva real (no un fondo de color)
            if (info.event.id) {
                abrirModalGestionarReserva(info.event.id);
            }
        },

        // C. Arrastrar y Soltar (Reagendar)
        eventDrop: function(info) {
            const reservaId = info.event.id;
            const nuevoInicio = info.event.start;
            const nuevoColaboradorId = info.event.getResources()[0].id; // Nuevo due침o de la columna

            // Validaci칩n b치sica frontend
            if (nuevoInicio < new Date()) {
                alert("No se puede mover una reserva a una fecha u hora pasada.");
                info.revert(); return;
            }
            if (!confirm("쯉eguro que deseas mover esta reserva?")) {
                info.revert(); return;
            }
            
            // Preparar datos para el backend
            const payload = {
                reserva_id: reservaId,
                nuevo_inicio: nuevoInicio.toISOString(),
                nuevo_colaborador_id: nuevoColaboradorId
            };

            // Enviar petici칩n
            fetch('/reservas/reagendar', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload)
            })
            .then(res => res.json().then(d => ({ok: res.ok, data: d})))
            .then(result => {
                if (!result.ok) {
                    alert(`No se pudo mover la reserva: ${result.data.message}`);
                    info.revert(); // Devolver visualmente al lugar original
                } else {
                    actualizarAgenda(); // Refrescar para confirmar cambios
                }
            })
            .catch(err => {
                alert("Error de red. Movimiento revertido.");
                info.revert();
            });
        },
    });

    // Renderizar calendario al cargar
    calendar.render();
    
    // --- 4. FUNCIONES AUXILIARES ---
    
    function actualizarAgenda() {
        // Recargar recursos y eventos del servidor
        calendar.refetchResources();
        calendar.refetchEvents();
        calendar.gotoDate(selectorFecha.value); // Ir a la fecha seleccionada
    }

    // --- 5. LISTENERS DE BOTONES ---
    
    // Bot칩n Anterior
    document.getElementById('btnDiaAnterior').addEventListener('click', () => { 
        const d = new Date(selectorFecha.value + 'T00:00:00'); // Forzar hora local
        d.setDate(d.getDate() - 1); 
        selectorFecha.value = d.toISOString().slice(0,10); 
        actualizarAgenda(); 
    });
    
    // Bot칩n Siguiente
    document.getElementById('btnDiaSiguiente').addEventListener('click', () => { 
        const d = new Date(selectorFecha.value + 'T00:00:00'); 
        d.setDate(d.getDate() + 1); 
        selectorFecha.value = d.toISOString().slice(0,10); 
        actualizarAgenda(); 
    });
    
    // Bot칩n Hoy
    document.getElementById('btnHoy').addEventListener('click', () => { 
        setFechaLocal();
        actualizarAgenda(); 
    });
    
    // Cambio manual en el input de fecha
    selectorFecha.addEventListener('change', actualizarAgenda);
    
    // Bot칩n Actualizar manual
    btnActualizar?.addEventListener('click', actualizarAgenda);

    // --- 6. FUNCIONES GLOBALES PARA MODALES ---
    
    // A. Abrir Modal Nueva Reserva (Llamada desde dateClick)
    window.abrirModalNuevaReserva = function(empleadoId, empleadoNombre, fecha, hora) {
        formModalNuevaReserva.reset(); 
        
        // ASIGNAR VALORES AL FORMULARIO MODAL
        // 1. Sucursal (Desde el hidden input de la agenda)
        document.getElementById('modalSucursalId').value = selectorSucursal.value; 
        
        // 2. Informaci칩n Visual
        document.getElementById('modalEmpleadoNombre').textContent = empleadoNombre;
        // Formato fecha amigable (Ej: Lunes, 15 de Diciembre 2025)
        const fechaObj = new Date(fecha + 'T00:00:00');
        const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('modalFecha').textContent = fechaObj.toLocaleDateString('es-PE', opcionesFecha);
        document.getElementById('modalHoraInicio').textContent = hora;
        
        // 3. Inputs Ocultos para el POST
        document.getElementById('modalEmpleadoId').value = empleadoId;
        document.getElementById('modalFechaHoraInicioFull').value = `${fecha}T${hora}`;
        
        // Limpiar errores previos
        document.getElementById('modalErrores').style.display = 'none';
        
        // Mostrar Modal
        if (modalNuevaReservaInstancia) modalNuevaReservaInstancia.show();
    };

    // B. Enviar Formulario Nueva Reserva
    formModalNuevaReserva?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const errDiv = document.getElementById('modalErrores');
        
        // Estado de carga
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        errDiv.style.display = 'none';
        
        const payload = Object.fromEntries(new FormData(this));
        
        fetch("{{ url_for('main.nueva_reserva') }}", { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(payload) 
        })
        .then(res => res.json().then(d => ({ok: res.ok, data: d})))
        .then(res => {
            if (res.ok && res.data.success) { 
                modalNuevaReservaInstancia.hide(); 
                actualizarAgenda(); // Refrescar calendario
                // Opcional: Mostrar toast de 칠xito
            } else { 
                // Mostrar errores
                const mensajes = res.data.errors || [res.data.message];
                errDiv.innerHTML = mensajes.join('<br>'); 
                errDiv.style.display = 'block'; 
            }
        })
        .catch(err => { 
            errDiv.innerHTML = `Error de conexi칩n: ${err.message}`; 
            errDiv.style.display = 'block'; 
        })
        .finally(() => { 
            btn.disabled = false; 
            btn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Reserva'; 
        });
    });

    // --- 7. L칍GICA MODAL GESTIONAR RESERVA ---

    function abrirModalGestionarReserva(reservaId) {
        const modalTitle = document.getElementById('modalGestionarReservaLabel');
        const vistaDiv = document.getElementById('detalleReservaVista');
        const formEditar = document.getElementById('formEditarReservaModal');
        const erroresEditarDiv = document.getElementById('modalEditarErrores');
        
        // Botones de acci칩n
        const btnEditar = document.getElementById('btnModalEditarReserva');
        const btnCancelarReserva = document.getElementById('btnModalCancelarReserva');
        const btnCompletarReserva = document.getElementById('btnModalCompletarReserva');
        const btnRegistrarVenta = document.getElementById('btnModalRegistrarVenta'); // Bot칩n para ir a venta
        const btnCancelarEdicion = document.getElementById('btnModalCancelarEdicion');
        const btnGuardarCambios = document.getElementById('btnModalGuardarCambios');

        // Funci칩n interna para alternar entre "Ver detalles" y "Editar formulario"
        function cambiarModo(modoVista, data = null) {
            vistaDiv.style.display = modoVista ? 'block' : 'none';
            formEditar.style.display = modoVista ? 'none' : 'block';
            if (erroresEditarDiv) erroresEditarDiv.style.display = 'none';
            
            // Si la reserva ya termin칩 (Completada/Cancelada), ocultamos acciones de modificaci칩n
            const esFinal = data ? ['Completada', 'Cancelada', 'Cancelada por Cliente', 'Cancelada por Staff', 'No Asistio'].some(s => data.estado?.includes(s)) : true;
            
            if (btnEditar) btnEditar.style.display = modoVista && !esFinal ? 'inline-block' : 'none';
            if (btnCancelarReserva) btnCancelarReserva.style.display = modoVista && !esFinal ? 'inline-block' : 'none';
            if (btnCompletarReserva) btnCompletarReserva.style.display = modoVista && !esFinal ? 'inline-block' : 'none';
            
            // El bot칩n de venta solo aparece si est치 completada
            if (btnRegistrarVenta) btnRegistrarVenta.style.display = (data && data.estado === 'Completada') ? 'inline-block' : 'none';

            if (btnCancelarEdicion) btnCancelarEdicion.style.display = modoVista ? 'none' : 'inline-block';
            if (btnGuardarCambios) btnGuardarCambios.style.display = modoVista ? 'none' : 'inline-block';

            // Si entramos en modo edici칩n, poblamos el formulario
            if (!modoVista && data) {
                modalTitle.innerHTML = `<i class="fas fa-edit me-2"></i>Editando Reserva #${data.id}`;
                document.getElementById('editReservaId').value = data.id;
                
                const poblarSelect = (selId, items, valActual, txtCallback) => {
                    const sel = document.getElementById(selId);
                    sel.innerHTML = `<option value="">Seleccione...</option>`;
                    items.forEach(item => { sel.add(new Option(txtCallback(item), item.id)); });
                    sel.value = valActual;
                };
                
                // Usamos las listas globales cargadas al inicio
                poblarSelect('editClienteId', todosLosClientes, data.cliente_id, item => `${item.razon_social_nombres} ${item.apellidos || ''}`);
                // Aqu칤 usamos todosLosEmpleadosParaSelector (que ya viene filtrado por sucursal desde backend)
                poblarSelect('editEmpleadoId', todosLosEmpleadosParaSelector, data.empleado_id, item => `${item.nombres} ${item.apellidos}`);
                poblarSelect('editServicioId', todosLosServiciosActivos, data.servicio_id, item => `${item.nombre} (${item.duracion_minutos} min)`);
                
                if (data.fecha_hora_inicio) document.getElementById('editFechaHoraInicio').value = data.fecha_hora_inicio.slice(0, 16);
                document.getElementById('editPrecioCobrado').value = data.precio_cobrado ? parseFloat(data.precio_cobrado).toFixed(2) : '';
                document.getElementById('editNotasCliente').value = data.notas_cliente || '';
                document.getElementById('editNotasInternas').value = data.notas_internas || '';
            }
        }
        
        // Estado inicial: Cargando
        cambiarModo(true);
        modalTitle.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Cargando...`;
        if(modalGestionarInstancia) modalGestionarInstancia.show();

        // Obtener datos del servidor
        fetch(`/api/reservas/${reservaId}`)
            .then(r => r.ok ? r.json() : Promise.reject('No se pudieron cargar los datos.'))
            .then(data => {
                datosReservaActualParaModal = data; 
                modalTitle.innerHTML = `<i class="fas fa-calendar-check me-2"></i>Detalles de Reserva #${data.id}`;
                const inicioDT = new Date(data.fecha_hora_inicio);
                
                // Construir vista de detalles
                vistaDiv.innerHTML = `
                    <dl class="row">
                        <dt class="col-sm-4">Estado:</dt><dd class="col-sm-8"><span class="badge bg-secondary">${data.estado}</span></dd>
                        <dt class="col-sm-4">Cliente:</dt><dd class="col-sm-8">${data.cliente_nombre_completo||'-'}</dd>
                        <dt class="col-sm-4">Colaborador:</dt><dd class="col-sm-8">${data.empleado_nombre_completo||'-'}</dd>
                        <dt class="col-sm-4">Servicio:</dt><dd class="col-sm-8">${data.servicio_nombre||'-'}</dd>
                        <dt class="col-sm-4">Inicio:</dt><dd class="col-sm-8">${inicioDT.toLocaleString('es-PE')}</dd>
                        <dt class="col-sm-4">Notas:</dt><dd class="col-sm-8 text-muted small">${data.notas_cliente || 'Sin notas'}</dd>
                    </dl>`;
                
                // Configurar enlace al bot칩n de venta si existe
                if (btnRegistrarVenta) {
                    btnRegistrarVenta.href = `{{ url_for('main.nueva_venta') }}?reserva_id=${reservaId}`;
                }
                
                cambiarModo(true, data);
            })
            .catch(error => { vistaDiv.innerHTML = `<p class="text-danger">${error}</p>`; });
        
        // --- Asignar Eventos a los Botones del Modal ---
        if (btnEditar) btnEditar.onclick = () => { if(datosReservaActualParaModal) cambiarModo(false, datosReservaActualParaModal); };
        if (btnCancelarEdicion) btnCancelarEdicion.onclick = () => { if(datosReservaActualParaModal) cambiarModo(true, datosReservaActualParaModal); };
        
        // Acci칩n Cancelar Reserva
        if (btnCancelarReserva) btnCancelarReserva.onclick = () => { 
            if (confirm(`쯉eguro que quieres CANCELAR la reserva #${reservaId}?`)) { 
                fetch(`/reservas/cancelar/${reservaId}`, {method: 'POST'})
                .then(r=>r.json())
                .then(res=>{ 
                    if(res.success){ 
                        modalGestionarInstancia.hide(); 
                        actualizarAgenda(); // Refresca el calendario sin recargar p치gina
                        alert(res.message); 
                    } else {
                        alert(res.message);
                    }
                });
            }
        };

        // Acci칩n Completar Reserva
        if (btnCompletarReserva) btnCompletarReserva.onclick = () => {
            if (confirm(`쯉eguro que quieres marcar como COMPLETADA la reserva #${reservaId}?`)) {
                fetch(`/api/reservas/${reservaId}/completar`, {method: 'POST'})
                .then(r => r.json())
                .then(res => {
                    alert(res.message);
                    if (res.success && res.redirect_url) {
                        window.location.href = res.redirect_url; // Ir a pagar
                    } else {
                        modalGestionarInstancia.hide();
                        actualizarAgenda(); // Refrescar calendario
                    }
                });
            }
        }; 
    }

    // Listener para el formulario de EDICI칍N dentro del modal
    document.getElementById('formEditarReservaModal')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnModalGuardarCambios');
        const errDiv = document.getElementById('modalEditarErrores');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        errDiv.style.display = 'none';

        const reservaId = datosReservaActualParaModal.id;
        const payload = Object.fromEntries(new FormData(this));
        
        fetch(`/reservas/editar/${reservaId}`, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(payload) 
        })
        .then(res => res.json().then(d => ({ok: res.ok, data: d})))
        .then(res => {
            if (res.ok && res.data.success) { 
                modalGestionarInstancia.hide(); 
                actualizarAgenda(); // Refrescar calendario
                alert(res.data.message); 
            }
            else { 
                errDiv.innerHTML = (res.data.errors || [res.data.message]).join('<br>'); 
                errDiv.style.display = 'block'; 
            }
        })
        .catch(err => { errDiv.innerHTML = `Error: ${err.message}`; errDiv.style.display = 'block'; })
        .finally(() => { btn.disabled = false; btn.textContent = 'Guardar Cambios'; });
    });
});
</script>
{% endblock scripts %}