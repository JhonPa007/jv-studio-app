{% extends "base.html" %}

{% block title %}Agenda Diaria de Citas - JV Studio{% endblock %}

{% block head_extra %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>

<style>
    /* --- 1. Contenedor Principal --- */
    #calendar { 
        border: 1px solid #d1d5db; 
        border-radius: 8px; 
        /* padding: 10px;  <-- QUITAMOS el padding interno para que el scroll llegue al borde */
        padding: 0;
        background-color: #ffffff;
        
        /* CAMBIO CLAVE: Altura din치mica */
        /* 100vh es el alto total de la pantalla. Le restamos aprox 250px 
        (que es lo que ocupan tu barra negra superior + los controles de filtros) */
        /*height: calc(100vh - 250px); */
        
        /* Esto es vital: */
        /*overflow: hidden; */
        min-height: 500px; /* Solo por seguridad si falla el JS */
        overflow: hidden; /* Mantiene bordes redondeados */
    }

    /* Opcional: Asegurar que el scroll interno se vea elegante */
    .fc-scroller::-webkit-scrollbar {
        width: 8px;
    }
    .fc-scroller::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
    }
    
    /* Barra de Herramientas */
    #controlesAgenda { 
        background-color: #212529; 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        display: flex; 
        gap: 15px; 
        align-items: center; 
        flex-wrap: wrap; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* --- ESTILOS PARA AVATAR EN CABECERA (TIPO FRESHA) --- */

    .staff-header-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px 0;
        width: 100%; /* Asegura que ocupe la celda */
    }

    .staff-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%; /* C칤rculo perfecto */
        object-fit: cover; /* Evita que la foto se estire */
        margin-bottom: 8px;
        border: 2px solid #ffffff; /* Anillo blanco alrededor */
        box-shadow: 0 3px 6px rgba(0,0,0,0.15); /* Sombra suave */
        background-color: #f3f4f6;
    }

    /* Estilo para cuando NO hay foto (Iniciales) */
    .staff-initials {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6c63ff 0%, #5a52d6 100%); /* Tu color morado */
        color: white;
        font-size: 1.2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        border: 2px solid #ffffff;
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        text-transform: uppercase;
    }

    .staff-name {
        font-size: 0.9rem;
        font-weight: 700;
        color: #1f2937;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* --- 2. ESTILO TIPO "FRESHA" (FullCalendar) --- */

    /* A. FONDO RAYADO BASE */
    .fc-timegrid-col {
        background-color: #f3f4f6 !important;
        background-image: repeating-linear-gradient(
            45deg,
            #e5e7eb,
            #e5e7eb 2px,
            #f3f4f6 2px,
            #f3f4f6 10px
        ) !important;
    }
    
    /* B. CELDAS PRINCIPALES (SLOTS) */
    /* CR칈TICO: position relative hace que la barra hover se limite al ancho de la columna */
    .fc-timegrid-slot {
        position: relative !important; 
        z-index: 1;
        border-bottom: 1px solid #efefef !important; /* L칤neas muy suaves */
    }

    /* C. FONDO BLANCO PARA TURNOS DISPONIBLES 
       (Esto normalmente lo maneja FullCalendar con eventos de fondo, 
       pero aseguramos que no tapen la barra hover con z-index) */
    .fc-bg-event {
        opacity: 1.0 !important; 
        z-index: 2 !important; /* Nivel intermedio */
    }
    
    /* D. HEADER Y TEXTOS */
    .fc-col-header-cell {
        background-color: #ffffff !important;
        border-bottom: 2px solid #e5e7eb !important;
        vertical-align: middle; 
    }
    .fc-col-header-cell-cushion { 
        color: #111827 !important; 
        font-weight: 700 !important;
        text-transform: uppercase;
        font-size: 0.9rem;
        padding: 15px 0 !important;
    }
    .fc-timegrid-slot-label-cushion { 
        color: #6b7280 !important; 
        font-size: 0.85em;
        font-weight: 600;
    }
    .fc-theme-standard td, .fc-theme-standard th {
        border-color: #ffffff !important; 
    }
    
    /* E. TARJETAS DE CITAS (EVENTOS) */
    .fc-event { 
        border: none !important; 
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        margin: 1px 2px !important; 
        z-index: 50 !important; /* Siempre encima de todo */
    }
    .fc-event-main { 
        color: #ffffff !important; 
        font-weight: 600;
        padding: 2px 4px;
        font-size: 0.85rem;
    }
    
    /* INDICADOR DE HORA ACTUAL (L칤nea Roja) */
    .fc-timegrid-now-indicator-line {
        border-color: #ef4444; 
        border-width: 2px;
        z-index: 51;
    }
    .fc-timegrid-now-indicator-arrow {
        border-color: #ef4444;
        z-index: 51;
    }
    .fc-day-today {
        background-color: transparent !important;
    }

    /* --- CORRECCIONES VISUALES --- */
    .fc .fc-timegrid-axis-cushion,
    .fc .fc-timegrid-axis-frame,
    .fc .fc-timegrid-axis {
        background-color: #ffffff !important;
    }
    .fc-theme-standard .fc-scrollgrid {
        border-color: #e5e7eb;
    }

    /* =========================================
       NUEVO: EFECTO HOVER TIPO FRESHA 
       ========================================= */
    /* 1. La barra flotante */
    #indicadorHoraHover {
        position: absolute;
        left: 0;
        right: 0;
        min-height: 20px; 
        background-color: rgba(108, 99, 255, 0.25); 
        border-left: 4px solid #5a52d6;
        color: #5a52d6;
        font-size: 0.8rem; /* Un poco m치s peque침o para que quepa bien */
        font-weight: 800;
        
        /* ALINEACI칍N SUPERIOR IZQUIERDA */
        display: none; /* Se activa con JS */
        flex-direction: row;
        align-items: flex-start; /* Alinea al TOP */
        justify-content: flex-start; /* Alinea a la IZQUIERDA */
        padding-top: 2px; /* Espacio desde arriba */
        padding-left: 6px; /* Espacio desde la izquierda */
        
        pointer-events: none; 
        z-index: 1000; 
        border-radius: 2px;
    }

    /* 2. IMPORTANTE: Quitamos el position relative de los slots horizontales
    para evitar conflictos de apilamiento */
    .fc-timegrid-slot {
        position: static !important;
        z-index: auto !important;
    }

    /* 3. Aseguramos que las COLUMNAS sean el referente relativo */
    .fc-timegrid-col {
        position: relative !important;
    }

</style>
{% endblock head_extra %}

{% block content %}
<div class="container-fluid mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: var(--color-acento-dorado);"><i class="fas fa-calendar-day me-2"></i>Agenda Diaria</h2>
        <span class="badge bg-warning text-dark fs-6 shadow-sm">
            <i class="fas fa-map-marker-alt me-2"></i>Sucursal: {{ session.get('sucursal_nombre', 'Actual') }}
        </span>
    </div>

    <div id="controlesAgenda" class="d-flex flex-wrap align-items-center gap-3 p-3 rounded mb-4" style="background-color: #3a3a3a;">
        
        <input type="hidden" id="selectorSucursalAgenda" value="{{ session.get('sucursal_id') }}">

        <div class="ms-md-3">
            <label for="selectorFechaAgenda" class="form-label text-light small fw-bold">Fecha:</label>
            <div class="d-flex align-items-center">
                <button id="btnDiaAnterior" class="btn btn-outline-light btn-sm"><i class="fas fa-chevron-left"></i></button>
                <input type="date" id="selectorFechaAgenda" class="form-control form-control-sm mx-1 fw-bold text-center" style="width: 140px;">
                <button id="btnDiaSiguiente" class="btn btn-outline-light btn-sm"><i class="fas fa-chevron-right"></i></button>
                <button id="btnHoy" class="btn btn-warning btn-sm ms-2 fw-bold text-dark"><i class="fas fa-calendar-day me-1"></i> Hoy</button>
            </div>
        </div>
        
        <div class="ms-md-3 mt-2 mt-md-0">
            <label for="selectorEmpleadosAgenda" class="form-label text-light small fw-bold">Filtrar Colaboradores:</label>
            <select multiple class="form-select form-select-sm" id="selectorEmpleadosAgenda" style="width: 250px; min-height: 38px; display: inline-block; vertical-align: middle;">
                {% if not empleados_para_selector %}
                    <option value="" disabled>No hay colaboradores disponibles</option>
                {% else %}
                    {% for emp in empleados_para_selector %}
                        <option value="{{ emp.id }}" selected>{{ emp.nombres }} {{ emp.apellidos }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        
        <div class="ms-md-auto mt-2 mt-md-0">
            <button id="btnActualizarAgenda" class="btn btn-primary btn-sm fw-bold shadow-sm">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
    </div>
    
    <div id='calendar' class="mt-4 shadow-lg"></div>

    {% include 'reservas/_modal_nueva_reserva.html' %}
    {% include 'reservas/_modal_gestionar_reserva.html' %}
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Selectores
    const selectorSucursal = document.getElementById('selectorSucursalAgenda');
    const selectorFecha = document.getElementById('selectorFechaAgenda');
    const btnActualizar = document.getElementById('btnActualizarAgenda');
    const agendaContainer = document.getElementById('calendar');
    
    // Instancias Modales
    const modalNuevaReservaElement = document.getElementById('modalNuevaReserva');
    const modalNuevaReservaInstancia = modalNuevaReservaElement ? new bootstrap.Modal(modalNuevaReservaElement) : null;
    const formModalNuevaReserva = document.getElementById('formNuevaReservaModal');

    const modalGestionarElement = document.getElementById('modalGestionarReserva');
    const modalGestionarInstancia = modalGestionarElement ? new bootstrap.Modal(modalGestionarElement) : null;

    // Datos Globales
    const todosLosClientes = JSON.parse('{{ clientes_todos | tojson | safe }}');
    const todosLosServiciosActivos = JSON.parse('{{ servicios_todos_activos | tojson | safe }}');
    const todosLosEmpleadosParaSelector = JSON.parse('{{ empleados_para_selector | tojson | safe }}');

    let datosApiAgenda = null; 
    let datosReservaActualParaModal = null; 

    // Actualizar precio autom치ticamente al cambiar el servicio (Modo Edici칩n)
    const selectServicioEdit = document.getElementById('editServicioId');
    const inputPrecioEdit = document.getElementById('editPrecioCobrado');
    if (selectServicioEdit && inputPrecioEdit) {
        selectServicioEdit.addEventListener('change', function() {
            const idSeleccionado = this.value;
            const servicio = todosLosServiciosActivos.find(s => s.id == idSeleccionado);
            if (servicio) {
                inputPrecioEdit.value = parseFloat(servicio.precio).toFixed(2);
            }
        });
    }

    // 2. Funci칩n Fecha Local
    function setFechaLocal() {
        if (selectorFecha) { 
            const now = new Date();
            const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            selectorFecha.value = localDate.toISOString().slice(0,10); 
        }
    }
    if (!selectorFecha.value) setFechaLocal();

    // 3. Inicializar FullCalendar
    const calendar = new FullCalendar.Calendar(agendaContainer, {
        schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
        initialView: 'resourceTimeGridDay',
        locale: 'es',
        headerToolbar: false,
        height: 'calc(100vh - 190px)',
        allDaySlot: false,

        // 游릭 CONFIGURACI칍N DE IM츼GENES DE COLABORADORES
        resourceLabelContent: function(arg) {
            const recurso = arg.resource;
            const props = recurso.extendedProps || {};
            const imagenUrl = props.imagen_url || props.foto || null; 
            const nombre = recurso.title;

            // 1. Crear el contenedor
            const container = document.createElement('div');
            container.className = 'staff-header-container'; 

            // 2. L칩gica de Imagen vs Iniciales
            if (imagenUrl) {
                const img = document.createElement('img');
                img.src = imagenUrl;
                img.className = 'staff-avatar';
                
                // Si la imagen falla al cargar, mostramos las iniciales
                img.onerror = function() {
                    this.style.display = 'none';
                    container.insertBefore(crearIniciales(nombre), container.firstChild);
                };
                container.appendChild(img);
            } else {
                // Si no hay URL de imagen, mostramos iniciales
                container.appendChild(crearIniciales(nombre));
            }

            // 3. Agregar el Nombre (ESTO FALTABA)
            const nombreSpan = document.createElement('span');
            nombreSpan.className = 'staff-name';
            nombreSpan.innerText = nombre;
            container.appendChild(nombreSpan);

            // 4. Devolver el DOM al calendario (ESTO FALTABA)
            return { domNodes: [container] };
        },    
        
        slotDuration: '00:15:00',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        slotLabelInterval: '01:00',
        stickyHeaderDates: true,
        nowIndicator: true,
        editable: true,
        droppable: true,
        selectable: false, // Usamos dateClick customizado, no la selecci칩n nativa visual
        slotLabelFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short', omitZeroMinute: false },
        eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },
        
        // Fuentes de Datos
        resources: function(fetchInfo, successCallback, failureCallback) {
            const sucursalId = selectorSucursal.value;
            if (!sucursalId) { successCallback([]); return; }
            fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                .then(res => res.json()).then(data => successCallback(data.recursos)).catch(err => failureCallback(err));
        },
        events: function(fetchInfo, successCallback, failureCallback) {
            const sucursalId = selectorSucursal.value;
            if (!sucursalId) { successCallback([]); return; }
            fetch(`/api/agenda_dia_data?fecha=${selectorFecha.value}&sucursal_id=${sucursalId}`)
                .then(res => res.json()).then(data => {
                    datosApiAgenda = data;
                    successCallback(data.eventos);
                }).catch(err => failureCallback(err));
        },
        
        // A. Clic en espacio vac칤o
        dateClick: function(info) {
            if (!datosApiAgenda || !datosApiAgenda.eventos) return;

            const slotDT = new Date(info.dateStr).getTime();
            const colaboradorId = info.resource.id;

            // Validar Horario Habil (Color blanco o clase turno-disponible)
            const esHorarioHabil = datosApiAgenda.eventos.some(evento => 
                evento.resourceId == colaboradorId &&
                evento.display === 'background' &&
                (evento.backgroundColor === '#ffffff' || (evento.classNames && evento.classNames.includes('turno-disponible'))) &&
                new Date(evento.start).getTime() <= slotDT &&
                new Date(evento.end).getTime() > slotDT
            );

            // Validar Ausencia (Rojo)
            const enAusencia = datosApiAgenda.eventos.some(evento => 
                evento.resourceId == colaboradorId &&
                evento.display === 'background' &&
                evento.backgroundColor.includes('220, 53, 69') &&
                new Date(evento.start).getTime() <= slotDT &&
                new Date(evento.end).getTime() > slotDT
            );
            
            if (esHorarioHabil && !enAusencia) {
                const hora = info.dateStr.slice(11, 16);
                abrirModalNuevaReserva(info.resource.id, info.resource.title, info.dateStr.slice(0, 10), hora);
            } else {
                console.log("Clic en zona no disponible");
            }
        },
        
        // B. Clic en Evento
        eventClick: function(info) {
            if (info.event.id) abrirModalGestionarReserva(info.event.id);
        },

        // C. Arrastrar y Soltar
        eventDrop: function(info) {
            const reservaId = info.event.id;
            const nuevoInicio = info.event.start;
            const nuevoColaboradorId = info.event.getResources()[0].id;

            if (nuevoInicio < new Date()) {
                alert("No se puede mover una reserva al pasado.");
                info.revert(); return;
            }
            if (!confirm("쯉eguro que deseas mover esta reserva?")) {
                info.revert(); return;
            }
            
            fetch('/reservas/reagendar', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reserva_id: reservaId, nuevo_inicio: nuevoInicio.toISOString(), nuevo_colaborador_id: nuevoColaboradorId })
            })
            .then(res => res.json().then(d => ({ok: res.ok, data: d})))
            .then(result => {
                if (!result.ok) { alert(result.data.message); info.revert(); }
                else { actualizarAgenda(); }
            })
            .catch(err => { alert("Error de red."); info.revert(); });
        },
    });

    calendar.render();
    
    // --- 4. FUNCIONES AUXILIARES ---
    function actualizarAgenda() {
        calendar.refetchResources();
        calendar.refetchEvents();
        calendar.gotoDate(selectorFecha.value);
    }

    // --- 5. LISTENERS BOTONES DE FECHA ---
    document.getElementById('btnDiaAnterior').addEventListener('click', () => { 
        const d = new Date(selectorFecha.value + 'T00:00:00'); d.setDate(d.getDate() - 1); 
        selectorFecha.value = d.toISOString().slice(0,10); actualizarAgenda(); 
    });
    document.getElementById('btnDiaSiguiente').addEventListener('click', () => { 
        const d = new Date(selectorFecha.value + 'T00:00:00'); d.setDate(d.getDate() + 1); 
        selectorFecha.value = d.toISOString().slice(0,10); actualizarAgenda(); 
    });
    document.getElementById('btnHoy').addEventListener('click', () => { 
        setFechaLocal(); actualizarAgenda(); 
    });
    selectorFecha.addEventListener('change', actualizarAgenda);
    btnActualizar?.addEventListener('click', actualizarAgenda);

    // --- 6. GESTI칍N DE MODALES (Nueva / Editar) ---
    // (L칩gica id칠ntica a tu c칩digo original, resumida aqu칤 para brevedad)
    window.abrirModalNuevaReserva = function(empleadoId, empleadoNombre, fecha, hora) {
        formModalNuevaReserva.reset(); 
        document.getElementById('modalSucursalId').value = selectorSucursal.value; 
        document.getElementById('modalEmpleadoNombre').textContent = empleadoNombre;
        const fechaObj = new Date(fecha + 'T00:00:00');
        document.getElementById('modalFecha').textContent = fechaObj.toLocaleDateString('es-PE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('modalHoraInicio').textContent = hora;
        document.getElementById('modalEmpleadoId').value = empleadoId;
        document.getElementById('modalFechaHoraInicioFull').value = `${fecha}T${hora}`;
        document.getElementById('modalErrores').style.display = 'none';
        if (modalNuevaReservaInstancia) modalNuevaReservaInstancia.show();
    };

    formModalNuevaReserva?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const errDiv = document.getElementById('modalErrores');
        
        // 1. Recopilar datos b치sicos del formulario
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        // 2. 游릭 AGREGAR VALOR DEL CHECKBOX (True/False)
        const chk = document.getElementById('chkEnviarWhatsApp');
        data.enviar_whatsapp = chk ? chk.checked : false;

        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        errDiv.style.display = 'none';
        
        // 3. Enviar al Backend
        fetch("{{ url_for('main.nueva_reserva') }}", { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(data) 
        })
        .then(res => res.json().then(d => ({ok: res.ok, data: d})))
        .then(res => {
            if (res.ok && res.data.success) { 
                // A. Cerrar modal y refrescar calendario
                modalNuevaReservaInstancia.hide(); 
                actualizarAgenda(); 
                
                // B. 游릭 L칍GICA DE WHATSAPP CLICK-TO-CHAT
                if (res.data.whatsapp_url) {
                    // Si el backend devolvi칩 una URL, la abrimos en nueva pesta침a
                    window.open(res.data.whatsapp_url, '_blank');
                } else if (data.enviar_whatsapp) {
                    // Si el usuario marc칩 el check pero no hubo URL (ej: cliente sin tel칠fono)
                    alert("Reserva guardada correctamente, pero no se pudo generar el enlace de WhatsApp (verifique que el cliente tenga tel칠fono registrado).");
                }
            }
            else { 
                // C. Mostrar errores del servidor
                errDiv.innerHTML = (res.data.errors || [res.data.message]).join('<br>'); 
                errDiv.style.display = 'block'; 
            }
        })
        .catch(err => { 
            errDiv.innerHTML = `Error de conexi칩n: ${err.message}`; 
            errDiv.style.display = 'block'; 
        })
        .finally(() => { 
            btn.disabled = false; 
            btn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Reserva'; 
        });
    });


    function abrirModalGestionarReserva(reservaId) {
        const modalTitle = document.getElementById('modalGestionarReservaLabel');
        const vistaDiv = document.getElementById('detalleReservaVista');
        const formEditar = document.getElementById('formEditarReservaModal');
        
        // Botones existentes del HTML
        const btnEditar = document.getElementById('btnModalEditarReserva');
        const btnCancelar = document.getElementById('btnModalCancelarReserva');
        const btnCompletar = document.getElementById('btnModalCompletarReserva');
        const btnVenta = document.getElementById('btnModalRegistrarVenta');
        const btnCancelarEdicion = document.getElementById('btnModalCancelarEdicion');
        const btnGuardar = document.getElementById('btnModalGuardarCambios');
        
        // 游릭 INYECCI칍N DIN츼MICA DE BOTONES WHATSAPP
        // Buscamos el footer para insertar los botones si no existen
        const modalFooter = document.querySelector('#modalGestionarReserva .modal-footer');
        
        // 1. Bot칩n Recordar (Cliente)
        let btnRecordarWs = document.getElementById('btnDynamicRecordar');
        if (!btnRecordarWs) {
            btnRecordarWs = document.createElement('button');
            btnRecordarWs.id = 'btnDynamicRecordar';
            btnRecordarWs.className = 'btn btn-success btn-sm shadow-sm me-1';
            btnRecordarWs.innerHTML = '<i class="fab fa-whatsapp me-1"></i> Recordar';
            // Insertamos al principio del footer
            modalFooter.insertBefore(btnRecordarWs, modalFooter.firstChild);
        }

        // 2. Bot칩n Avisar Staff (Google Calendar)
        let btnAvisarStaff = document.getElementById('btnDynamicStaff');
        if (!btnAvisarStaff) {
            btnAvisarStaff = document.createElement('button');
            btnAvisarStaff.id = 'btnDynamicStaff';
            btnAvisarStaff.className = 'btn btn-info btn-sm shadow-sm me-auto text-white';
            btnAvisarStaff.innerHTML = '<i class="fas fa-user-clock me-1"></i> Avisar Staff';
            // Insertamos despu칠s del de recordar
            btnRecordarWs.after(btnAvisarStaff);
        }

        function cambiarModo(modoVista, data = null) {
            if(vistaDiv) vistaDiv.style.display = modoVista ? 'block' : 'none';
            if(formEditar) formEditar.style.display = modoVista ? 'none' : 'block';
            
            let esFinal = false;
            let estadoActual = '';
            if (data) {
                estadoActual = data.estado || '';
                const estadosFinales = ['Completada', 'Cancelada', 'Cancelada por Cliente', 'Cancelada por Staff', 'No Asistio'];
                esFinal = estadosFinales.some(s => estadoActual.includes(s));
            } else { esFinal = true; }

            const mostrarAcciones = modoVista && !esFinal;
            
            if (btnEditar) btnEditar.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnCancelar) btnCancelar.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnCompletar) btnCompletar.style.display = mostrarAcciones ? 'inline-block' : 'none';
            if (btnVenta) btnVenta.style.display = (data && estadoActual === 'Completada') ? 'inline-block' : 'none';
            if (btnCancelarEdicion) btnCancelarEdicion.style.display = modoVista ? 'none' : 'inline-block';
            if (btnGuardar) btnGuardar.style.display = modoVista ? 'none' : 'inline-block';

            // 游릭 VISIBILIDAD DE BOTONES WHATSAPP
            // Solo visibles en modo lectura y si la reserva est치 activa
            const showWs = modoVista && !esFinal;
            if (btnRecordarWs) btnRecordarWs.style.display = showWs ? 'inline-block' : 'none';
            if (btnAvisarStaff) btnAvisarStaff.style.display = showWs ? 'inline-block' : 'none';

            if (!modoVista && data) {
                 modalTitle.innerHTML = `<i class="fas fa-edit me-2"></i>Editando Reserva #${data.id}`;
                 document.getElementById('editReservaId').value = data.id;
                 const poblar = (id, items, val) => {
                     const s = document.getElementById(id); if(!s) return;
                     s.innerHTML = '<option value="">Sel...</option>';
                     items.forEach(i => s.add(new Option(i.nombres || i.nombre || i.razon_social_nombres, i.id)));
                     s.value = val;
                 };
                 poblar('editClienteId', todosLosClientes, data.cliente_id);
                 poblar('editEmpleadoId', todosLosEmpleadosParaSelector, data.empleado_id);
                 poblar('editServicioId', todosLosServiciosActivos, data.servicio_id);
                 if(document.getElementById('editFechaHoraInicio')) document.getElementById('editFechaHoraInicio').value = data.fecha_hora_inicio.slice(0, 16);
                 if(document.getElementById('editPrecioCobrado')) document.getElementById('editPrecioCobrado').value = data.precio_cobrado;
            }
        }
        
        cambiarModo(true);
        if(modalGestionarInstancia) modalGestionarInstancia.show();

        fetch(`/api/reservas/${reservaId}`)
            .then(r => r.json())
            .then(data => {
                datosReservaActualParaModal = data;
                if(modalTitle) modalTitle.innerHTML = `<i class="fas fa-calendar-check me-2"></i>Reserva #${data.id}`;
                
                if(vistaDiv) {
                    // Agregamos tel칠fonos al detalle para referencia visual
                    const telC = data.tel_cliente || 'Sin registrar';
                    const telS = data.tel_staff || 'Sin registrar';
                    
                    vistaDiv.innerHTML = `
                        <dl class="row mb-0">
                            <dt class="col-4">Estado</dt><dd class="col-8"><span class="badge bg-secondary">${data.estado}</span></dd>
                            <dt class="col-4">Cliente</dt><dd class="col-8">${data.cliente_nombre_completo} <small class="text-muted">(${telC})</small></dd>
                            <dt class="col-4">Servicio</dt><dd class="col-8">${data.servicio_nombre}</dd>
                            <dt class="col-4">Hora</dt><dd class="col-8 fw-bold">${new Date(data.fecha_hora_inicio).toLocaleString()}</dd>
                            <dt class="col-4">Staff</dt><dd class="col-8">${data.empleado_nombre || 'N/A'} <small class="text-muted">(${telS})</small></dd>
                        </dl>`;
                }
                if(btnVenta) btnVenta.href = `{{ url_for('main.nueva_venta') }}?reserva_id=${reservaId}`;
                
                // 游릭 EVENTO CLICK: RECORDAR CLIENTE
                btnRecordarWs.onclick = function() {
                    const originalHtml = this.innerHTML;
                    this.disabled = true; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
                    fetch(`/api/reservas/${reservaId}/whatsapp-link?tipo=recordatorio`)
                        .then(r => r.json())
                        .then(resp => {
                            if (resp.success) window.open(resp.url, '_blank');
                            else alert("Error: " + resp.message);
                        })
                        .finally(() => { this.disabled = false; this.innerHTML = originalHtml; });
                };

                // 游릭 EVENTO CLICK: AVISAR STAFF (Calendario)
                btnAvisarStaff.onclick = function() {
                    const originalHtml = this.innerHTML;
                    this.disabled = true; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
                    fetch(`/api/reservas/${reservaId}/whatsapp-link?tipo=aviso_staff`)
                        .then(r => r.json())
                        .then(resp => {
                            if (resp.success) window.open(resp.url, '_blank');
                            else alert("Error: " + resp.message);
                        })
                        .finally(() => { this.disabled = false; this.innerHTML = originalHtml; });
                };

                cambiarModo(true, data);
            });

        if (btnEditar) btnEditar.onclick = () => cambiarModo(false, datosReservaActualParaModal);
        if (btnCancelarEdicion) btnCancelarEdicion.onclick = () => cambiarModo(true, datosReservaActualParaModal);
        
        if (btnCancelar) btnCancelar.onclick = () => { 
             if(confirm('쮺ancelar reserva?')) fetch(`/reservas/cancelar/${reservaId}`, {method:'POST'}).then(()=>{ modalGestionarInstancia.hide(); actualizarAgenda(); }); 
        };
        if (btnCompletar) btnCompletar.onclick = () => {
             if(confirm('쯄arcar como completada?')) fetch(`/api/reservas/${reservaId}/completar`, {method:'POST'}).then(()=>{ modalGestionarInstancia.hide(); actualizarAgenda(); });
        };
    }
        
    document.getElementById('formEditarReservaModal')?.addEventListener('submit', function(e) {
        e.preventDefault();
        fetch(`/reservas/editar/${datosReservaActualParaModal.id}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Object.fromEntries(new FormData(this))) })
        .then(res => res.json()).then(d => { if(d.success){ modalGestionarInstancia.hide(); actualizarAgenda(); } else { alert(d.message); } });
    });

    // =========================================================
    // 游릭 MAGIA: EFECTO HOVER (C츼LCULO MATEM츼TICO DE HORA)
    // =========================================================
    
    const indicadorDiv = document.createElement('div');
    indicadorDiv.id = 'indicadorHoraHover';
    
    // Configuraci칩n de tu agenda (DEBE COINCIDIR con tu calendar options)
    const HORA_INICIO = 8; // 08:00 AM
    const MINUTOS_SLOT = 15; // 15 minutos

    agendaContainer.addEventListener('mousemove', function(e) {
        // 1. Detectar Columna
        const target = document.elementFromPoint(e.clientX, e.clientY);
        if (!target) return;
        const col = target.closest('.fc-timegrid-col');
        
        // Si no estamos en columna o estamos en cabecera, adi칩s
        if (!col || target.closest('.fc-col-header')) {
            indicadorDiv.style.display = 'none';
            return;
        }

        // 2. Detectar Altura de Slot (Referencia)
        const primerSlot = document.querySelector('.fc-timegrid-slot');
        const slotHeight = primerSlot ? primerSlot.offsetHeight : 22; 

        // 3. C치lculos de Posici칩n
        const rectCol = col.getBoundingClientRect();
        const relativeY = e.clientY - rectCol.top;
        
        // "Imantar" al slot m치s cercano
        // Math.floor(relativeY / slotHeight) nos da el 칤ndice del slot (0, 1, 2...)
        const slotIndex = Math.floor(relativeY / slotHeight);
        const snappedY = slotIndex * slotHeight;

        // 4. Mover la Barra
        if (indicadorDiv.parentElement !== col) {
            col.appendChild(indicadorDiv);
            indicadorDiv.style.display = 'flex';
            indicadorDiv.style.height = `${slotHeight}px`; 
            indicadorDiv.style.width = '100%'; 
        }
        indicadorDiv.style.top = `${snappedY}px`;

        // 5. CALCULAR LA HORA MATEM츼TICAMENTE (Infalible)
        // Total minutos desde el inicio (8:00) = index * 15
        const minutosDesdeInicio = slotIndex * MINUTOS_SLOT;
        
        const fechaBase = new Date();
        fechaBase.setHours(HORA_INICIO, 0, 0, 0); // 08:00:00
        fechaBase.setMinutes(fechaBase.getMinutes() + minutosDesdeInicio);

        // Formatear: 10:15 a. m.
        const horaStr = fechaBase.toLocaleTimeString('es-PE', {
            hour: 'numeric', 
            minute: '2-digit', 
            hour12: true 
        });

        indicadorDiv.innerHTML = `<i class="fas fa-clock me-1" style="font-size: 0.7rem; margin-top: 3px;"></i> ${horaStr}`;
    });

    agendaContainer.addEventListener('mouseleave', function() {
        indicadorDiv.style.display = 'none';
    });
    // Funci칩n para crear el c칤rculo con iniciales
    function crearIniciales(nombre) {
        const div = document.createElement('div');
        div.style.width = '50px';
        div.style.height = '50px';
        div.style.borderRadius = '50%';
        div.style.backgroundColor = '#6c63ff'; // Tu color morado
        div.style.color = '#ffffff';
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.justifyContent = 'center';
        div.style.fontWeight = 'bold';
        div.style.fontSize = '1.2rem';
        div.style.border = '2px solid #fff';
        div.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        div.style.marginBottom = '5px';
        div.innerText = nombre ? nombre.charAt(0).toUpperCase() : '?';
        return div;
    }
});
</script>

{% endblock scripts %}