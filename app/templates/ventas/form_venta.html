{% extends "base.html" %}

{% block title %}Nueva Venta - JV Studio{% endblock %}

{% block head_extra %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
    /* --- ESTILOS GENERALES --- */
    .venta-header {
        background-color: var(--color-bg-card);
        /* Use theme var */
        padding: 20px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        border: 1px solid var(--color-border);
    }

    .venta-section {
        background-color: var(--color-bg-card);
        padding: 20px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        border: 1px solid var(--color-border);
    }

    .total-display {
        font-size: 2rem;
        font-weight: bold;
        color: var(--color-accent);
        text-align: right;
    }

    .balance-display {
        font-size: 1.2rem;
        text-align: right;
        color: var(--color-text-primary);
    }

    .table-items th {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--color-text-primary);
        border-color: var(--color-border);
    }

    .btn-add {
        height: 100%;
    }

    /* Estilos Modals */
    .modal-campana .modal-content {
        background-color: var(--color-bg-card);
        border: 1px solid var(--color-accent);
        color: var(--color-text-primary);
    }

    .modal-campana .btn-close {
        filter: invert(1);
        /* Keep provided logic or adapt to theme if needed */
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <div id="server-data" data-venta-guardada-id="{{ request.args.get('venta_guardada_id') or '' }}"
        data-url-ticket="{{ url_for('main.ver_ticket', venta_id=0) }}">
    </div>

    <form id="formVenta" method="POST" action="{{ url_for('main.nueva_venta') }}" onsubmit="return false;">

        <div class="venta-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0 text-primary-theme"><i class="fas fa-cash-register me-2"></i>Nueva Venta</h2>
                <div class="text-end">
                    <small class="text-muted d-block">Fecha de Emisi√≥n</small>
                    <span class="h5 text-primary-theme">{{ hoy }}</span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label text-warning">Tipo de Comprobante</label>
                    <select class="form-select form-select-lg" id="tipo_comprobante" name="tipo_comprobante">
                        <option value="Nota de Venta">Nota de Venta</option>
                        <option value="Boleta Electr√≥nica">Boleta Electr√≥nica</option>
                        <option value="Factura Electr√≥nica">Factura Electr√≥nica</option>
                    </select>
                </div>

                <div class="col-md-8 mb-3">
                    <label class="form-label text-warning">Cliente Atendido</label>
                    <div class="input-group">
                        <select class="form-select form-select-lg select2-cliente" id="cliente_id" name="cliente_id"
                            required>
                            <option value="">Buscar Cliente...</option>
                            {% for c in clientes %}
                            <option value="{{ c.id }}" data-documento="{{ c.numero_documento }}"
                                data-fecha="{{ c.fecha_nac_str or '' }}"
                                data-validado="{{ 'true' if c.cumpleanos_validado else 'false' }}"
                                data-rechazo="{{ 'true' if c.rechazo_dato_cumpleanos else 'false' }}"
                                data-saldo="{{ c.saldo_monedero or 0.00 }}">
                                {{ c.texto_busqueda }}
                            </option>
                            {% endfor %}
                        </select>
                        <a href="{{ url_for('main.nuevo_cliente') }}" class="btn btn-outline-secondary"
                            title="Nuevo Cliente"><i class="fas fa-plus"></i></a>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label text-warning">Colaborador</label>
                    <select class="form-select form-select-lg" name="empleado_id" id="empleado_id" required>
                        <option value="">Seleccione...</option>
                        {% for e in empleados %}
                        <option value="{{ e.id }}">
                            {{ e.nombre_display }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-warning">Campa√±a / Promoci√≥n</label>
                    <select class="form-select form-select-lg" name="campana_id">
                        <option value="">-- Ninguna --</option>
                        {% for camp in campanas %}
                        <option value="{{ camp.id }}">{{ camp.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Panel Puntos -->
            <div id="panel_puntos"
                class="alert alert-info py-2 d-none d-flex justify-content-between align-items-center mb-3"
                role="alert">
                <div>
                    <i class="fas fa-star text-warning me-2"></i>
                    <strong>Puntos: <span id="lbl_puntos_cliente">0</span></strong>
                    <small class="ms-2">(Valor: S/ <span id="lbl_valor_puntos">0.00</span>)</small>
                </div>
                <!-- NUEVO: Mostrar Monedero -->
                <div class="ms-3 text-end d-flex align-items-center">
                    <i class="fas fa-wallet text-success me-2"></i>
                    <strong class="me-2">Monedero: S/ <span id="lbl_monedero_cliente"
                            class="text-white">0.00</span></strong>
                    <button type="button" class="btn btn-sm btn-outline-warning fw-bold" onclick="usarMonedero()">
                        <i class="fas fa-coins me-1"></i> Usar Saldo
                    </button>
                </div>
                <button type="button" class="btn btn-sm btn-light text-info fw-bold ms-auto" onclick="canjearPuntos()">
                    <i class="fas fa-gift me-1"></i> Usar Puntos
                </button>
            </div>
            <input type="hidden" name="puntos_canjeados" id="input_puntos_canjeados" value="0">

            <div class="row">
                <div class="col-lg-8">
                    <div class="venta-section">
                        <h4 class="text-warning mb-3"><i class="fas fa-shopping-cart me-2"></i>√çtems</h4>

                        <div class="row mb-3 g-2">
                            <div class="col-md-8">
                                <select class="form-select" id="select_servicio">
                                    <option value="">-- Agregar Servicio --</option>
                                    {% for s in servicios %}
                                    <option value="{{ s.id }}" data-precio="{{ s.precio }}"
                                        data-nombre="{{ s.nombre }}">
                                        {{ s.nombre }} - S/ {{ "%.2f"|format(s.precio) }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div
                                class="col-md-2 d-flex align-items-center justify-content-center bg-dark rounded border border-secondary">
                                <div class="d-flex flex-column align-items-center w-100">
                                    <div class="form-check form-switch pt-1">
                                        <input class="form-check-input" type="checkbox" id="chk_es_extra"
                                            onchange="togglePorcentajeExtra()">
                                        <label class="form-check-label text-warning fw-bold small" for="chk_es_extra">Es
                                            Extra</label>
                                    </div>
                                    <input type="number" id="txt_porcentaje_extra"
                                        class="form-control form-control-sm text-center mt-1 bg-dark text-white border-warning"
                                        placeholder="%" style="display:none; width: 60px;" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-primary w-100" onclick="agregarItem('servicio')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="row mb-3 g-2">
                            <div class="col-md-10">
                                <select class="form-select" id="select_producto">
                                    <option value="">-- Agregar Producto --</option>
                                    {% for p in productos %}
                                    <option value="{{ p.id }}" data-precio="{{ p.precio_venta }}"
                                        data-nombre="{{ p.nombre }}" data-stock="{{ p.stock_actual }}">
                                        {{ p.nombre }} (Stock: {{ p.stock_actual }}) - S/ {{
                                        "%.2f"|format(p.precio_venta)
                                        }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-warning w-100" onclick="agregarItem('producto')">
                                    <i class="fas fa-box"></i>
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive mt-3">
                            <table class="table table-dark table-striped table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Descripci√≥n</th>
                                        <th width="100" class="text-center">Cant.</th>
                                        <th width="120" class="text-end">Precio</th>
                                        <th width="120" class="text-end">Total</th>
                                        <th width="50"></th>
                                    </tr>
                                </thead>
                                <tbody id="tabla_items_body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Block Removed -->

                <div class="col-lg-4">
                    <div class="venta-section">
                        <h4 class="text-warning mb-3"><i class="fas fa-coins me-2"></i>Pago</h4>

                        <div class="d-flex justify-content-between mb-2 text-white">
                            <span>Subtotal:</span>
                            <span id="lbl_subtotal">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 align-items-center text-white">
                            <span>Descuento:</span>
                            <input type="number" class="form-control form-control-sm w-50 text-end"
                                id="descuento_global" value="0" min="0" step="0.10" oninput="calcularTotales()">
                        </div>
                        <hr class="text-white">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="h4 text-white">TOTAL:</span>
                            <span class="total-display" id="lbl_total_pagar">S/ 0.00</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-info">Pagado:</span>
                            <span class="text-info fw-bold" id="lbl_total_pagado">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-white">Faltante:</span>
                            <span class="text-white fw-bold" id="lbl_faltante">S/ 0.00</span>
                        </div>

                        <div id="pagos_container"></div>

                        <button type="button" class="btn btn-outline-info btn-sm w-100 mt-2" onclick="agregarPago()">
                            <i class="fas fa-plus me-1"></i> A√±adir Pago
                        </button>

                        <div class="card bg-warning bg-opacity-10 border-warning mt-4 mb-2">
                            <div class="card-body py-2 px-2">
                                <h6 class="card-title text-warning mb-2 small fw-bold"><i
                                        class="fas fa-heart me-1"></i>Propina Voluntaria</h6>
                                <div class="row g-1">
                                    <div class="col-4">
                                        <input type="number" step="0.50" name="monto_propina" id="input_monto_propina"
                                            class="form-control form-control-sm bg-dark text-warning border-secondary fw-bold"
                                            placeholder="S/ 0.00">
                                    </div>
                                    <div class="col-4">
                                        <select name="empleado_propina_id" id="empleado_propina_id"
                                            class="form-select form-select-sm bg-dark text-white border-secondary"
                                            style="font-size: 0.8rem;">
                                            <option value="">¬øA qui√©n?</option>
                                            {% for e in empleados %}
                                            <option value="{{ e.id }}">{{ e.nombre_display }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select name="metodo_propina"
                                            class="form-select form-select-sm bg-dark text-white border-secondary"
                                            style="font-size: 0.8rem;">
                                            <option value="Efectivo">Efectivo</option>
                                            <option value="Yape">Yape</option>
                                            <option value="Plin">Plin</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-success btn-lg fw-bold" onclick="registrarVenta()">
                                <i class="fas fa-check-circle me-2"></i> CONFIRMAR VENTA
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" name="items_lista" id="items_lista_json">
            <input type="hidden" name="pagos_lista" id="pagos_lista_json">
            <!-- NUEVO: Campo para guardar la reserva vinculada al crear la venta -->
            <input type="hidden" name="reserva_id" id="reserva_id_form" value="">
    </form>
</div>

<template id="pago_template">
    <div class="pago-row input-group mb-2">
        <select class="form-select form-select-sm metodo-pago" onchange="calcularTotales()">
            <option value="Efectivo">Efectivo</option>
            <option value="Yape">Yape</option>
            <option value="Plin">Plin</option>
            <option value="Tarjeta">Tarjeta</option>
            <option value="Transferencia">Transferencia</option>
            <option value="Monedero">Monedero</option>
        </select>
        <input type="number" class="form-control form-control-sm monto-pago" placeholder="Monto" step="0.10" min="0"
            oninput="calcularTotales()">
        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarPago(this)"><i
                class="fas fa-trash"></i></button>
    </div>
</template>

<div class="modal fade modal-campana" id="modalCampanaDatos" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning"><i class="fas fa-birthday-cake me-2"></i>Actualizar Datos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <h5 id="lblNombreClienteCampana" class="mb-3 text-info"></h5>

                <div id="bloqueConfirmar" style="display:none;">
                    <p>Tenemos registrado su cumplea√±os:</p>
                    <h2 class="text-warning fw-bold mb-3" id="lblFechaActual"></h2>
                    <p>¬øEs correcta?</p>
                    <button class="btn btn-success me-2" onclick="responderCampana('confirmar')"><i
                            class="fas fa-check"></i> S√≠</button>
                    <button class="btn btn-outline-light" onclick="mostrarInputFecha()"><i class="fas fa-edit"></i> No,
                        corregir</button>
                </div>

                <div id="bloqueSolicitar" style="display:none;">
                    <p>¬°Queremos engre√≠rlo en su d√≠a!</p>
                    <p class="text-muted small">¬øNos podr√≠a brindar su fecha de cumplea√±os?</p>
                    <input type="date" id="inputFechaCampana" class="form-control w-75 mx-auto mb-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-info fw-bold" onclick="responderCampana('actualizar')">Guardar
                            Fecha</button>
                        <button class="btn btn-link text-muted" onclick="responderCampana('rechazar')">Prefiero no
                            decirlo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExitoVenta" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white shadow-lg border-success">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-success"><i class="fas fa-check-circle me-2"></i>Venta Registrada</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fs-5">¬øQu√© desea hacer ahora?</p>
                <div class="d-grid gap-2 col-8 mx-auto">
                    <a href="#" id="btnImprimirTicket" target="_blank" class="btn btn-warning fw-bold">
                        <i class="fas fa-print me-2"></i>Imprimir Ticket
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Nueva Venta</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // Variables Globales
    let listaItems = [];
    let clienteIdCampana = null;
    window.saldoMonederoActual = 0; // Global tracking for wallet balance

    // 1. Recibir datos del Backend (NUEVO)
    const datosPreCargados = JSON.parse('{{ prefill_data | tojson | safe if prefill_data else "null" }}');

    // --- INICIALIZACI√ìN ---
    $(document).ready(function () {
        // Select2 con tema Bootstrap 5
        $('.select2-cliente').select2({
            theme: 'bootstrap-5',
            placeholder: 'Buscar cliente...',
            width: '100%'
        });

        // üü¢ AUTOMATIZACI√ìN: Si hay datos pre-cargados (Desde Agenda)
        if (datosPreCargados) {
            console.log("Cargando datos de reserva:", datosPreCargados);

            // 0. Capturar ID Reserva (NUEVO)
            if (datosPreCargados.reserva_id) {
                document.getElementById('reserva_id_form').value = datosPreCargados.reserva_id;
            }

            // 1. Seleccionar Cliente
            if (datosPreCargados.cliente_id) {
                $('#cliente_id').val(datosPreCargados.cliente_id).trigger('change');
            }

            // 2. Seleccionar Colaborador
            if (datosPreCargados.empleado_id) {
                $('#empleado_id').val(datosPreCargados.empleado_id);
                // Tambi√©n sugerir al colaborador para la propina
                $('#empleado_propina_id').val(datosPreCargados.empleado_id);
            }

            // 3. Agregar Servicio a la Tabla
            if (datosPreCargados.item_inicial) {
                const item = datosPreCargados.item_inicial;
                // Simulamos el objeto que crea la funci√≥n 'agregarItem'
                const nuevoItem = {
                    id: item.id.toString(),
                    tipo: item.tipo, // 'servicio'
                    descripcion: item.nombre,
                    precio: parseFloat(item.precio),
                    stock: 0, // Servicios no tienen stock
                    cantidad: 1
                };
                listaItems.push(nuevoItem);
                renderTabla(); // Actualizar vista
            }
        }

        // DETECTOR DE CLIENTE (Campa√±a Cumplea√±os)
        $('.select2-cliente').on('select2:select', function (e) {
            const el = e.params.data.element;
            if (!el) return;

            const dataset = el.dataset;
            clienteIdCampana = el.value;
            const nombre = e.params.data.text.split('|')[0];

            // üü¢ Al seleccionar cliente, re-verificar fidelidad
            listaItems.forEach((it, idx) => {
                if (it.tipo === 'servicio') verificarFidelidadItem(idx);
            });
            checkClientPoints(clienteIdCampana);

            // üü¢ Mostrar Monedero
            const saldoMonedero = parseFloat(dataset.saldo || 0);
            window.saldoMonederoActual = saldoMonedero; // Update global
            document.getElementById('lbl_monedero_cliente').innerText = saldoMonedero.toFixed(2);

            // Forzar visualizaci√≥n del panel
            const panel = document.getElementById('panel_puntos');
            panel.classList.remove('d-none');
            panel.classList.add('d-flex');

            // Si ya valid√≥ o rechaz√≥, no mostramos el MODAL, pero la l√≥gica anterior YA CORRI√ì.
            if (dataset.validado === 'true' || dataset.rechazo === 'true') return;

            // Preparar Modal
            document.getElementById('lblNombreClienteCampana').innerText = nombre;

            if (dataset.fecha && dataset.fecha !== 'None' && dataset.fecha !== '') {
                // Modo Confirmar
                const [y, m, d] = dataset.fecha.split('-');
                document.getElementById('lblFechaActual').innerText = `${d}/${m}`;
                document.getElementById('inputFechaCampana').value = dataset.fecha;
                document.getElementById('bloqueConfirmar').style.display = 'block';
                document.getElementById('bloqueSolicitar').style.display = 'none';
            } else {
                // Modo Solicitar
                document.getElementById('inputFechaCampana').value = '';
                document.getElementById('bloqueConfirmar').style.display = 'none';
                document.getElementById('bloqueSolicitar').style.display = 'block';
            }

            const modal = new bootstrap.Modal(document.getElementById('modalCampanaDatos'));
            modal.show();
        });

        // VERIFICAR SI VENIMOS DE UNA VENTA EXITOSA
        const serverData = document.getElementById('server-data');
        const ventaId = serverData.dataset.ventaGuardadaId;

        if (ventaId) {
            const urlBase = serverData.dataset.urlTicket;
            document.getElementById('btnImprimirTicket').href = urlBase.replace('/0', '/' + ventaId);
            const modalExito = new bootstrap.Modal(document.getElementById('modalExitoVenta'));
            modalExito.show();
        }

        // Agregar una l√≠nea de pago por defecto si la lista est√° vac√≠a
        if (document.querySelectorAll('.pago-row').length === 0) {
            agregarPago();
        }
    });

    // --- FUNCIONES CAMPA√ëA ---
    function mostrarInputFecha() {
        document.getElementById('bloqueConfirmar').style.display = 'none';
        document.getElementById('bloqueSolicitar').style.display = 'block';
    }

    // --- SINCRONIZACI√ìN DE PROPINA ---
    const selEmpleado = document.getElementById('empleado_id');
    const selPropina = document.getElementById('empleado_propina_id');

    if (selEmpleado && selPropina) {
        selEmpleado.addEventListener('change', function () {
            selPropina.value = this.value; // Sincronizar valor
        });
    }

    async function responderCampana(accion) {
        const fecha = document.getElementById('inputFechaCampana').value;
        if (accion === 'actualizar' && !fecha) { alert('Ingrese fecha'); return; }

        try {
            const res = await fetch('/api/clientes/actualizar-campana', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cliente_id: clienteIdCampana, accion, fecha_nacimiento: fecha })
            });
            const data = await res.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalCampanaDatos')).hide();
                // Actualizar DOM para no volver a preguntar
                const opt = document.querySelector(`.select2-cliente option[value="${clienteIdCampana}"]`);
                if (opt) {
                    opt.dataset.validado = 'true';
                    if (accion === 'rechazar') opt.dataset.rechazo = 'true';
                }
                alert(data.message);
            }
        } catch (e) { console.error(e); alert('Error de conexi√≥n'); }
    }



    // --- NUEVO: FUNCIONES FIDELIDAD (LOYALTY) ---
    async function verificarFidelidadItem(idx) {
        // Necesitamos cliente Y servicio
        const clienteId = $('#cliente_id').val();
        if (!clienteId || !listaItems[idx] || listaItems[idx].tipo !== 'servicio') return;

        const servicioId = listaItems[idx].id;

        try {
            const res = await fetch(`/marketing/api/check-loyalty/${clienteId}/${servicioId}`);
            const data = await res.json();

            if (data.eligible) {
                listaItems[idx].loyalty_eligible = true;
                listaItems[idx].loyalty_pct = data.discount_pct;
                listaItems[idx].loyalty_rule_id = data.rule_id;
                listaItems[idx].loyalty_msg = data.message;

                // Notificar visualmente (opcional: Toast)
                // console.log("Fidelidad disponible:", data.message);
            } else {
                listaItems[idx].loyalty_eligible = false;
                listaItems[idx].loyalty_applied = false; // Reset si cambia cliente y ya no cumple
            }
            renderTabla();
        } catch (e) { console.error("Error check loyalty", e); }
    }

    function aplicarFidelidad(idx) {
        listaItems[idx].loyalty_applied = true;
        alert("‚úÖ " + listaItems[idx].loyalty_msg);
        renderTabla();
    }
    function togglePorcentajeExtra() {
        const chk = document.getElementById('chk_es_extra');
        const txt = document.getElementById('txt_porcentaje_extra');
        if (chk.checked) {
            txt.style.display = 'block';
            txt.focus();
        } else {
            txt.style.display = 'none';
            txt.value = '';
        }
    }

    function agregarItem(tipo) {
        const sel = document.getElementById(tipo === 'servicio' ? 'select_servicio' : 'select_producto');
        const id = sel.value;
        if (!id) return;

        const opt = sel.options[sel.selectedIndex];

        let esExtra = false;
        let pctExtra = 0;

        if (tipo === 'servicio') {
            const chk = document.getElementById('chk_es_extra');
            if (chk && chk.checked) {
                esExtra = true;
                const txt = document.getElementById('txt_porcentaje_extra');
                pctExtra = parseFloat(txt.value);
                if (isNaN(pctExtra) || pctExtra <= 0) {
                    alert("Si marca 'Es Extra', debe ingresar un porcentaje de comisi√≥n v√°lido.");
                    txt.focus();
                    return;
                }
            }
        }

        const item = {
            id, tipo,
            descripcion: opt.dataset.nombre,
            precio: parseFloat(opt.dataset.precio),
            stock: parseInt(opt.dataset.stock || 0),
            cantidad: 1,
            es_hora_extra: esExtra,
            porcentaje_servicio_extra: pctExtra
        };

        const existe = listaItems.find(i => i.id === id && i.tipo === tipo && i.es_hora_extra === esExtra && i.porcentaje_servicio_extra === pctExtra);

        if (existe) {
            if (tipo === 'producto' && existe.cantidad >= item.stock) { alert('Sin stock suficiente'); return; }
            existe.cantidad++;
        } else {
            if (tipo === 'producto' && item.stock < 1) { alert('Producto agotado'); return; }
            listaItems.push(item);
        }

        renderTabla();
        sel.value = '';

        // Reset checkbox
        document.getElementById('chk_es_extra').checked = false;
        togglePorcentajeExtra(); // Ocultar input

        // üü¢ Verificar Fidelidad del nuevo √≠tem
        verificarFidelidadItem(listaItems.length - 1);
    }

    function renderTabla() {
        const tbody = document.getElementById('tabla_items_body');
        tbody.innerHTML = '';
        listaItems.forEach((it, i) => {
            const total = it.cantidad * it.precio;
            let badgeExtra = '';
            if (it.es_hora_extra) {
                badgeExtra = `<span class="badge bg-warning text-dark ms-1" style="font-size:0.7em;">EXTRA ${it.porcentaje_servicio_extra}%</span>`;
            }

            let btnLoyalty = '';
            if (it.tipo === 'servicio') {
                // L√≥gica visual Fidelidad
                if (it.loyalty_applied) {
                    const pct = it.loyalty_pct || 0;
                    badgeExtra += ` <span class="badge bg-info text-dark ms-1">FIDELIDAD -${pct}%</span>`;
                } else if (it.loyalty_eligible) {
                    const pct = it.loyalty_pct || 0;
                    btnLoyalty = `<button class="btn btn-sm btn-outline-info ms-2" onclick="aplicarFidelidad(${i})"><i class="fas fa-gift me-1"></i>Aplicar -${pct}%</button>`;
                }
            }

            // Calcular Total Visual (Con Descuento Fidelidad)
            let rowTotal = total;
            if (it.loyalty_applied) {
                const desc = total * (it.loyalty_pct / 100);
                rowTotal = total - desc;
            }

            tbody.innerHTML += `
                <tr>
                    <td>${it.descripcion} ${badgeExtra} <small class='text-muted'>${it.tipo}</small> ${btnLoyalty}</td>
                <td><input type="number" class="form-control form-control-sm text-center" value="${it.cantidad}" min="1" onchange="updateCant(${i}, this.value)"></td>
                <td>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">S/</span>
                        <input type="number" class="form-control text-end" value="${it.precio.toFixed(2)}" step="0.50" min="0" onchange="updatePre(${i}, this.value)">
                    </div>
                </td>
                <td class="text-end">
                    ${it.loyalty_applied ? '<small class="text-decoration-line-through text-muted">S/ ' + total.toFixed(2) + '</small><br>' : ''}
                    <span class="${it.loyalty_applied ? 'text-info fw-bold' : ''}">S/ ${rowTotal.toFixed(2)}</span>
                </td>
                <td><button class="btn btn-sm btn-danger" onclick="delItem(${i})">X</button></td>
            </tr>
        `;
        });
        calcularTotales();
    }


    function updatePre(i, val) {
        let p = parseFloat(val);
        if (isNaN(p) || p < 0) p = 0;
        listaItems[i].precio = p;
        renderTabla();
    }
    function updateCant(i, val) {
        val = parseInt(val);
        if (val < 1) val = 1;
        if (listaItems[i].tipo === 'producto' && val > listaItems[i].stock) {
            alert('Stock m√°ximo: ' + listaItems[i].stock);
            val = listaItems[i].stock;
        }
        listaItems[i].cantidad = val;
        renderTabla();
    }

    function delItem(i) { listaItems.splice(i, 1); renderTabla(); }

    function agregarPago(metodo = null, monto = null) {
        const tpl = document.getElementById('pago_template');
        document.getElementById('pagos_container').appendChild(tpl.content.cloneNode(true));

        // Auto-select method/amount if provided
        const insertedRow = document.getElementById('pagos_container').lastElementChild;
        if (metodo && insertedRow) {
            const sel = insertedRow.querySelector('.metodo-pago');
            if (sel) sel.value = metodo;
        }
        if (monto !== null && insertedRow) {
            const inp = insertedRow.querySelector('.monto-pago');
            if (inp) inp.value = parseFloat(monto).toFixed(2);
        }

        calcularTotales();
    }

    function usarMonedero() {
        if (!window.saldoMonederoActual || window.saldoMonederoActual <= 0) {
            alert("El cliente no tiene saldo disponible en su monedero.");
            return;
        }

        // Calcular datos actuales
        const totalPagar = parseFloat(document.getElementById('lbl_total_pagar').innerText.replace('S/ ', '')) || 0;
        const lblFaltante = document.getElementById('lbl_faltante');
        let faltante = 0;

        if (lblFaltante) {
            const text = lblFaltante.innerText.replace('S/', '').replace('Vuelto:', '').trim();
            // Si dice Vuelto, faltante es 0 (o negativo para l√≥gica interna, pero aqu√≠ nos importa "pendiente")
            if (lblFaltante.innerText.includes('Vuelto')) {
                faltante = 0;
            } else {
                faltante = parseFloat(text) || 0;
            }
        }

        // CASO 1: Hay faltante positivo -> Comportamiento normal
        if (faltante > 0) {
            const montoAplicar = Math.min(window.saldoMonederoActual, faltante);
            agregarPago('Monedero', montoAplicar);
            return;
        }

        // CASO 2: Faltante es 0 (o hay vuelto), verificar si es por "Auto-relleno" de un solo pago
        // (El sistema pone "Efectivo" por el total autom√°ticamente).
        const filasPago = document.querySelectorAll('.pago-row');
        if (filasPago.length === 1) {
            const unicaFila = filasPago[0];
            const inpMonto = unicaFila.querySelector('.monto-pago');
            const montoFila = parseFloat(inpMonto.value) || 0;

            // Si el monto de esa √∫nica fila cubre todo el total (aprox), asumimos que es el default
            if (Math.abs(montoFila - totalPagar) < 0.1 && totalPagar > 0) {
                // Procedemos a "partir" ese pago
                const montoAplicar = Math.min(window.saldoMonederoActual, totalPagar);
                const nuevoMontoOriginal = totalPagar - montoAplicar;

                if (nuevoMontoOriginal > 0) {
                    inpMonto.value = nuevoMontoOriginal.toFixed(2);
                } else {
                    // Si el monedero cubre TODO, eliminamos la fila original (ej. Efectivo 0)
                    eliminarPago(unicaFila.querySelector('.btn-danger'));
                }

                agregarPago('Monedero', montoAplicar);
                return;
            }
        }

        // Si llega aqu√≠, es porque ya hay varios pagos o est√° todo pagado manualmente
        alert("No hay saldo pendiente por pagar.");
    }

    function eliminarPago(btn) { btn.closest('.pago-row').remove(); calcularTotales(); }

    function calcularTotales() {
        const sub = listaItems.reduce((acc, it) => {
            let rowT = it.cantidad * it.precio;
            // Restar si tiene fidelidad aplicada
            if (it.loyalty_applied) {
                rowT = rowT * (1 - (it.loyalty_pct / 100));
            }
            return acc + rowT;
        }, 0);
        const desc = parseFloat(document.getElementById('descuento_global').value) || 0;

        // Descuento por Puntos (25 pts = S/ 1.00)
        let ptsCanje = parseInt(document.getElementById('input_puntos_canjeados').value) || 0;
        let descPuntos = ptsCanje / 25;

        // Visualizaci√≥n valor puntos
        if (ptsCanje > 0) {
            document.getElementById('lbl_valor_puntos').innerText = descPuntos.toFixed(2) + " (Canje)";
            document.getElementById('lbl_valor_puntos').className = "text-success fw-bold";
        }

        const total = Math.max(0, sub - desc - descPuntos);

        document.getElementById('lbl_subtotal').innerText = 'S/ ' + sub.toFixed(2);
        document.getElementById('lbl_total_pagar').innerText = 'S/ ' + total.toFixed(2);

        let pagado = 0;
        document.querySelectorAll('.monto-pago').forEach(inp => pagado += parseFloat(inp.value) || 0);
        document.getElementById('lbl_total_pagado').innerText = 'S/ ' + pagado.toFixed(2);

        const faltante = total - pagado;
        const lblFalt = document.getElementById('lbl_faltante');

        if (Math.abs(faltante) <= 0.01) { // Exacto
            lblFalt.className = 'text-white fw-bold';
            lblFalt.innerText = 'S/ 0.00';
        } else if (faltante < 0) { // Vuelto
            lblFalt.className = 'text-success fw-bold';
            lblFalt.innerText = 'Vuelto: S/ ' + Math.abs(faltante).toFixed(2);
        } else { // Falta
            lblFalt.className = 'text-danger fw-bold';
            lblFalt.innerText = 'S/ ' + faltante.toFixed(2);
        }

        // Autocompletar primer pago si est√° vac√≠o y hay monto
        const primerPago = document.querySelector('.monto-pago');
        if (primerPago && (!primerPago.value || parseFloat(primerPago.value) === 0) && total > 0 && document.querySelectorAll('.monto-pago').length === 1) {
            primerPago.value = total.toFixed(2);
            // Recalcular visualmente sin llamar recursivamente
            document.getElementById('lbl_total_pagado').innerText = 'S/ ' + total.toFixed(2);
            lblFalt.className = 'text-white fw-bold';
            lblFalt.innerText = 'S/ 0.00';
        }
    }

    function registrarVenta() {
        if (listaItems.length === 0) { alert('Agregue √≠tems'); return; }

        const empleadoId = document.getElementById('empleado_id').value;
        if (!empleadoId) {
            alert('Por favor seleccione un Colaborador.');
            return;
        }

        // Validaciones RUC/DNI
        const tipo = document.getElementById('tipo_comprobante').value;

        // Obtener data del cliente seleccionado en Select2
        const dataCliente = $('.select2-cliente').select2('data')[0];
        const elCliente = dataCliente ? dataCliente.element : null;
        const doc = elCliente ? elCliente.dataset.documento : '';

        const total = parseFloat(document.getElementById('lbl_total_pagar').innerText.replace('S/ ', ''));

        if (tipo === 'Factura Electr√≥nica' && (!doc || doc.length !== 11)) {
            alert('Para Factura se requiere cliente con RUC (11 d√≠gitos).'); return;
        }
        if (tipo === 'Boleta Electr√≥nica' && total >= 700 && (!doc || doc.length !== 8)) {
            alert('Para boletas >= S/ 700 se requiere DNI.'); return;
        }

        // Validaci√≥n Propina
        const montoPropina = parseFloat(document.getElementById('input_monto_propina').value) || 0;
        const colabPropina = document.getElementById('empleado_propina_id').value;
        if (montoPropina > 0 && !colabPropina) {
            alert('Si ingresa una propina, debe seleccionar "¬øA qui√©n?".');
            document.getElementById('empleado_propina_id').focus();
            return;
        }

        // Preparar Pagos
        const pagos = [];
        document.querySelectorAll('.pago-row').forEach(row => {
            const m = parseFloat(row.querySelector('.monto-pago').value) || 0;
            if (m > 0) pagos.push({
                metodo: row.querySelector('.metodo-pago').value,
                monto: m
            });
        });

        if (pagos.length === 0 && total > 0) { alert('Ingrese el pago'); return; }

        // üü¢ VALIDACI√ìN DE MONTO EXACTO (NUEVO)
        const totalPagado = pagos.reduce((acc, p) => acc + p.monto, 0);
        const diferencia = Math.abs(total - totalPagado);

        if (diferencia > 0.10) { // Tolerancia de 10 c√©ntimos por redondeos
            Swal.fire({
                icon: 'error',
                title: 'Monto Incorrecto',
                text: `El monto pagado (S/ ${totalPagado.toFixed(2)}) no coincide con el total de la venta (S/ ${total.toFixed(2)}).`,
                footer: 'Por favor ajuste los pagos para cubrir exactamente el total.'
            });
            return;
        }

        document.getElementById('items_lista_json').value = JSON.stringify(listaItems);
        document.getElementById('pagos_lista_json').value = JSON.stringify(pagos);
        document.getElementById('formVenta').submit();
    }

    // --- FUNCIONES SISTEMA DE PUNTOS ---
    let puntosDisponibles = 0;

    async function checkClientPoints(id) {
        if (!id) {
            document.getElementById('panel_puntos').classList.remove('d-flex');
            document.getElementById('panel_puntos').classList.add('d-none');
            puntosDisponibles = 0;
            return;
        }
        try {
            const res = await fetch(`/marketing/api/client-status/${id}`);
            const data = await res.json();
            puntosDisponibles = data.puntos || 0;

            // Si la API devuelve el saldo monedero actualizado, lo usamos
            if (data.saldo_monedero !== undefined) {
                window.saldoMonederoActual = parseFloat(data.saldo_monedero);
                document.getElementById('lbl_monedero_cliente').innerText = window.saldoMonederoActual.toFixed(2);
            }

            document.getElementById('lbl_puntos_cliente').innerText = puntosDisponibles;
            const valorSoles = (puntosDisponibles / 25).toFixed(2);
            document.getElementById('lbl_valor_puntos').innerText = valorSoles;

            const panel = document.getElementById('panel_puntos');
            panel.classList.remove('d-none');
            panel.classList.add('d-flex');

            // Si cambio de cliente, reseteo el canje previo
            document.getElementById('input_puntos_canjeados').value = 0;
            // Reset visual style
            document.getElementById('lbl_valor_puntos').className = "";
            calcularTotales();

        } catch (e) { console.error("Error fetching points", e); }
    }

    function canjearPuntos() {
        if (puntosDisponibles < 25) {
            alert("M√≠nimo 25 puntos para canjear (S/ 1.00).");
            return;
        }

        const valorActual = parseInt(document.getElementById('input_puntos_canjeados').value) || 0;

        // Calcular M√°ximo Canjeable (Total Venta vs Puntos Disponibles)
        let totalVentaFull = parseFloat(document.getElementById('lbl_subtotal').innerText.replace('S/ ', '')) || 0;
        let descGlobal = parseFloat(document.getElementById('descuento_global').value) || 0;
        let saldoPagar = Math.max(0, totalVentaFull - descGlobal);
        let maxPuntosPorSaldo = Math.floor(saldoPagar * 25);

        let maxCanje = Math.min(puntosDisponibles, maxPuntosPorSaldo);

        let nuevoCanje = prompt(`¬øCu√°ntos PUNTOS desea canjear?\nDisponible: ${puntosDisponibles}\nMax para esta venta: ${maxCanje}\n(25 Puntos = S/ 1.00)`, valorActual || 25);
        if (nuevoCanje === null) return;

        nuevoCanje = parseInt(nuevoCanje);
        if (isNaN(nuevoCanje) || nuevoCanje < 0) nuevoCanje = 0;

        if (nuevoCanje > puntosDisponibles) {
            alert(`Solo tiene ${puntosDisponibles} puntos.`);
            nuevoCanje = puntosDisponibles;
        }

        document.getElementById('input_puntos_canjeados').value = nuevoCanje;
        calcularTotales();
    }
</script>
{% endblock %}