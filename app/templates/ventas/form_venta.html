{% extends "base.html" %}

{% block title %}Nueva Venta - JV Studio{% endblock %}

{% block head_extra %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .venta-header { background-color: var(--color-secundario); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .venta-section { background-color: #2c2c2c; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444; }
    .total-display { font-size: 2rem; font-weight: bold; color: var(--color-primario); text-align: right; }
    .balance-display { font-size: 1.2rem; text-align: right; }
    .table-items th { background-color: #444; color: #fff; }
    .btn-add { height: 100%; }
    .select2-container .select2-selection--single { height: 38px; }
    
    /* CORRECCI√ìN VISUAL PARA SELECT2 EN MODO OSCURO */
    .select2-container--default .select2-selection--single {
        background-color: #ffffff !important; 
        color: #000000 !important;          
        border: 1px solid #ced4da;
        height: 38px; 
        display: flex;
        align-items: center;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #000000 !important;
        line-height: 36px;
    }
    .select2-dropdown {
        background-color: #ffffff !important; 
        color: #000000 !important;          
        border: 1px solid #ced4da;
    }
    .select2-container--default .select2-results__option {
        color: #000000 !important; 
        background-color: #ffffff; 
    }
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: var(--color-primario) !important; 
        color: #000000 !important;
    }
    .select2-search__field {
        background-color: #ffffff !important;
        color: #000000 !important;
    }

    /* Estilos Modal Campa√±a */
    .modal-campana .modal-content {
        background-color: #2c2c2c;
        border: 1px solid var(--color-primario);
        color: #fff;
    }
    .modal-campana .btn-close { filter: invert(1); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <form id="formVenta" method="POST" action="{{ url_for('main.nueva_venta') }}" onsubmit="return false;">
        
        <div class="venta-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0"><i class="fas fa-cash-register me-2"></i>Nueva Venta</h2>
                <div class="text-end">
                    <small class="text-muted d-block">Fecha de Emisi√≥n</small>
                    <span class="h5 text-white">{{ hoy }}</span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="tipo_comprobante" class="form-label text-warning">Tipo de Comprobante</label>
                    <select class="form-select form-select-lg" id="tipo_comprobante" name="tipo_comprobante">
                        <option value="Nota de Venta">Nota de Venta</option>
                        <option value="Boleta Electr√≥nica">Boleta Electr√≥nica</option>
                        <option value="Factura Electr√≥nica">Factura Electr√≥nica</option>
                    </select>
                </div>

                <div class="col-md-8 mb-3">
                    <label for="cliente_id" class="form-label text-warning">Cliente Atendido</label>
                    <div class="input-group">
                        <select class="form-select form-select-lg select2-cliente" id="cliente_id" name="cliente_id" required>
                            <option value="">Buscar Cliente...</option>
                            {% for c in clientes %}
                            <option value="{{ c.id }}" 
                                    data-documento="{{ c.numero_documento }}"
                                    data-fecha="{{ c.fecha_nac_str or '' }}"
                                    data-validado="{{ 'true' if c.cumpleanos_validado else 'false' }}"
                                    data-rechazo="{{ 'true' if c.rechazo_dato_cumpleanos else 'false' }}">
                                {{ c.texto_busqueda }}
                            </option>
                            {% endfor %}
                        </select>
                        <a href="{{ url_for('main.nuevo_cliente') }}" class="btn btn-outline-secondary" title="Nuevo Cliente"><i class="fas fa-plus"></i></a>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="empleado_id" class="form-label text-warning">Colaborador Principal</label>
                    <select class="form-select form-select-lg" id="empleado_id" name="empleado_id" required>
                        <option value="">Seleccione Colaborador...</option>
                        {% for e in empleados %}
                        <option value="{{ e.id }}" {% if current_user.id == e.id %}selected{% endif %}>
                            {{ e.nombre_display }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                     <label for="campana_id" class="form-label text-warning">Campa√±a / Promoci√≥n</label>
                    <select class="form-select form-select-lg" name="campana_id">
                        <option value="">-- Sin Campa√±a / Promoci√≥n --</option>
                        {% for camp in campanas %}
                        <option value="{{ camp.id }}">{{ camp.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="venta-section">
                    <h4 class="text-warning mb-3"><i class="fas fa-shopping-cart me-2"></i>√çtems de la Venta</h4>
                    
                    <div class="row mb-3">
                        <div class="col-md-9">
                            <select class="form-select" id="select_servicio">
                                <option value="">Agregar Servicio...</option>
                                {% for s in servicios %}
                                <option value="{{ s.id }}" data-precio="{{ s.precio }}" data-nombre="{{ s.nombre }}">
                                    {{ s.nombre }} - S/ {{ "%.2f"|format(s.precio) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="col-md-3">
                            <button type="button" class="btn btn-primary w-100" onclick="agregarItem('servicio')">
                                <i class="fas fa-plus"></i> Servicio
                            </button>
                        </div>                        
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-9">
                             <select class="form-select" id="select_producto">
                                <option value="">Agregar Producto...</option>
                                {% for p in productos %}
                                <option value="{{ p.id }}" data-precio="{{ p.precio_venta }}" data-nombre="{{ p.nombre }}" data-stock="{{ p.stock_actual }}">
                                    {{ p.nombre }} (Stock: {{ p.stock_actual }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">                                                        
                            <button type="button" class="btn btn-primary w-100" onclick="agregarItem('producto')">
                                <i class="fas fa-plus"></i> Producto
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive mt-3">
                        <table class="table table-dark table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Descripci√≥n</th>
                                    <th width="100">Cant.</th>
                                    <th width="120">P. Unit</th>
                                    <th width="120">Total</th>
                                    <th width="50"></th>
                                </tr>
                            </thead>
                            <tbody id="tabla_items_body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="venta-section">
                    <h4 class="text-warning mb-3"><i class="fas fa-coins me-2"></i>Resumen y Pagos</h4>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="lbl_subtotal">S/ 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Descuento:</span>
                        <input type="number" class="form-control form-control-sm w-25 text-end bg-dark text-white" id="descuento_global" name="descuento_global" value="0" min="0" step="0.10" oninput="calcularTotales()">
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="h4">TOTAL:</span>
                        <span class="total-display" id="lbl_total_pagar">S/ 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="balance-display text-info">Pagado:</span>
                        <span class="balance-display text-info" id="lbl_total_pagado">S/ 0.00</span>
                    </div>
                     <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="balance-display fw-bold text-white">Faltante:</span>
                        <span class="balance-display fw-bold text-white" id="lbl_faltante">S/ 0.00</span>
                    </div>

                    <h5 class="text-warning mt-4">M√©todos de Pago</h5>
                    <div id="pagos_container">
                        </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="agregarPago()">
                        <i class="fas fa-plus me-1"></i>A√±adir M√©todo de Pago
                    </button>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-success btn-lg" onclick="registrarVenta()">
                            <i class="fas fa-check-circle me-2"></i>Registrar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" name="items_lista" id="items_lista_json">
        <input type="hidden" name="pagos_lista" id="pagos_lista_json">
    </form>
</div>

<template id="pago_template">
    <div class="pago-row input-group mb-2">
        <select class="form-select form-select-sm metodo-pago" onchange="calcularTotales()">
            <option value="Efectivo">Efectivo</option>
            <option value="Yape">Yape</option>
            <option value="Plin">Plin</option>
            <option value="Tarjeta">Tarjeta</option>
            <option value="Transferencia">Transferencia</option>
        </select>
        <input type="number" class="form-control form-control-sm monto-pago" placeholder="Monto" step="0.10" min="0" oninput="calcularTotales()">
        <input type="text" class="form-control form-control-sm referencia-pago" placeholder="Referencia (Opcional)">
        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarPago(this)"><i class="fas fa-trash"></i></button>
    </div>
</template>

<div class="modal fade" id="modalExitoVenta" tabindex="-1" aria-labelledby="modalExitoVentaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalExitoVentaLabel">‚úÖ Venta Registrada con √âxito</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¬øQu√© comprobante desea emitir?</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar / Solo Guardar</button>
                <a href="#" id="btnImprimirTicket" class="btn btn-info" target="_blank">üñ®Ô∏è Nota de Venta</a>
                <a href="#" id="btnEmitirComprobante" class="btn btn-success">üßæ Emitir Boleta/Factura</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-campana" id="modalCampanaDatos" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning">
                    <i class="fas fa-birthday-cake me-2"></i>Actualizaci√≥n de Datos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <h5 id="lblNombreClienteCampana" class="mb-3 fw-bold text-light"></h5>
                
                <div id="bloqueConfirmar" style="display:none;">
                    <p class="mb-2">Tenemos registrado su cumplea√±os el:</p>
                    <h2 class="text-info fw-bold mb-4" id="lblFechaActual"></h2>
                    <p>¬øEs correcta esta fecha?</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-success" onclick="responderCampana('confirmar')">
                            <i class="fas fa-check"></i> S√≠
                        </button>
                        <button class="btn btn-outline-warning" onclick="mostrarInputFecha()">
                            <i class="fas fa-edit"></i> No, corregir
                        </button>
                    </div>
                </div>

                <div id="bloqueSolicitar" style="display:none;">
                    <p class="mb-3">¬°Queremos engre√≠rlo en su d√≠a!</p>
                    <p class="text-muted small">¬øNos podr√≠a brindar su fecha de cumplea√±os?</p>
                    
                    <div class="mb-3 mt-3">
                        <input type="date" id="inputFechaCampana" class="form-control bg-secondary text-light border-info mx-auto" style="max-width: 200px;">
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-info fw-bold" onclick="responderCampana('actualizar')">
                            <i class="fas fa-save"></i> Guardar Fecha
                        </button>
                        <button class="btn btn-link text-muted text-decoration-none btn-sm mt-2" onclick="responderCampana('rechazar')">
                            El cliente prefiere no decirlo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    // Variables Globales
    let listaItems = [];
    let clienteIdCampana = null;

    $(document).ready(function() {
        // Inicializar Select2
        $('.select2-cliente').select2({
            placeholder: 'Buscar por nombre, DNI o tel√©fono...',
            width: '100%'
        });

        // -----------------------------------------------------
        // L√ìGICA DE CAMPA√ëA CUMPLEA√ëOS (Detectar cambio cliente)
        // -----------------------------------------------------
        $('.select2-cliente').on('select2:select', function(e) {
            // Acceder al elemento <option> real para leer atributos data-*
            var element = e.params.data.element;
            
            // Validar existencia de datos (importante si es placeholder)
            if (!element) return;

            var validado = element.dataset.validado === 'true';
            var rechazo = element.dataset.rechazo === 'true';
            var fecha = element.dataset.fecha;
            var nombre = e.params.data.text.split('|')[0]; // Limpiar nombre visual
            
            clienteIdCampana = element.value;

            // Si es un cliente v√°lido y no ha sido procesado aun
            if (clienteIdCampana && !validado && !rechazo) {
                // Configurar Modal
                document.getElementById('lblNombreClienteCampana').innerText = nombre;
                
                if (fecha && fecha !== 'None') {
                    // Modo Confirmar
                    document.getElementById('bloqueConfirmar').style.display = 'block';
                    document.getElementById('bloqueSolicitar').style.display = 'none';
                    
                    // Formatear visualmente
                    try {
                        const [y, m, d] = fecha.split('-');
                        document.getElementById('lblFechaActual').innerText = `${d}/${m}`;
                        document.getElementById('inputFechaCampana').value = fecha;
                    } catch(err) {
                        console.error("Error formateando fecha:", err);
                    }
                } else {
                    // Modo Solicitar
                    document.getElementById('bloqueConfirmar').style.display = 'none';
                    document.getElementById('bloqueSolicitar').style.display = 'block';
                    document.getElementById('inputFechaCampana').value = '';
                }

                // Mostrar Modal
                var myModal = new bootstrap.Modal(document.getElementById('modalCampanaDatos'));
                myModal.show();
            }
        });
    });

    // --- FUNCIONES CAMPA√ëA DATOS ---
    function mostrarInputFecha() {
        document.getElementById('bloqueConfirmar').style.display = 'none';
        document.getElementById('bloqueSolicitar').style.display = 'block';
    }

    async function responderCampana(accion) {
        const fecha = document.getElementById('inputFechaCampana').value;
        
        if (accion === 'actualizar' && !fecha) {
            alert("Ingrese una fecha v√°lida.");
            return;
        }

        try {
            const response = await fetch('/api/clientes/actualizar-campana', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    cliente_id: clienteIdCampana,
                    accion: accion,
                    fecha_nacimiento: fecha
                })
            });
            
            const res = await response.json();
            
            if (res.success) {
                // Cerrar modal
                const modalEl = document.getElementById('modalCampanaDatos');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                
                // Actualizar DOM del Select para que no vuelva a salir en esta sesi√≥n
                // Buscamos la opci√≥n por su value
                const option = document.querySelector(`.select2-cliente option[value="${clienteIdCampana}"]`);
                if(option) {
                    option.dataset.validado = 'true';
                    if(accion === 'rechazar') option.dataset.rechazo = 'true';
                    if(accion === 'actualizar') option.dataset.fecha = fecha;
                }
                
                // alert(res.message); // Opcional: Mostrar mensaje de √©xito
            } else {
                alert('Error: ' + res.message);
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexi√≥n.');
        }
    }

    // --- MANEJO DE ITEMS ---
    function agregarItem(tipo) {
        const select = document.getElementById(tipo === 'servicio' ? 'select_servicio' : 'select_producto');
        const id = select.value;
        if (!id) return;

        const option = select.options[select.selectedIndex];
        const nombre = option.getAttribute('data-nombre');
        const precio = parseFloat(option.getAttribute('data-precio'));
        const stock = tipo === 'producto' ? parseInt(option.getAttribute('data-stock')) : Infinity;

        const existente = listaItems.find(i => i.id === id && i.tipo === tipo);
        if (existente) {
            if (tipo === 'producto' && existente.cantidad + 1 > stock) {
                alert("No hay suficiente stock para a√±adir otra unidad.");
                return;
            }
            existente.cantidad++;
        } else {
            if (tipo === 'producto' && stock < 1) {
                alert("Producto sin stock.");
                return;
            }
            listaItems.push({ id, tipo, descripcion: nombre, precio, cantidad: 1, stock });
        }
        
        renderizarTabla();
        select.value = "";
    }

    function eliminarItem(index) {
        listaItems.splice(index, 1);
        renderizarTabla();
    }

    function actualizarCantidad(index, nuevaCant) {
        const item = listaItems[index];
        const cant = parseInt(nuevaCant);
        if (cant < 1) {
            this.value = 1;
            return;
        };

        if (item.tipo === 'producto' && cant > item.stock) {
            alert(`Stock m√°ximo es ${item.stock}.`);
            // Renderizar de nuevo para resetear el input
            renderizarTabla();
        } else {
            item.cantidad = cant;
            renderizarTabla();
        }
    }

    function renderizarTabla() {
        const tbody = document.getElementById('tabla_items_body');
        tbody.innerHTML = '';
        if (listaItems.length === 0) {
             tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">A√±ade servicios o productos a la venta.</td></tr>';
        } else {
            listaItems.forEach((item, index) => {
                const totalItem = item.cantidad * item.precio;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.descripcion} <small class="text-muted d-block">${item.tipo.toUpperCase()}</small></td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-center" 
                               value="${item.cantidad}" min="1" ${item.tipo === 'producto' ? `max="${item.stock}"` : ''}
                               onchange="actualizarCantidad(${index}, this.value)">
                    </td>
                    <td>S/ ${item.precio.toFixed(2)}</td>
                    <td>S/ ${totalItem.toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="eliminarItem(${index})"><i class="fas fa-times"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        calcularTotales();
    }

    // --- MANEJO DE PAGOS ---
    function agregarPago() {
        const template = document.getElementById('pago_template');
        const clone = template.content.cloneNode(true);
        document.getElementById('pagos_container').appendChild(clone);
        calcularTotales();
    }

    function eliminarPago(btn) {
        btn.closest('.pago-row').remove();
        calcularTotales();
    }

    // --- C√ÅLCULOS GENERALES ---
    function calcularTotales() {
        const subtotal = listaItems.reduce((sum, item) => sum + (item.cantidad * item.precio), 0);
        document.getElementById('lbl_subtotal').innerText = `S/ ${subtotal.toFixed(2)}`;
        
        const descuento = parseFloat(document.getElementById('descuento_global').value) || 0;
        const totalPagar = subtotal - descuento > 0 ? subtotal - descuento : 0;
        document.getElementById('lbl_total_pagar').innerText = `S/ ${totalPagar.toFixed(2)}`;

        let totalPagado = 0;
        document.querySelectorAll('.pago-row').forEach(row => {
            const monto = parseFloat(row.querySelector('.monto-pago').value) || 0;
            totalPagado += monto;
        });
        document.getElementById('lbl_total_pagado').innerText = `S/ ${totalPagado.toFixed(2)}`;

        const faltante = totalPagar - totalPagado;
        const lblFaltante = document.getElementById('lbl_faltante');
        
        if (faltante < -0.01) { // Vuelto (Negativo)
            lblFaltante.classList.remove('text-danger', 'text-white');
            lblFaltante.classList.add('text-success');
            lblFaltante.innerText = `S/ ${Math.abs(faltante).toFixed(2)} (Vuelto)`;
        } else if (faltante > 0.01) { // Falta pagar
             lblFaltante.classList.remove('text-success', 'text-white');
             lblFaltante.classList.add('text-danger');
             lblFaltante.innerText = `S/ ${faltante.toFixed(2)}`;
        } else { // Exacto
             lblFaltante.classList.remove('text-success', 'text-danger');
             lblFaltante.classList.add('text-white');
             lblFaltante.innerText = `S/ 0.00`;
        }
    }

    // --- ENV√çO DE FORMULARIO ---
    function registrarVenta() {
        if (listaItems.length === 0) {
            alert("Debe agregar al menos un √≠tem a la venta.");
            return;
        }

        const tipoComprobante = document.getElementById('tipo_comprobante').value;
        const clienteSelect = $('#cliente_id');
        // Select2 usa jQuery para obtener datos
        const clienteData = clienteSelect.select2('data')[0];
        
        if(!clienteData || !clienteData.element) {
             alert("Seleccione un cliente.");
             return;
        }

        const clienteDocumento = clienteData.element.dataset.documento;
        const totalPagar = parseFloat(document.getElementById('lbl_total_pagar').innerText.replace('S/ ', ''));

        if (tipoComprobante === 'Factura Electr√≥nica') {
            if (!clienteDocumento || clienteDocumento.length !== 11) {
                alert("Para Factura Electr√≥nica, el cliente debe tener un RUC de 11 d√≠gitos.");
                return;
            }
        }

        if (tipoComprobante === 'Boleta Electr√≥nica' && totalPagar > 700) {
            if (!clienteDocumento || clienteDocumento.length !== 8) {
                alert("Para Boletas mayores a S/ 700, el cliente debe tener un DNI de 8 d√≠gitos.");
                return;
            }
        }

        // Recolectar pagos
        const listaPagos = [];
        const pagoRows = document.querySelectorAll('#pagos_container .pago-row');
        pagoRows.forEach(row => {
            const metodo = row.querySelector('.metodo-pago').value;
            const monto = parseFloat(row.querySelector('.monto-pago').value) || 0;
            const referencia = row.querySelector('.referencia-pago').value;
            if (monto > 0) {
                listaPagos.push({ metodo: metodo, monto: monto, referencia: referencia });
            }
        });

        // Auto-pago efectivo si no hay pagos
        if (listaPagos.length === 0 && totalPagar > 0) {
            listaPagos.push({ metodo: 'Efectivo', monto: totalPagar, referencia: '' });
        }
        
        const totalPagado = listaPagos.reduce((sum, pago) => sum + pago.monto, 0);

        if (totalPagado < totalPagar - 0.01) {
            alert(`El monto pagado (S/ ${totalPagado.toFixed(2)}) es menor que el total (S/ ${totalPagar.toFixed(2)}).`);
            return;
        }

        document.getElementById('items_lista_json').value = JSON.stringify(listaItems);
        document.getElementById('pagos_lista_json').value = JSON.stringify(listaPagos);

        document.getElementById('formVenta').submit();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        renderizarTabla();
        agregarPago(); 

        {% if request.args.get('venta_guardada_id') %}
        const ventaGuardadaId = {{ request.args.get('venta_guardada_id')|tojson }};
        if (ventaGuardadaId) {
            const successModal = new bootstrap.Modal(document.getElementById('modalExitoVenta'));
            
            let urlTicketBase = "{{ url_for('main.ver_ticket', venta_id=0) }}";
            let urlTicket = urlTicketBase.replace('/0', '/' + ventaGuardadaId);
            document.getElementById('btnImprimirTicket').href = urlTicket;

            // Aqu√≠ podr√≠as agregar l√≥gica para Factura si tienes una ruta PDF diferente
            document.getElementById('btnEmitirComprobante').href = urlTicket; 
            
            successModal.show();
        }
        {% endif %}
    });
</script>
{% endblock %}