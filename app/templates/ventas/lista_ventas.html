{% extends "base.html" %}

{% block title %}{{ titulo_pagina | default('Historial de Ventas') }} - JV Studio{% endblock %}

{% block head_extra %}
<style>
    .estado-pagado {
        color: var(--bs-success-text-emphasis, #0f5132);
        background-color: var(--bs-success-bg-subtle, #d1e7dd);
    }

    .estado-pendiente {
        color: var(--bs-warning-text-emphasis, #664d03);
        background-color: var(--bs-warning-bg-subtle, #fff3cd);
    }

    .estado-anulado {
        color: var(--bs-danger-text-emphasis, #58151c);
        background-color: var(--bs-danger-bg-subtle, #f8d7da);
        text-decoration: line-through;
    }

    .estado-parcial {
        color: var(--bs-info-text-emphasis, #055160);
        background-color: var(--bs-info-bg-subtle, #cff4fc);
    }

    /* Botones pequeños en la tabla */
    .btn-xs {
        padding: 0.1rem 0.4rem;
        font-size: 0.8rem;
        line-height: 1.5;
        border-radius: 0.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: var(--color-acento-dorado);"><i class="fas fa-history me-2"></i>{{ titulo_pagina }}</h2>
        <a href="{{ url_for('main.nueva_venta') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Registrar Nueva Venta
        </a>
    </div>

    <!-- Filtros de Búsqueda -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-body p-3">
            <form method="GET" action="{{ url_for('main.listar_ventas') }}" class="row g-2 align-items-end">
                <div class="col-md-auto">
                    <label class="form-label small text-muted mb-1">Desde:</label>
                    <input type="date" name="fecha_inicio"
                        class="form-control form-control-sm bg-secondary text-light border-0"
                        value="{{ filtros.fecha_inicio }}">
                </div>
                <div class="col-md-auto">
                    <label class="form-label small text-muted mb-1">Hasta:</label>
                    <input type="date" name="fecha_fin"
                        class="form-control form-control-sm bg-secondary text-light border-0"
                        value="{{ filtros.fecha_fin }}">
                </div>
                <div class="col-md-auto">
                    <label class="form-label small text-muted mb-1">Estado Pago:</label>
                    <select name="estado_pago" class="form-select form-select-sm bg-secondary text-light border-0">
                        <option value="Todos">Todos</option>
                        <option value="Pagado" {% if filtros.estado_pago=='Pagado' %}selected{% endif %}>Pagado</option>
                        <option value="Pendiente" {% if filtros.estado_pago=='Pendiente' %}selected{% endif %}>Pendiente
                        </option>
                        <option value="Parcial" {% if filtros.estado_pago=='Parcial' %}selected{% endif %}>Parcial
                        </option>
                        <option value="Anulado" {% if filtros.estado_pago=='Anulado' %}selected{% endif %}>Anulado
                        </option>
                    </select>
                </div>
                <div class="col-md-auto">
                    <label class="form-label small text-muted mb-1">Comprobante:</label>
                    <select name="tipo_comprobante" class="form-select form-select-sm bg-secondary text-light border-0">
                        <option value="Todos">Todos</option>
                        <option value="Nota de Venta" {% if filtros.tipo_comprobante=='Nota de Venta' %}selected{% endif
                            %}>Nota de Venta</option>
                        <option value="Boleta Electrónica" {% if filtros.tipo_comprobante=='Boleta Electrónica'
                            %}selected{% endif %}>Boleta</option>
                        <option value="Factura Electrónica" {% if filtros.tipo_comprobante=='Factura Electrónica'
                            %}selected{% endif %}>Factura</option>
                    </select>
                </div>
                <div class="col-md-auto">
                    <label class="form-label small text-muted mb-1">Colaborador:</label>
                    <select name="empleado_id" class="form-select form-select-sm bg-secondary text-light border-0">
                        <option value="Todos">Todos</option>
                        {% for emp in empleados %}
                        <option value="{{ emp.id }}" {% if filtros.empleado_id|int==emp.id %}selected{% endif %}>
                            {{ emp.nombre_display }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-auto">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-sm btn-info text-white"><i
                                class="fas fa-filter me-1"></i>Filtrar</button>
                        <a href="{{ url_for('main.listar_ventas') }}" class="btn btn-sm btn-outline-secondary"
                            title="Limpiar Filtros"><i class="fas fa-undo"></i></a>

                        <!-- BOTÓN EXPORTAR EXCEL -->
                        <a href="{{ url_for('main.exportar_ventas_excel', **filtros) }}" class="btn btn-sm btn-success"
                            title="Exportar a Excel"><i class="fas fa-file-excel me-1"></i>Exportar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-custom table-sm align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Colaborador</th>
                    <th>Comprobante</th>
                    <th class="text-end">Monto Total</th>
                    <th class="text-center">Pago</th>
                    <th class="text-center">SUNAT</th>
                    <th class="text-center" style="min-width: 140px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for venta in ventas %}
                <tr>
                    <td>{{ venta.venta_id }}</td>
                    <td>{{ venta.fecha_venta.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>{{ venta.cliente_nombre }}</td>
                    <td>{{ venta.empleado_nombre }}</td>
                    <td>
                        <small class="text-muted d-block">{{ venta.tipo_comprobante }}</small>
                        {{ venta.serie_comprobante }}-{{ venta.numero_comprobante }}
                    </td>
                    <td class="text-end fw-bold">S/ {{ "%.2f"|format(venta.monto_final_venta) }}</td>

                    <td class="text-center">
                        <span
                            class="badge p-2 {% if venta.estado_pago == 'Pagado' %}bg-success{% elif venta.estado_pago == 'Anulado' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                            {{ venta.estado_pago }}
                        </span>
                    </td>

                    <td class="text-center">
                        {% if venta.tipo_comprobante == 'Nota de Venta' %}
                        <span class="badge bg-secondary">Interno</span>
                        {% else %}
                        {% if venta.estado_sunat == 'Aceptada' %}
                        <span class="badge bg-success" title="Aceptada por SUNAT"><i class="fas fa-check"></i> OK</span>
                        {% elif 'Rechazada' in (venta.estado_sunat or '') %}
                        <span class="badge bg-danger" title="{{ venta.mensaje_sunat }}"><i class="fas fa-times"></i>
                            Error</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Pendiente</span>
                        {% endif %}
                        {% endif %}
                    </td>

                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('main.ver_detalle_venta', venta_id=venta.venta_id) }}"
                                class="btn btn-xs btn-info text-white" title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </a>

                            {% if venta.tipo_comprobante == 'Nota de Venta' and venta.estado_pago != 'Anulado' %}
                            <a href="{{ url_for('main.vista_convertir_venta', venta_id=venta.venta_id) }}"
                                class="btn btn-xs btn-warning text-dark fw-bold" title="Canjear por Boleta/Factura">
                                <i class="fas fa-exchange-alt"></i>
                            </a>
                            {% endif %}

                            {% if venta.tipo_comprobante != 'Nota de Venta' and (not venta.estado_sunat or
                            venta.estado_sunat == 'Pendiente') %}
                            <form action="{{ url_for('main.enviar_sunat', venta_id=venta.venta_id) }}" method="POST"
                                class="d-inline" onsubmit="return confirm('¿Enviar a SUNAT?');">
                                <button type="submit" class="btn btn-xs btn-primary ms-1" title="Enviar ahora">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                            {% endif %}

                            {% if venta.tipo_comprobante == 'Nota de Venta' %}
                            <form action="{{ url_for('main.eliminar_venta_nota_venta', venta_id=venta.venta_id) }}"
                                method="POST" class="d-inline"
                                onsubmit="return confirm('¿Está seguro de eliminar esta Nota de Venta? Esta acción no se puede deshacer.');">
                                <button type="submit" class="btn btn-xs btn-danger ms-1" title="Eliminar Nota de Venta">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center text-muted fst-italic p-4">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No hay ventas registradas todavía.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}